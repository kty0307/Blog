{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c5322b81-49ef-40f5-989b-4dd4a6be6308",
   "metadata": {},
   "outputs": [],
   "source": [
    "import polars as pl\n",
    "import zipfile\n",
    "from pathlib import Path\n",
    "import os\n",
    "import duckdb\n",
    "import numpy as np"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c2aaaa15-a7b2-43e0-9462-acf4ea81013e",
   "metadata": {},
   "source": [
    "### Csv 파일 Parquet 변환"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 119,
   "id": "eb50c29f-450e-43cf-b114-c3cf7d3b2ca4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# parquet 파일 변환\n",
    "# zip_path = r\"D:\\SAS_DATA\\0_NICE\\0_Leakage\\PDR_8TH_251117\\0_Dat\\CSV_FILE\\oksb_chips_out_202501_202503.zip\"\n",
    "\n",
    "# schema_overrides= {\n",
    "#                     \"RCV_DT\": pl.Utf8,\n",
    "#                     \"RCV_PATH_CD\": pl.Utf8,\n",
    "#                     \"LON_RQUS_GDS_CD\": pl.Utf8,\n",
    "#                     \"LON_TP_DVCD\": pl.Utf8,\n",
    "#                     \"LON_DVCD\": pl.Utf8,\n",
    "#                     \"CNVS_LON_RSN_CD\": pl.Utf8,\n",
    "#                     \"PLAMT_YN\": pl.Utf8,\n",
    "#                     \"LON_USG_CD\": pl.Utf8,\n",
    "#                     \"ATMT_YN\": pl.Utf8,\n",
    "#                     \"RJCT_DT\": pl.Utf8,\n",
    "#                     \"RJCT_RSN_1_CD\": pl.Utf8,\n",
    "#                     \"RJCT_RSN_2_CD\": pl.Utf8,\n",
    "#                     \"LON_GDS_CD\": pl.Utf8,\n",
    "#                     \"RFND_METD_DVCD\": pl.Utf8,\n",
    "#                     \"LON_DT\": pl.Utf8,\n",
    "#                     \"LON_TR\": pl.Utf8,\n",
    "#                     \"AGRN_DY\": pl.Utf8,\n",
    "#                     \"EXPY_DT\": pl.Utf8,\n",
    "#                     \"FORG_OCPT_1_CD\": pl.Utf8,\n",
    "#                     \"FORG_OCPT_2_CD\": pl.Utf8,\n",
    "#                     \"ENTA_DT\": pl.Utf8,\n",
    "#                     \"EMPM_TPDV_CD\": pl.Utf8,\n",
    "#                     \"MONT_AMTOI\": pl.Utf8,\n",
    "#                     \"HS_TPDV_CD\": pl.Utf8,\n",
    "#                     \"HS_OWN_CD\": pl.Utf8,\n",
    "#                     \"VHCL_OWN_CD\": pl.Utf8,\n",
    "#                     \"STNR_DT\": pl.Utf8,\n",
    "#                     \"DNLS_BRNC_CD\": pl.Utf8,\n",
    "#                     \"ADTN_LON_DVCD\": pl.Utf8,\n",
    "#                     \"BS_DT\": pl.Utf8,\n",
    "#                     \"HNDLNG_BLCKNG_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"ASS_DTLS_MDL_ID\": pl.Utf8,\n",
    "#                     \"ASS_GRADE_CD\": pl.Utf8,\n",
    "#                     \"ASS_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"UNI_GRD_CD\": pl.Utf8,\n",
    "#                     \"MDL_APRVL_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"MIRT_LMT_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"HIRT_LMT_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"INRT_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"MIRT_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"HIRT_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"MIRT_ASS_LAST_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"HIRT_ASS_LAST_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"MIRT_US_LAST_APRVL_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"HIRT_US_LAST_APRVL_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_INRT_BASE_CD\": pl.Utf8,\n",
    "#                     \"SPRB_ASS_LAST_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"SPRB_US_LAST_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"SPRB_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"LN_APLCTN_PD_CD\": pl.Utf8,\n",
    "#                     \"LN_TP_DSCD\": pl.Utf8,\n",
    "#                     \"SUB_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"ML_ODR3_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"RELF_ML_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"INCOME_RCGNTN_ML_GRADE_VAL\": pl.Utf8,\n",
    "#                     \"HNDLNG_BLCKNG_RJCT_VAL\": pl.Utf8,\n",
    "#                     \"FILTER1_DSCD_VAL\": pl.Utf8,\n",
    "#                     \"FILTER1_RJCT_VAL\": pl.Utf8,\n",
    "#                     \"FILTER21_RJCT_VAL\": pl.Utf8,\n",
    "#                     \"CHNL_DVCD\": pl.Utf8,\n",
    "#                     \"FILTER_2ND_1_VAL\": pl.Utf8,\n",
    "#                     \"FILTER_2ND_2_VAL\": pl.Utf8,\n",
    "#                     \"FILTER_2ND_VAL\": pl.Utf8,\n",
    "#                     \"FILTER_2ND_1_RJCT_VAL\": pl.Utf8,\n",
    "#                     \"FILTER_2ND_2_RJCT_VAL\": pl.Utf8,\n",
    "#                     \"FILTER_3RD_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_APRVL_YN_VAL\": pl.Utf8,\n",
    "#                     \"RELF_APRVL_TRGP\": pl.Utf8,\n",
    "#                     \"RLEF_APRVL_YN\": pl.Utf8,\n",
    "#                     \"LMT_MLTP_PRF_YN\": pl.Utf8,\n",
    "#                     \"MIRT_LMT_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"HIRT_LMT_APRVL_VAL\": pl.Utf8,\n",
    "#                     \"ASS_INRT_ID\": pl.Utf8,\n",
    "#                     \"MIRT_SUB_GRD\": pl.Utf8,\n",
    "#                     \"HIRT_SUB_GRD\": pl.Utf8,\n",
    "#                     \"INRT_PRF_YN_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH1_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH2_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH3_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH4_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH5_VAL\": pl.Utf8,\n",
    "#                     \"STRTG_MTCH6_VAL\": pl.Utf8,\n",
    "#                     \"LN_DSCD\": pl.Utf8,\n",
    "#                     \"GNDR_DSCD\": pl.Utf8,\n",
    "#                     \"OCPT1_DSCD_VAL\": pl.Utf8,\n",
    "#                     \"OCPT2_DSCD_VAL\": pl.Utf8,\n",
    "#                     \"HOUSE_OWN_DSTNCTN_VAL\": pl.Utf8,\n",
    "#                     \"LN_PD_VAL\": pl.Utf8,\n",
    "#                     \"RCV_CHNL_CD_VAL\": pl.Utf8,\n",
    "#                     \"DSR_RE_LMT_AMT_CHNG_YN\": pl.Utf8,\n",
    "#                     \"EH0001903\": pl.Utf8,\n",
    "#                     \"EW0002906\": pl.Utf8,\n",
    "#                     \"EW0020901\": pl.Utf8    \n",
    "# }\n",
    "\n",
    "# batch_size = 1\n",
    "# temp_files = []\n",
    "# output_dir =r\"D:\\SAS_DATA\\0_NICE\\0_Leakage\\PDR_8TH_251117\\0_Dat\\CSV_FILE\"\n",
    "\n",
    "# with zipfile.ZipFile(zip_path,'r') as zip_ref:\n",
    "#     csv_files = [f for f in zip_ref.namelist() if f.endswith('.csv')]\n",
    "#     print(f\"총 파일수: {len(csv_files)}\\n\")\n",
    "\n",
    "#     for batch_num in range(0, len(csv_files), batch_size):\n",
    "#         batch = csv_files[batch_num:batch_num + batch_size]\n",
    "#         print(f\"\\n=== 배치 {batch_num//batch_size + 1}/{(len(csv_files)-1)//batch_size + 1} ===\")\n",
    "\n",
    "#         dfs = []\n",
    "#         for csv_file in batch:\n",
    "#             print(f\" 읽는 중: {csv_file}\")\n",
    "#             with zip_ref.open(csv_file) as f:\n",
    "#                 df = pl.read_csv(f, schema_overrides=schema_overrides, infer_schema_length=5000)\n",
    "#                 print(f\"     shape : {df.shape}\")\n",
    "#                 dfs.append(df)\n",
    "\n",
    "#         df_batch = pl.concat(dfs)\n",
    "#         print(f\" 배치 합산 shape: {df_batch.shape}\")\n",
    "\n",
    "#         temp_file = os.path.join(output_dir, f\"lkg_batch_250103_{batch_num//batch_size}.parquet\")\n",
    "#         df_batch.write_parquet(temp_file)\n",
    "#         temp_files.append(temp_file)\n",
    "#         print(f\"   저장 완료: {temp_file}\")\n",
    "\n",
    "#         del dfs, df_batch\n",
    "        \n",
    "# print(\"\\n 모든 작업 완료\")  "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "460bb4e8-57f5-474b-83ca-e279822fc0ad",
   "metadata": {},
   "source": [
    "### parquet 파일 인파일"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "4382a47a-2edf-4399-9bcc-f3b337aa980e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 정상적인 parquet 파일 인파일 하기 \n",
    "\n",
    "dataframes=[pl.scan_parquet(r\"D:\\20_CHiPS_DATA\\0_NICE\\0_Leakage\\2025\\PDR_8TH_251117\\0_Dat\\01_python_dat\\01_PFCT_ADD\\oksb_chips_PFCT결합_*.parquet\")]\n",
    "# dataframes=[pl.scan_parquet(r\"D:\\20_CHiPS_DATA\\0_NICE\\0_Leakage\\2025\\PDR_8TH_251117\\0_Dat\\01_python_dat\\01_PFCT_ADD\\oksb_chips_PFCT결합_202508.parquet\")]\n",
    "# df = pl.concat(dataframes).collect()\n",
    "df = pl.concat(dataframes)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "eb2af33e-207c-4e87-b5f0-054fb287459c",
   "metadata": {},
   "source": [
    "### Nice / PFCT 컬럼 명 Rename"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 121,
   "id": "d28ac7b4-6d83-464c-a660-041c8c851cb2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Col rename\n",
    "df = df.rename({\n",
    "    'SCR_ML1000_001_TOTAL': 'SCR_ML1000_001_TOT',\n",
    "    'GRD_ML1000_001_TOTAL': 'GRD_ML1000_001_TOT',\n",
    "    'SCR_PD2800_000_6M': 'SCR_PD2800_6M',\n",
    "    'SCR_PD2800_000_6M_UP': 'SCR_PD2800_6M_UP',\n",
    "    'SCR_PD2800_000_6M_DOWN': 'SCR_PD2800_6M_DOWN',\n",
    "    'SCR_PD2800_000_3Y': 'SCR_PD2800_3Y',\n",
    "    'SCR_PD2800_000_3Y_UP': 'SCR_PD2800_3Y_UP',\n",
    "    'SCR_PD2800_000_3Y_DOWN': 'SCR_PD2800_3Y_DOWN',\n",
    "    'SCR_PD2800_000_1Y': 'SCR_PD2800_1Y',\n",
    "    'GRD_PD2800_000': 'GRD_PD2800',\n",
    "    'SCR_PD2800_000_1Y_UP': 'SCR_PD2800_1Y_UP',\n",
    "    'SCR_PD2800_000_1Y_DOWN': 'SCR_PD2800_1Y_DOWN',    \n",
    "    'GRD_ML2000_000': 'Grd_ML2000_000_T',\n",
    "    'SCR_GM_CSS': 'SCR_CSS',\n",
    "    'GRD_GM_CSS': 'GRD_CSS',\n",
    "    'SCR_GM_REHAB': 'SCR_REHAB',\n",
    "    'GRD_GM_REHAB': 'GRD_REHAB',\n",
    "    'SCR_GM_FDLQ': 'SCR_FDLQ',\n",
    "    'GRD_GM_FDLQ': 'GRD_FDLQ',\n",
    "    'SCR_CM_boruwtqy': 'M_boruwtqy',\n",
    "    'GRD_CM_boruwtqy': 'GRD_boruwtqy',\n",
    "    'SCR_CM_luviwzaf': 'M_luviwzaf',\n",
    "    'GRD_CM_luviwzaf': 'GRD_luviwzaf',\n",
    "    'SCR_CM_qm9cmoed': 'M_qm9cmoed',\n",
    "    'GRD_CM_qm9cmoed': 'GRD_qm9cmoed',\n",
    "    'SCR_CM_6dx5p0pb': 'M_6dx5p0pb',\n",
    "    'GRD_CM_6dx5p0pb': 'GRD_6dx5p0pb',\n",
    "    'SCR_CM_arfajdh8': 'M_arfajdh8',\n",
    "    'GRD_CM_arfajdh8': 'GRD_arfajdh8',\n",
    "    'SCR_CM_0exc8ga5': 'M_0exc8ga5',\n",
    "    'GRD_CM_0exc8ga5': 'GRD_0exc8ga5',\n",
    "    'SCR_CM_7ijtqual': 'M_7ijtqual',\n",
    "    'GRD_CM_7ijtqual': 'GRD_7ijtqual'\n",
    "}).with_columns([\n",
    "    pl.col('SCR_ML2000_000').alias('Scr_ML2000_000_T')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0fca19fe-c45e-4230-99d1-12efef40775e",
   "metadata": {},
   "source": [
    "### SAS Macro Function 구현"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 122,
   "id": "d3dcdd57-d6d6-4ca8-8d94-6d23f89175dd",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ================================\n",
    "# 매크로 함수들을 Python 함수로 변환\n",
    "# ================================\n",
    "\n",
    "def grd_0_to_10(col_name):\n",
    "    \"\"\"GRD 값을 0~10 범위로 제한\"\"\"\n",
    "    return (\n",
    "        pl.when(pl.col(col_name) <= 0).then(10)\n",
    "        .when(pl.col(col_name) <= 10).then(pl.col(col_name))\n",
    "        .otherwise(10)\n",
    "        .alias(f'R1_{col_name}')\n",
    "    )\n",
    "\n",
    "def grd_0_to_15(col_name):\n",
    "    \"\"\"GRD 값을 0~15 범위로 제한\"\"\"\n",
    "    return (\n",
    "        pl.when(pl.col(col_name) <= 0).then(15)\n",
    "        .when(pl.col(col_name) <= 15).then(pl.col(col_name))\n",
    "        .otherwise(15)\n",
    "        .alias(f'R1_{col_name}')\n",
    "    )\n",
    "\n",
    "def grd_0_to_7(col_name):\n",
    "    \"\"\"GRD 값을 0~7 범위로 제한\"\"\"\n",
    "    return (\n",
    "        pl.when(pl.col(col_name) <= 0).then(7)\n",
    "        .when(pl.col(col_name) <= 7).then(pl.col(col_name))\n",
    "        .otherwise(7)\n",
    "        .alias(f'R1_{col_name}')\n",
    "    )\n",
    "\n",
    "def grd_0_to_6(col_name):\n",
    "    \"\"\"GRD 값을 0~6 범위로 제한\"\"\"\n",
    "    return (\n",
    "        pl.when(pl.col(col_name) <= 0).then(6)\n",
    "        .when(pl.col(col_name) <= 6).then(pl.col(col_name))\n",
    "        .otherwise(6)\n",
    "        .alias(f'R1_{col_name}')\n",
    "    )\n",
    "\n",
    "def grd_0_to_10_char(col_name):\n",
    "    return (\n",
    "        pl.when((pl.col(col_name).cast(pl.Int64)) <= 0 ).then(10)\n",
    "        .when((pl.col(col_name).cast(pl.Int64)) <= 10 ).then((pl.col(col_name).cast(pl.Int64)))\n",
    "        .otherwise(10).alias(f'RC1_{col_name}')\n",
    "    )\n",
    "\n",
    "\n",
    "def grd_0_to_9_char(col_name):\n",
    "    return (\n",
    "        pl.when((pl.col(col_name).cast(pl.Int64)) <= 0 ).then(9)\n",
    "        .when((pl.col(col_name).cast(pl.Int64)) <= 9 ).then((pl.col(col_name).cast(pl.Int64)))\n",
    "        .otherwise(9).alias(f'RC1_{col_name}')\n",
    "    )    \n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "672dfeb1-dd0d-412f-9175-09ae483cc867",
   "metadata": {},
   "source": [
    "### R_Clips 기준 변수 및 한도전략 "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 123,
   "id": "8efab524-1423-4865-afc4-06784ade570c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ==============================================================================\n",
    "# R_clips kcb 및 대안 등급 변환\n",
    "# ==============================================================================\n",
    "\n",
    "# 알파벳을 숫자로 매핑하는 딕셔너리\n",
    "char_to_num = {\n",
    "    'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5,\n",
    "    'F': 6, 'G': 7, 'H': 8, 'I': 9, 'J': 10,\n",
    "    'K': 11, 'L': 12, 'M': 13, 'N': 14, 'O': 15,\n",
    "    'P': 0, 'Z': 99\n",
    "}\n",
    "\n",
    "# STRTG_MTCH5_VAL의 각 위치별 문자를 등급으로 변환\n",
    "df = df.with_columns([\n",
    "    # 1번째 문자: R-Score 2.0 등급(TYPE2)\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(0, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S8R201000'),\n",
    "    # 2번째: R-Score(AutoML) 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(1, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S8RA01000'),\n",
    "    # 3번째: 서브프라임 V2.0스코어 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(2, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S90001000'),\n",
    "    # 4번째: 서브프라임 V2.0스코어 등급(특화)\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(3, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S91001000'),\n",
    "    # 5번째: 서브프라임 V3.0스코어 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(4, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S92101000'),\n",
    "    # 6번째: 서브프라임 V3.0스코어 등급(특화)\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(5, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('S92201000'),\n",
    "    # 7번째: 다중채무위험지수스코어 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(6, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SD0001000'),\n",
    "    # 8번째: I index 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(7, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SI0001000'),\n",
    "    # 9번째: PositiveScore등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(8, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SPP001000'),\n",
    "    # 10번째: SOHO ML 스코어 V1.0 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(9, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SS1001000'),\n",
    "    # 11번째: 비대면 연계대출 Score 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(10, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SUL001000'),\n",
    "    # 12번째: FraudScore V1.0 신용대출 등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(11, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('SF3001000'),\n",
    "    # 13번째: 소득추정모형3.0(추정연소득등급)\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(12, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('U42007030'),\n",
    "    # 14번째: RCips반영_PFCT_CSS등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(13, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('AIRPACK_CSS'),\n",
    "    # 16번째: RCips반영_PFCT_FDLQ등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(15, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('AIRPACK_FDLQ'),\n",
    "    # 17번째: RCips반영_PFCT_REHAB등급\n",
    "    pl.col('STRTG_MTCH5_VAL').str.slice(16, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('AIRPACK_REHAB'),\n",
    "    # 1번째: 네이버_일반_스코어\n",
    "    pl.col('STRTG_MTCH6_VAL').str.slice(0, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('GRD_NF1000_101'),\n",
    "    # 2번째: 네이버_THIN_스코어\n",
    "    pl.col('STRTG_MTCH6_VAL').str.slice(1, 1).replace_strict(char_to_num, default=None, return_dtype=pl.Int64).alias('GRD_NF1000_102')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 124,
   "id": "67c4ced8-4480-482e-bb64-6029c5384e3b",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 6. 한도 전략 여부 변환 (STRTG_MTCH4_VAL)\n",
    "# ================================\n",
    "\n",
    "# STRTG_MTCH4_VAL의 길이에 따라 다르게 처리\n",
    "# 길이 6: L01, L02, D03, D04, D05, D06\n",
    "# 길이 7: L01, L02, L03, D03, D04, D05, D06\n",
    "# 길이 8: L01, L02, L03, L04, D03, D04, D05, D06\n",
    "# 길이 9+: L01~L08, D03~D06\n",
    "\n",
    "# 각 위치의 값이 '1'이면 1, 아니면 0\n",
    "df = df.with_columns([\n",
    "    # 문자열 길이 계산\n",
    "    pl.col('STRTG_MTCH4_VAL').str.len_bytes().alias('STRTG_MTCH4_LEN')\n",
    "])\n",
    "\n",
    "# 조건부로 각 변수 생성\n",
    "df = df.with_columns([\n",
    "    # L01: 항상 첫 번째 위치\n",
    "    pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(0, 1) == '1').then(1).otherwise(0).alias('L01'),\n",
    "    \n",
    "    # L02: 항상 두 번째 위치\n",
    "    pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(1, 1) == '1').then(1).otherwise(0).alias('L02'),\n",
    "    \n",
    "    # L03: 길이 7 이상일 때 세 번째 위치\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') >= 7)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(2, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L03'),\n",
    "    \n",
    "    # L04: 길이 8 이상일 때 네 번째 위치\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') >= 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(3, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L04'),\n",
    "    \n",
    "    # D03: 길이에 따라 위치가 다름\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') == 6)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(2, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') == 7)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(3, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') >= 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(4, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('D03'),\n",
    "    \n",
    "    # D04: 길이에 따라 위치가 다름\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') == 6)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(3, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') == 7)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(4, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') >= 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(5, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('D04'),\n",
    "    \n",
    "    # D05: 길이에 따라 위치가 다름\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') == 6)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(4, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') == 7)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(5, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') >= 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(6, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('D05'),\n",
    "    \n",
    "    # D06: 길이에 따라 위치가 다름\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') == 6)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(5, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') == 7)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(6, 1) == '1').then(1).otherwise(0))\n",
    "      .when(pl.col('STRTG_MTCH4_LEN') >= 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(7, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('D06'),\n",
    "    \n",
    "    # L05~L08: 길이 9 이상일 때만\n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') > 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(8, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L05'),\n",
    "    \n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') > 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(9, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L06'),\n",
    "    \n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') > 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(10, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L07'),\n",
    "    \n",
    "    pl.when(pl.col('STRTG_MTCH4_LEN') > 8)\n",
    "      .then(pl.when(pl.col('STRTG_MTCH4_VAL').str.slice(11, 1) == '1').then(1).otherwise(0))\n",
    "      .otherwise(0).alias('L08')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0b7c573c-7e94-4bc3-9f0f-d25698f5abf8",
   "metadata": {},
   "source": [
    "### 복합항목 생성"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 125,
   "id": "98310c7b-021c-46dc-9bb2-27ab33ac84dc",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "df = df.with_columns([\n",
    "    # DSR000009: 소득대비부채(신용)비율_기업대출포함(비은행업권)\n",
    "    (\n",
    "    (pl.sum_horizontal([pl.col('LC0027202'),pl.col('LU0024202'),pl.col('KC1000034') * 1000])* 1000)/\n",
    "    (pl.max_horizontal([pl.col('IE0400007')*10000,pl.lit(10000000)]))*100\n",
    "    ).cast(pl.Int64).alias('DSR000009'),\n",
    "    \n",
    "    # RMIX00001: 소유주택수(위반건축물제외)\n",
    "    # RABAC0003이 1이면 -999, 아니면 RABAC0001 값\n",
    "    pl.when(pl.col('RABAC0003') == 1).then(-999)\n",
    "      .otherwise(pl.col('RABAC0001'))\n",
    "      .alias('RMIX00001')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 126,
   "id": "0db44b87-0fc6-47bd-b321-adaa33a5e40b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# A0210: SEG4/SEG5 급여 플랫폼 한도상향\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5']) &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5']) &\n",
    "        ~pl.col('RCV_CHNL_CD_VAL').is_in(['00301', '00336']) &\n",
    "        (pl.col('AGE_VAL') >= 30) &\n",
    "        (pl.col('AGE_VAL') < 60) &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & \n",
    "        (pl.col('SCR_ML2000_000_SB') > 595)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5']) &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5']) &\n",
    "        ~pl.col('RCV_CHNL_CD_VAL').is_in(['00301', '00336']) &\n",
    "        (pl.col('AGE_VAL') >= 30) &\n",
    "        (pl.col('AGE_VAL') < 60) &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') &\n",
    "        (pl.col('LS0000009') != -999) &\n",
    "        (pl.col('LS0000009') < 0)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5']) &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5']) &\n",
    "        ~pl.col('RCV_CHNL_CD_VAL').is_in(['00301', '00336']) &\n",
    "        (pl.col('AGE_VAL') >= 30) &\n",
    "        (pl.col('AGE_VAL') < 60) &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & \n",
    "        pl.col('GRD_ML2000_000_M').is_in([1, 2, 3])    \n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5']) &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5']) &\n",
    "        ~pl.col('RCV_CHNL_CD_VAL').is_in(['00301', '00336']) &\n",
    "        (pl.col('AGE_VAL') >= 30) &\n",
    "        (pl.col('AGE_VAL') < 60) &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & \n",
    "        pl.col('CF1200618').is_in([8, 9, 10, 11, 12])\n",
    "    ).then(pl.lit('00010')).otherwise(pl.lit('00020')).alias('A0210')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 127,
   "id": "ba281ce3-d92e-46cc-a766-00a96e1a69e1",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# A0120_추정소득대비_신용대출비율\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(0).alias('A0120')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('IE0400007') == 0).then(pl.lit(0))\n",
    "    .otherwise((((pl.col('LC0000202')*1000)/(pl.col('IE0400007')*10000)*100).floor())/100).alias('A0120')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 128,
   "id": "9184b7cb-0b81-4a34-8ae7-ad3261835b62",
   "metadata": {},
   "outputs": [],
   "source": [
    "# A0110: 급여 채무비 1이하 한도배수 0.1\n",
    "df = df.with_columns([\n",
    "    pl.lit('00020').alias('A0110')\n",
    "]).with_columns([    \n",
    "    pl.when(\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('IE0400007') > 0) & (pl.col('A0120') <= 1)\n",
    "    ).then(pl.lit('00010')).otherwise(pl.col('A0110')).alias('A0110')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 129,
   "id": "df6e7ed3-0f22-4bd8-9fff-4d2cf3b8333c",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# A0150: 기존대출 주택형태 우량 한도배수 0.1 상향\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit('00020').alias('A0150')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when(\n",
    "        (pl.col('LN_DSCD').is_in(['00002','00003','00004'])) & (pl.col('HS_TPDV_CD').is_in(['00001','00002'])) \n",
    "        & (pl.col('ASS_GRADE_VAL').is_in(['00001', '00002', '00003']))        \n",
    "    )\n",
    "    .then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('A0150')).alias('A0150')\n",
    "\n",
    "])    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 130,
   "id": "9f1ae67b-8d5d-42da-b807-53e847c09090",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# A0190: 신규 INDIR_추가우대대상\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit('00020').alias('A0190')\n",
    "]).with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('LN_DSCD') == '00001') &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        (pl.col('CHNL_DVCD') == '2') &\n",
    "        pl.col('OCPT1_DSCD_VAL').is_in(['A', 'B']) &\n",
    "        (pl.col('CF0600224') == 0) &\n",
    "        (pl.col('L00060001') == 0)\n",
    "    ).then(pl.lit('00010')).otherwise(pl.col('A0190')).alias('A0190')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 131,
   "id": "e7a072ee-4b04-4816-a07c-679d2b6533d9",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# A0200: 0.5_4\n",
    "df = df.with_columns([\n",
    "    pl.lit('00040').alias('A0200')\n",
    "]).with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('LN_DSCD').is_in(['00003', '00004'])) &\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG7') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        (pl.col('GRD_ML1300_500').is_in([1, 2, 3, 4])) &\n",
    "        (pl.col('SPP001000').is_in([1, 2, 3, 4, 5, 6]))\n",
    "    ).then(pl.lit('00010')).otherwise(pl.col('A0200')).alias('A0200')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 132,
   "id": "320956f3-c3f8-4079-ae09-6689cc07de92",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# T0090, T0100, T0140: 대출 합계\n",
    "df = df.with_columns([\n",
    "    # T0090\n",
    "    # (pl.col('LC0017101') + pl.col('LU0021101') + pl.col('LU0024101')).alias('T0090'),\n",
    "    pl.sum_horizontal([pl.col('LC0017101') ,pl.col('LU0021101'),pl.col('LU0024101')]).alias('T0090'),\n",
    "    # T0100\n",
    "    # (pl.col('L00080001') + pl.col('LU0024001')).alias('T0100'),\n",
    "    pl.sum_horizontal([pl.col('L00080001'),pl.col('LU0024001')]).alias('T0100'),\n",
    "    # T0140\n",
    "    # (pl.col('L00080001') + pl.col('L00140001') + pl.col('L00060001') + pl.col('LU0024001')).alias('T0140')\n",
    "    pl.sum_horizontal([pl.col('L00080001') , pl.col('L00140001') , pl.col('L00060001') , pl.col('LU0024001')]).alias('T0140')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 133,
   "id": "4ffd77c7-2aa9-42d0-8cee-5d209340dfa0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0160: 비율 계산\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('CF99002C9') <= 0) & (pl.col('CF0100233') > 0)).then(pl.lit(999999999))\n",
    "      .when((pl.col('CF99002C9') <= 0) & (pl.col('CF0100233') <= 0)).then(pl.lit(-999999999))\n",
    "      .when((pl.col('CF99002C9') > 0) & (pl.col('CF0100233') <= 0)).then(pl.lit(0))\n",
    "      .otherwise( ((pl.col('CF0100233')/pl.col('CF99002C9')*100).floor()))      \n",
    "      .alias('T0160')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 134,
   "id": "b8b453ff-ad97-4a8e-93aa-94e1e85332b0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0170: 최댓값\n",
    "df = df.with_columns([\n",
    "    pl.max_horizontal([pl.col('P13003400'), pl.col('DQ1252601'), pl.col('KC5000018'), pl.col('SD1200603')]).alias('T0170')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 135,
   "id": "688d1c50-07ee-4f85-a79e-eea703c8fd71",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0190: DSR 비율 (신용)\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when(pl.col('IE0400007') == 0).then(pl.lit(0))\n",
    "    .otherwise((((pl.col('LC0000202')*1000)/(pl.col('IE0400007')*10000)*100).floor())/100).alias('T0190'),\n",
    "\n",
    "    pl.when(pl.col('EVDN_INCOME_AMT') == 0).then(pl.lit(0))\n",
    "    .otherwise((((pl.col('LC0000202')*1000) / pl.col('EVDN_INCOME_AMT')*100).floor())/100).alias('T0180')                                                                                                \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 136,
   "id": "89ac816e-e2e0-475e-ade3-2a6a603207d1",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0330: 채널 DVCD가 1일 때 등급 체크\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit('00020').alias('T0330')\n",
    "\n",
    "]).with_columns([\n",
    "     pl.when(\n",
    "         (pl.col('CHNL_DVCD') == '1') & (pl.col('GRD_ML0700_000_s') == 1)\n",
    "     ).then(pl.lit('00010'))\n",
    "    .when(  \n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('GRD_ML0100_002') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('GRD_RK0600_700') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "       (pl.col('CHNL_DVCD') == '1') & (pl.col('S92201000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('SI0001000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('S8R201000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('SPP001000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('SS1001000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('GRD_ML0600_000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('CHNL_DVCD') == '1') & (pl.col('SUL001000') == 1)\n",
    "    ).then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('T0330')).alias('T0330')\n",
    "])\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 137,
   "id": "e3b14a8f-095a-4455-84ec-6ee86fbff40a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0480, T0490, T5000, T0481: 소득 기반 계산\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    #T0480\n",
    "    pl.when(pl.col('IE0400007') == 0).then(pl.lit(0))\n",
    "    .otherwise(((((((pl.col('IE0400007')*10000)*120)/100)-((pl.col('LC0000202')+pl.col('LU0024202'))*1000))/1000000).floor())*1000000).alias('T0480'),\n",
    "\n",
    "    #T0490\n",
    "    pl.when(pl.col('EVDN_INCOME_AMT') == 0 ).then(pl.lit(0))\n",
    "    .otherwise( ((((pl.col('EVDN_INCOME_AMT'))-((pl.col('LC0000202')+pl.col('LU0024202'))*1000))/1000000).floor())*1000000 ).alias('T0490'),\n",
    "\n",
    "    #T0500\n",
    "    pl.when(pl.col('ANL_TOT_AMTOI') == 0).then(pl.lit(0))\n",
    "    .otherwise( (((pl.col('ANL_TOT_AMTOI')-((pl.col('LC0000202')+pl.col('LU0024202'))*1000))/1000000).floor())*1000000 ).alias('T0500'),\n",
    "\n",
    "    #T0481\n",
    "    pl.when(pl.col('IE0400007') == 0).then(pl.lit(0))\n",
    "    .otherwise(pl.col('IE0400007')*10000).alias('T0481')  \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 138,
   "id": "a1e9d66b-d3e6-4230-8345-84f43e8a7ba2",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# T0350: 채널별 구분\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit('00010').alias('T0350')\n",
    "\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('RCV_CHNL_CD_VAL').is_in(['00238', '00016', '00370', '00371', '00387']))\n",
    "      .then(pl.lit('00020'))\n",
    "      .when(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00398','00399','00400','00401','00402']))\n",
    "      .then(pl.lit('00030'))\n",
    "      .when(pl.col('RCV_CHNL_CD_VAL').is_in(['00301','00268','00247']))\n",
    "      .then(pl.lit('00040'))\n",
    "      .when(pl.col('RCV_CHNL_CD_VAL').is_in(['00324','00349','00377','00004','00264','00273','00274','00275','00277','00288','00291',\n",
    "                                             '00300','00302','00307','00320','00306','00337','00331','00333','00361','00328','00360',\n",
    "                                             '00368','00338','00367','00369','00382','00383','00384','00334','00330','00336']))\n",
    "      .then(pl.lit('00050'))\n",
    "      .otherwise(pl.col('T0350'))\n",
    "      .alias('T0350')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 139,
   "id": "e27b3505-1d13-4d49-87de-32c842615e9d",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# T0530 변수 생성\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([   \n",
    "    pl.when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00010'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00011'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00012'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00013'))\n",
    "        \n",
    "    # SEG2 처리\n",
    "    .when((pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('LN_DSCD') == '00001')).then(pl.lit('00020'))\n",
    "        \n",
    "    # SEG3 처리\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00030'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00031'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00032'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00033'))\n",
    "        \n",
    "    # SEG4 처리\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00040'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00041'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00042'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00043'))\n",
    "        \n",
    "    # SEG5 처리\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00050'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00001') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00051'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "    ).then(pl.lit('00052'))\n",
    "    .when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') &\n",
    "        (pl.col('OCPT1_DSCD_VAL') != 'B') &\n",
    "        (pl.col('GNDR_DSCD') == '00003') & \n",
    "        (pl.col('LN_DSCD') == '00001')\n",
    "     ).then(pl.lit('00053'))\n",
    "     .otherwise(pl.lit('00090'))    \n",
    "    .alias('T0530')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "db4e66dd-6316-437a-af72-cce1b72ac50e",
   "metadata": {},
   "source": [
    "### 소득인정등급 Backscoring"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 140,
   "id": "2f4f7e87-c6b4-4503-890b-c350eb8e1d80",
   "metadata": {},
   "outputs": [],
   "source": [
    "#소득인정등급 추가 필요\n",
    "\n",
    "\n",
    "# LA1200106_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('LA1200106') <= 0).then(0)\n",
    "    .when(pl.col('LA1200106') < 3).then(1)\n",
    "    .otherwise(2)\n",
    "    .alias('LA1200106_R1')\n",
    "])\n",
    "\n",
    "# LA0300017_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('LA0300017') <= 0).then(0)\n",
    "    .when(pl.col('LA0300017') < 2).then(0)\n",
    "    .otherwise(1)\n",
    "    .alias('LA0300017_R1')\n",
    "])\n",
    "\n",
    "# KC0000001_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('KC0000001') <= 0).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('KC0000001_R1')\n",
    "])\n",
    "\n",
    "# CA0000008_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('CA0000008') < 5).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('CA0000008_R1')\n",
    "])\n",
    "\n",
    "# CA0300002_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('CA0300002') <= 0).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('CA0300002_R1')\n",
    "])\n",
    "\n",
    "# CF9900902_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('CF9900902') == -999).then(0)\n",
    "    .when(pl.col('CF9900902') < 30).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('CF9900902_R1')\n",
    "])\n",
    "\n",
    "# CL0000101_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('CL0000101') == 999999992).then(1)\n",
    "    .when(pl.col('CL0000101') < 2).then(0)\n",
    "    .otherwise(1)\n",
    "    .alias('CL0000101_R1')\n",
    "])\n",
    "\n",
    "# DSR000009_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('DSR000009') <= 0).then(0)\n",
    "    .when(pl.col('DSR000009') < 5).then(0)\n",
    "    .when(pl.col('DSR000009') < 116).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('DSR000009_R1')\n",
    "])\n",
    "\n",
    "# EH6001000_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('EH6001000') == 999999999).then(1)\n",
    "    .when(pl.col('EH6001000') < 2).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('EH6001000_R1')\n",
    "])\n",
    "\n",
    "# RMIX00001_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('RMIX00001') == -999).then(0)\n",
    "    .when(pl.col('RMIX00001') <= 0).then(0)\n",
    "    .otherwise(1)\n",
    "    .alias('RMIX00001_R1')\n",
    "])\n",
    "\n",
    "# Grd_ML1300_500_R1\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('GRD_ML1300_500') <= 0).then(0)\n",
    "    .when(pl.col('GRD_ML1300_500') < 3).then(2)\n",
    "    .when(pl.col('GRD_ML1300_500') < 6).then(1)\n",
    "    .otherwise(0)\n",
    "    .alias('GRD_ML1300_500_R1')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 141,
   "id": "949f6a54-84a7-462e-89ba-a77719eecf3e",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 소득인정 점수 계산\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(478).alias('I0'),\n",
    "    \n",
    "    pl.when(pl.col('LA1200106_R1') == 0).then(0)\n",
    "    .when(pl.col('LA1200106_R1') == 1).then(7)\n",
    "    .when(pl.col('LA1200106_R1') == 2).then(16)\n",
    "    .otherwise(0).alias('I1'),\n",
    "    \n",
    "    pl.when(pl.col('LA0300017_R1') == 0).then(0)\n",
    "    .when(pl.col('LA0300017_R1') == 1).then(17)\n",
    "    .otherwise(0).alias('I2'),\n",
    "    \n",
    "    pl.when(pl.col('KC0000001_R1') == 0).then(0)\n",
    "    .when(pl.col('KC0000001_R1') == 1).then(25)\n",
    "    .otherwise(0).alias('I3'),\n",
    "    \n",
    "    pl.when(pl.col('CA0000008_R1') == 0).then(0)\n",
    "    .when(pl.col('CA0000008_R1') == 1).then(7)\n",
    "    .otherwise(0).alias('I4'),\n",
    "    \n",
    "    pl.when(pl.col('CA0300002_R1') == 0).then(0)\n",
    "    .when(pl.col('CA0300002_R1') == 1).then(11)\n",
    "    .otherwise(0).alias('I5'),\n",
    "    \n",
    "    pl.when(pl.col('CF9900902_R1') == 0).then(0)\n",
    "    .when(pl.col('CF9900902_R1') == 1).then(6)\n",
    "    .otherwise(0).alias('I6'),\n",
    "    \n",
    "    pl.when(pl.col('CL0000101_R1') == 0).then(0)\n",
    "    .when(pl.col('CL0000101_R1') == 1).then(18)\n",
    "    .otherwise(0).alias('I7'),\n",
    "    \n",
    "    pl.when(pl.col('DSR000009_R1') == 0).then(0)\n",
    "    .when(pl.col('DSR000009_R1') == 1).then(5)\n",
    "    .otherwise(0).alias('I8'),\n",
    "    \n",
    "    pl.when(pl.col('EH6001000_R1') == 0).then(0)\n",
    "    .when(pl.col('EH6001000_R1') == 1).then(13)\n",
    "    .otherwise(0).alias('I9'),\n",
    "    \n",
    "    pl.when(pl.col('RMIX00001_R1') == 0).then(0)\n",
    "    .when(pl.col('RMIX00001_R1') == 1).then(15)\n",
    "    .otherwise(0).alias('I10'),\n",
    "    \n",
    "    pl.when(pl.col('GRD_ML1300_500_R1') == 0).then(0)\n",
    "    .when(pl.col('GRD_ML1300_500_R1') == 1).then(19)\n",
    "    .when(pl.col('GRD_ML1300_500_R1') == 2).then(45)\n",
    "    .otherwise(0).alias('I11')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 142,
   "id": "3d1b23c3-b22d-44ac-92ba-72454c3c77ac",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# SCR_INCOME_NEW 계산\n",
    "df = df.with_columns([\n",
    "    (pl.col('I0') + pl.col('I1') + pl.col('I2') + pl.col('I3') + \n",
    "     pl.col('I4') + pl.col('I5') + pl.col('I6') + pl.col('I7') + \n",
    "     pl.col('I8') + pl.col('I9') + pl.col('I10') + pl.col('I11'))\n",
    "    .alias('SCR_INCOME_NEW')\n",
    "])\n",
    "\n",
    "# GRD_INCOME_NEW 계산\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('SCR_INCOME_NEW') >= 590).then(1)\n",
    "    .when(pl.col('SCR_INCOME_NEW') >= 565).then(2)\n",
    "    .otherwise(3)\n",
    "    .alias('GRD_INCOME_NEW')\n",
    "])\n",
    "\n",
    "# Grd_PD0801_000 범위 제한\n",
    "df = df.with_columns([\n",
    "    grd_0_to_15('GRD_PD0801_000')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 143,
   "id": "005f66bc-f5e3-47fd-8d5d-6120f804744c",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# INCOME_RCGNTN_GRADE_VAL (소득인정등급) 생성\n",
    "# ================================\n",
    "\n",
    "INCOME_FIT = np.array([\n",
    "    [1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 5, 5, 6, 6, 6],\n",
    "    [1, 1, 2, 3, 3, 4, 4, 4, 5, 5, 6, 7, 7, 7, 8],\n",
    "    [1, 2, 2, 3, 3, 4, 4, 5, 6, 7, 8, 8, 9, 9, 9]\n",
    "])\n",
    "\n",
    "INCOME_FIT_LOOKUP = {}\n",
    "for i in range(3):\n",
    "    for j in range(15):\n",
    "        INCOME_FIT_LOOKUP[(i+1, j+1)] = int(INCOME_FIT[i, j])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.struct(['GRD_INCOME_NEW', 'R1_GRD_PD0801_000'])\n",
    "    .map_elements(\n",
    "        lambda x: INCOME_FIT_LOOKUP.get((int(x['GRD_INCOME_NEW']), int(x['R1_GRD_PD0801_000'])), None),\n",
    "        return_dtype=pl.Int64\n",
    "    ).map_elements(\n",
    "        lambda x : f'{x:05d}' if x is not None else None\n",
    "        ,return_dtype=pl.Utf8\n",
    "    )\n",
    "    .alias('INCOME_RCGNTN_GRADE_VAL')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 144,
   "id": "0e15f9ab-fe78-4760-9424-c395c2ffc10d",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# T0410: EW2401001 조건\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit('00020').alias('T0410')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001') == 999999999  ) ).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001') <= 1) ).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001')  == 2) \n",
    "           & (pl.col('INCOME_RCGNTN_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006']) )\n",
    "         ).then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('T0410')).alias('T0410')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "aa8a0702-ca47-4c55-a601-953455dbf3e0",
   "metadata": {},
   "source": [
    "### '25.11월 기준 금리 등급 Backscoring"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 145,
   "id": "b6332a8d-7f6e-47f9-9d12-7ff7814e5ee3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 금리 Backscoring '25.11월 기준\n",
    "# AS Package \n",
    "# 600_금리 Seg 산출\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.col('ASS_DTLS_MDL_ID').alias('IntScrId')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 146,
   "id": "8a7ae693-7645-4b07-8869-3bc2a0800f19",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# 610 고금리 sub등급 산출 \n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit(None).alias('IntSubGrdcd')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when(pl.col('IntScrId') == 'SEG1')\n",
    "        .then(\n",
    "            pl.when((pl.col('SCR_RK0600_000') >= 895) & (pl.col('SCR_RK0600_000') <= 9999 )).then(pl.lit('00001'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 860) & (pl.col('SCR_RK0600_000') <= 894)).then(pl.lit('00002'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 825) & (pl.col('SCR_RK0600_000') <= 859)).then(pl.lit('00003'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 795) & (pl.col('SCR_RK0600_000') <= 824)).then(pl.lit('00004'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 765) & (pl.col('SCR_RK0600_000') <= 794)).then(pl.lit('00005'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 740) & (pl.col('SCR_RK0600_000') <= 764)).then(pl.lit('00006'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 710) & (pl.col('SCR_RK0600_000') <= 739)).then(pl.lit('00007'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 660) & (pl.col('SCR_RK0600_000') <= 709)).then(pl.lit('00008'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 0) & (pl.col('SCR_RK0600_000') <= 659)).then(pl.lit('00009'))               \n",
    "            .otherwise(pl.col('IntSubGrdcd')))\n",
    "    .when(pl.col('IntScrId') == 'SEG2')\n",
    "        .then(\n",
    "            pl.when((pl.col('SCR_RK0600_000') >= 950) & (pl.col('SCR_RK0600_000') <= 9999)).then(pl.lit('00001'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 930) & (pl.col('SCR_RK0600_000') <= 949)).then(pl.lit('00002'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 920) & (pl.col('SCR_RK0600_000') <= 929)).then(pl.lit('00003'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 905) & (pl.col('SCR_RK0600_000') <= 919)).then(pl.lit('00004'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 885) & (pl.col('SCR_RK0600_000') <= 904)).then(pl.lit('00005'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 850) & (pl.col('SCR_RK0600_000') <= 884)).then(pl.lit('00006'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 820) & (pl.col('SCR_RK0600_000') <= 849)).then(pl.lit('00007'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 770) & (pl.col('SCR_RK0600_000') <= 819)).then(pl.lit('00008'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 0) & (pl.col('SCR_RK0600_000') <= 769)).then(pl.lit('00009'))               \n",
    "            .otherwise(pl.col('IntSubGrdcd')))\n",
    "    .when(pl.col('IntScrId').is_in(['SEG3','SEG6']))\n",
    "        .then(\n",
    "            pl.when((pl.col('SCR_RK0600_000') >= 800) & (pl.col('SCR_RK0600_000') <= 9999)).then(pl.lit('00001'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 775) & (pl.col('SCR_RK0600_000') <= 799)).then(pl.lit('00002'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 750) & (pl.col('SCR_RK0600_000') <= 774)).then(pl.lit('00003'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 735) & (pl.col('SCR_RK0600_000') <= 749)).then(pl.lit('00004'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 725) & (pl.col('SCR_RK0600_000') <= 734)).then(pl.lit('00005'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 705) & (pl.col('SCR_RK0600_000') <= 724)).then(pl.lit('00006'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 685) & (pl.col('SCR_RK0600_000') <= 704)).then(pl.lit('00007'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 650) & (pl.col('SCR_RK0600_000') <= 684)).then(pl.lit('00008'))\n",
    "            .when((pl.col('SCR_RK0600_000') >= 0) & (pl.col('SCR_RK0600_000') <= 649)).then(pl.lit('00009'))               \n",
    "            .otherwise(pl.col('IntSubGrdcd')))\n",
    "    .when(pl.col('IntScrId') == 'SEG4')\n",
    "        .then(\n",
    "            pl.when((pl.col('SCR_NK0300_000') >= 650) & (pl.col('SCR_NK0300_000') <= 9999)).then(pl.lit('00001'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 615) & (pl.col('SCR_NK0300_000') <= 649)).then(pl.lit('00002'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 595) & (pl.col('SCR_NK0300_000') <= 614)).then(pl.lit('00003'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 580) & (pl.col('SCR_NK0300_000') <= 594)).then(pl.lit('00004'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 565) & (pl.col('SCR_NK0300_000') <= 579)).then(pl.lit('00005'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 550) & (pl.col('SCR_NK0300_000') <= 564)).then(pl.lit('00006'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 535) & (pl.col('SCR_NK0300_000') <= 549)).then(pl.lit('00007'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 515) & (pl.col('SCR_NK0300_000') <= 534)).then(pl.lit('00008'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 0) & (pl.col('SCR_NK0300_000') <= 514)).then(pl.lit('00009'))               \n",
    "            .otherwise(pl.col('IntSubGrdcd')))\n",
    "    .when(pl.col('IntScrId').is_in(['SEG5','SEG7']))\n",
    "        .then(\n",
    "            pl.when((pl.col('SCR_NK0300_000') >= 580) & (pl.col('SCR_NK0300_000') <= 9999)).then(pl.lit('00001'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 560) & (pl.col('SCR_NK0300_000') <= 579)).then(pl.lit('00002'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 545) & (pl.col('SCR_NK0300_000') <= 559)).then(pl.lit('00003'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 535) & (pl.col('SCR_NK0300_000') <= 544)).then(pl.lit('00004'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 520) & (pl.col('SCR_NK0300_000') <= 534)).then(pl.lit('00005'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 505) & (pl.col('SCR_NK0300_000') <= 519)).then(pl.lit('00006'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 490) & (pl.col('SCR_NK0300_000') <= 504)).then(pl.lit('00007'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 465) & (pl.col('SCR_NK0300_000') <= 489)).then(pl.lit('00008'))\n",
    "            .when((pl.col('SCR_NK0300_000') >= 0) & (pl.col('SCR_NK0300_000') <= 464)).then(pl.lit('00009'))               \n",
    "            .otherwise(pl.col('IntSubGrdcd')))\n",
    "    .otherwise(pl.col('IntSubGrdcd')).alias('IntSubGrdcd')\n",
    "    \n",
    "]).with_columns([\n",
    "    pl.col('IntSubGrdcd').alias('NpIntSubGrdcd')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 147,
   "id": "0f17f5f4-f540-46cb-b120-0d98ea468c67",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# 금리 등급 Seg1 결합\n",
    "AsRtgCdH_seg1 = np.array([\n",
    "    [1,\t1, 1, 2, 2,\t2, 2, 3, 5],\n",
    "    [1,\t1, 1, 2, 3,\t3, 3, 3, 5],\n",
    "    [2,\t2, 2, 3, 3,\t4, 4, 4, 5],\n",
    "    [3,\t3, 3, 3, 4,\t4, 5, 5, 5],\n",
    "    [4,\t4, 4, 4, 4,\t4, 5, 5, 5],\n",
    "    [5,\t5, 5, 5, 5,\t5, 5, 5, 5],\n",
    "    [5,\t5, 5, 5, 5,\t5, 5, 5, 5],\n",
    "    [5,\t5, 5, 5, 5,\t5, 5, 5, 5],\n",
    "    [5,\t5, 5, 5, 5,\t5, 5, 5, 5],\n",
    "    [5,\t5, 5, 5, 5,\t5, 5, 5, 5]\n",
    "])\n",
    "\n",
    "AsRtgCdH_seg1_lookup={}\n",
    "for i in range(AsRtgCdH_seg1.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg1.shape[1]):\n",
    "        AsRtgCdH_seg1_lookup[(i+1,j+1)] = int(AsRtgCdH_seg1[i,j])\n",
    "        \n",
    "# 금리 등급 Seg2 결합\n",
    "AsRtgCdH_seg2 = np.array([\n",
    "    [1, 1, 1, 1, 1, 2, 2, 3, 5],\n",
    "    [2, 2, 2, 2, 2, 2, 2, 3, 5],\n",
    "    [2, 2, 2, 2, 2, 2, 3, 4, 5],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 4, 5],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 4, 5],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 5, 5],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 5, 5],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 5, 5],\n",
    "    [5, 5, 5, 5, 5, 5, 5, 5, 5],\n",
    "    [5, 5, 5, 5, 5, 5, 5, 5, 5]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg2_lookup={}\n",
    "for i in range(AsRtgCdH_seg2.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg2.shape[1]):\n",
    "        AsRtgCdH_seg2_lookup[(i+1,j+1)] = int(AsRtgCdH_seg2[i,j])\n",
    "\n",
    "\n",
    "# 금리 등급 Seg3 결합\n",
    "AsRtgCdH_seg3 = np.array([\n",
    "    [1, 1, 1, 1, 1, 1, 1, 1, 2],\n",
    "    [1, 1, 1, 1, 1, 1, 2, 2, 2],\n",
    "    [2, 2, 2, 2, 2, 2, 2, 2, 2],\n",
    "    [2, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg3_lookup={}\n",
    "for i in range(AsRtgCdH_seg3.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg3.shape[1]):\n",
    "        AsRtgCdH_seg3_lookup[(i+1,j+1)] = int(AsRtgCdH_seg3[i,j])\n",
    "\n",
    "\n",
    "\n",
    "# 금리 등급 Seg4 결합\n",
    "AsRtgCdH_seg4 = np.array([\n",
    "    [1, 2, 3, 3, 3, 4, 4, 5, 6],\n",
    "    [1, 2, 3, 3, 3, 4, 4, 5, 6],\n",
    "    [1, 2, 3, 3, 3, 4, 4, 5, 6],\n",
    "    [1, 2, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [1, 2, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [2, 3, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [2, 3, 3, 3, 4, 4, 5, 5, 6],\n",
    "    [2, 3, 3, 3, 4, 4, 5, 5, 6],\n",
    "    [2, 3, 3, 3, 4, 4, 5, 6, 6],\n",
    "    [3, 3, 3, 3, 4, 5, 6, 6, 6]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg4_lookup={}\n",
    "for i in range(AsRtgCdH_seg4.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg4.shape[1]):\n",
    "        AsRtgCdH_seg4_lookup[(i+1,j+1)] = int(AsRtgCdH_seg4[i,j])        \n",
    "\n",
    "\n",
    "\n",
    "# 금리 등급 Seg5 결합\n",
    "AsRtgCdH_seg5 = np.array([\n",
    "    [1, 1, 2, 2, 3, 3, 4, 4, 5],\n",
    "    [1, 2, 2, 3, 3, 4, 4, 4, 5],\n",
    "    [2, 2, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [2, 2, 3, 4, 4, 5, 5, 6, 6],\n",
    "    [3, 3, 4, 4, 5, 5, 6, 6, 6],\n",
    "    [4, 4, 4, 5, 6, 6, 6, 6, 6],\n",
    "    [5, 5, 5, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg5_lookup={}\n",
    "for i in range(AsRtgCdH_seg5.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg5.shape[1]):\n",
    "        AsRtgCdH_seg5_lookup[(i+1,j+1)] = int(AsRtgCdH_seg5[i,j])\n",
    "\n",
    "\n",
    "# 금리 등급 Seg6 결합\n",
    "AsRtgCdH_seg6 = np.array([\n",
    "    [1, 1, 1, 1, 1, 1, 1, 1, 2],\n",
    "    [1, 1, 1, 1, 1, 1, 2, 2, 2],\n",
    "    [2, 2, 2, 2, 2, 2, 2, 2, 2],\n",
    "    [2, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4],\n",
    "    [4, 4, 4, 4, 4, 4, 4, 4, 4]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg6_lookup={}\n",
    "for i in range(AsRtgCdH_seg6.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg6.shape[1]):\n",
    "        AsRtgCdH_seg6_lookup[(i+1,j+1)] = int(AsRtgCdH_seg6[i,j])\n",
    "\t\t\n",
    "        \n",
    "\n",
    "# 금리 등급 Seg7 결합\n",
    "AsRtgCdH_seg7 = np.array([\n",
    "    [1, 1, 2, 2, 3, 3, 4, 4, 5],\n",
    "    [1, 2, 2, 3, 3, 4, 4, 4, 5],\n",
    "    [2, 2, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [2, 2, 3, 4, 4, 5, 5, 6, 6],\n",
    "    [3, 3, 4, 4, 5, 5, 6, 6, 6],\n",
    "    [4, 4, 4, 5, 6, 6, 6, 6, 6],\n",
    "    [5, 5, 5, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 6, 6]    \n",
    "])\n",
    "\n",
    "AsRtgCdH_seg7_lookup={}\n",
    "for i in range(AsRtgCdH_seg7.shape[0]):\n",
    "    for j in range(AsRtgCdH_seg7.shape[1]):\n",
    "        AsRtgCdH_seg7_lookup[(i+1,j+1)] = int(AsRtgCdH_seg7[i,j])        "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 148,
   "id": "ec9af2c7-59a0-4093-bfdb-ce5ee7f8364d",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = df.with_columns([\n",
    "\n",
    "    grd_0_to_10_char('ASS_GRADE_VAL'),\n",
    "    grd_0_to_10_char('IntSubGrdcd')   \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 149,
   "id": "3924cd65-cd6c-4feb-a2bd-f13a017ce6bd",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = df.with_columns([\n",
    "\n",
    "    pl.when(pl.col('IntScrId') == 'SEG1')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg1_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG2')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg2_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG3')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg3_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG4')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg4_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG5')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg5_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG6')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg6_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .when(pl.col('IntScrId') == 'SEG7')\n",
    "        .then(pl.struct(['RC1_ASS_GRADE_VAL','RC1_IntSubGrdcd'])\n",
    "              .map_elements(\n",
    "                  lambda x: AsRtgCdH_seg7_lookup.get((int(x['RC1_ASS_GRADE_VAL']),int(x['RC1_IntSubGrdcd'])),None),return_dtype=pl.Int64))\n",
    "    .otherwise(pl.lit(None))\n",
    "    .map_elements(lambda x : f'{x:05d}' if x is not None else None,return_dtype=pl.Utf8)        \n",
    "     .alias('AsRtgCdH')\n",
    "\n",
    "]).with_columns([\n",
    "    pl.col('AsRtgCdH').alias('AsRtgCdM')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "771b1f47-3ae0-42ee-a58c-02cc16282d50",
   "metadata": {},
   "source": [
    "### '25.11이전 기준 금리경쟁 등급 Backscoring"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 150,
   "id": "4c19dc72-fe40-4d99-9a5d-7f26eaf7f59b",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# =============================================\n",
    "# 금리경쟁 등급(SHADOW_GRD) 생성('25.11전 버전)\n",
    "# =============================================\n",
    "\n",
    "# SEG4용 매트릭스 정의\n",
    "GRD_TMP4_1 = np.array([\n",
    "    [1, 1, 1, 2, 2, 3, 4, 5],\n",
    "    [1, 1, 2, 2, 2, 3, 4, 5],\n",
    "    [2, 2, 2, 3, 3, 3, 4, 5],\n",
    "    [2, 2, 2, 3, 4, 4, 4, 5],\n",
    "    [3, 3, 3, 3, 4, 4, 4, 5],\n",
    "    [4, 4, 4, 4, 4, 4, 5, 5],\n",
    "    [5, 5, 5, 5, 5, 5, 5, 6],\n",
    "    [5, 5, 5, 6, 6, 6, 6, 7],\n",
    "    [7, 7, 7, 7, 7, 7, 7, 7]\n",
    "])\n",
    "\n",
    "GRD_TMP4_2 = np.array([\n",
    "    [1, 1, 1, 2, 3, 3, 4, 5],\n",
    "    [1, 1, 2, 2, 3, 3, 4, 5],\n",
    "    [1, 1, 2, 2, 3, 4, 5, 6],\n",
    "    [2, 2, 3, 3, 3, 4, 5, 6],\n",
    "    [3, 3, 3, 4, 4, 5, 5, 6],\n",
    "    [4, 4, 4, 4, 4, 5, 6, 6],\n",
    "    [5, 5, 5, 5, 5, 5, 6, 6],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 7],\n",
    "    [7, 7, 7, 7, 7, 7, 7, 7]\n",
    "])\n",
    "\n",
    "GRD_TMP4_3 = np.array([\n",
    "    [1, 1, 2, 2, 4, 5, 6, 7],\n",
    "    [1, 1, 2, 3, 4, 5, 6, 7],\n",
    "    [2, 2, 2, 3, 4, 5, 6, 7],\n",
    "    [3, 3, 3, 3, 4, 5, 6, 7],\n",
    "    [3, 3, 4, 4, 5, 5, 6, 7],\n",
    "    [4, 4, 4, 5, 5, 6, 6, 7],\n",
    "    [5, 5, 5, 6, 6, 6, 6, 7],\n",
    "    [6, 6, 6, 6, 6, 6, 6, 7],\n",
    "    [6, 6, 7, 7, 7, 7, 7, 7]\n",
    "])\n",
    "\n",
    "# SEG5용 매트릭스 정의\n",
    "GRD_TMP5 = np.array([\n",
    "    [1, 1, 2, 2, 2, 3, 4, 2],\n",
    "    [1, 1, 2, 2, 2, 3, 4, 5],\n",
    "    [2, 2, 2, 3, 3, 4, 5, 6],\n",
    "    [3, 3, 3, 3, 4, 4, 5, 6],\n",
    "    [3, 3, 3, 4, 4, 4, 5, 6],\n",
    "    [4, 4, 4, 4, 5, 5, 5, 6],\n",
    "    [5, 5, 5, 5, 5, 6, 6, 7],\n",
    "    [6, 6, 6, 6, 6, 7, 7, 7],\n",
    "    [7, 7, 7, 7, 7, 7, 7, 7]\n",
    "])\n",
    "\n",
    "# 매트릭스를 1차원으로 변환하여 lookup용 딕셔너리 생성\n",
    "def create_lookup_dict(matrix):\n",
    "    \"\"\"2D 매트릭스를 (row, col) -> value 딕셔너리로 변환\"\"\"\n",
    "    lookup = {}\n",
    "    for i in range(matrix.shape[0]):\n",
    "        for j in range(matrix.shape[1]):\n",
    "            lookup[(i+1, j+1)] = int(matrix[i, j])\n",
    "    return lookup\n",
    "\n",
    "GRD_LOOKUP_4_1 = create_lookup_dict(GRD_TMP4_1)\n",
    "GRD_LOOKUP_4_2 = create_lookup_dict(GRD_TMP4_2)\n",
    "GRD_LOOKUP_4_3 = create_lookup_dict(GRD_TMP4_3)\n",
    "GRD_LOOKUP_5 = create_lookup_dict(GRD_TMP5)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 151,
   "id": "8876afdd-6954-4e71-a26a-a06d81af92e5",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# SHADOW_SUB_GRD1 생성\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    # SEG1\n",
    "    pl.when(pl.col('ASS_INRT_ID') == 'SEG1').then(\n",
    "        pl.when(pl.col('GRD_ML2000_000_SB') <= 4).then(1)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 5).then(2)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 6).then(3)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 7).then(4)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 8).then(5)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 10).then(6)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    # SEG2\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG2').then(\n",
    "        pl.when(pl.col('SCR_PD3000_000') >= 633).then(1)\n",
    "          .when(pl.col('SCR_PD3000_000') >= 612).then(2)\n",
    "          .when(pl.col('SCR_PD3000_000') >= 592).then(3)\n",
    "          .when(pl.col('SCR_PD3000_000') >= 570).then(4)\n",
    "          .when(pl.col('SCR_PD3000_000') >= 550).then(5)\n",
    "          .when(pl.col('SCR_PD3000_000') >= 0).then(6)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    # SEG3\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG3').then(\n",
    "        pl.when(pl.col('GRD_ML2000_000_SB') <= 3).then(1)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 5).then(2)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 6).then(3)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 7).then(4)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 8).then(5)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 9).then(6)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 10).then(7)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    # SEG4\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG4').then(\n",
    "        pl.when(pl.col('GRD_ML2000_000_SB') <= 2).then(1)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 3).then(2)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 4).then(3)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 5).then(4)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 6).then(5)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 7).then(6)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 8).then(7)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 9).then(8)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 10).then(9)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    # SEG5\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG5').then(\n",
    "        pl.when(pl.col('GRD_ML2000_000_SB') <= 2).then(1)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 3).then(2)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 4).then(3)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 5).then(4)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 6).then(5)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 7).then(6)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 8).then(7)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 9).then(8)\n",
    "          .when(pl.col('GRD_ML2000_000_SB') <= 10).then(9)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    .otherwise(None)\n",
    "    .alias('SHADOW_SUB_GRD1')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 152,
   "id": "65cbfe09-f29b-41d1-9a4e-fff9c7eb228f",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# SHADOW_SUB_GRD2 생성\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    # SEG1, SEG2, SEG3: 0\n",
    "    pl.when(pl.col('ASS_INRT_ID').is_in(['SEG1', 'SEG2', 'SEG3'])).then(0)\n",
    "    # SEG4: Scr_ML0100_002 기반\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG4').then(\n",
    "        pl.when(pl.col('SCR_ML0100_002') >= 700).then(1)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 680).then(2)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 660).then(3)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 640).then(4)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 620).then(5)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 600).then(6)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 580).then(7)\n",
    "          .when(pl.col('SCR_ML0100_002') >= 0).then(8)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    # SEG5: Scr_ML1300_500 기반\n",
    "    .when(pl.col('ASS_INRT_ID') == 'SEG5').then(\n",
    "        pl.when(pl.col('SCR_ML1300_500') >= 580).then(1)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 560).then(2)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 540).then(3)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 520).then(4)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 500).then(5)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 480).then(6)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 1).then(7)\n",
    "          .when(pl.col('SCR_ML1300_500') >= 0).then(8)\n",
    "          .otherwise(None)\n",
    "    )\n",
    "    .otherwise(None)\n",
    "    .alias('SHADOW_SUB_GRD2')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 153,
   "id": "fb8fe265-daf8-4038-89d5-a300f049542e",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# SHADOW_GRD 생성\n",
    "# ================================\n",
    "\n",
    "# SEG1, SEG2, SEG3: SHADOW_SUB_GRD1과 동일\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('ASS_INRT_ID').is_in(['SEG1', 'SEG2', 'SEG3']))\n",
    "      .then(pl.col('SHADOW_SUB_GRD1'))\n",
    "      .otherwise(None)\n",
    "      .alias('SHADOW_GRD')\n",
    "])\n",
    "\n",
    "# SEG4: 채널별 매트릭스 적용\n",
    "# 채널 그룹 1: 00256, 00292\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('ASS_INRT_ID') == 'SEG4') &\n",
    "        pl.col('RCV_CHNL_CD_VAL').is_in(['00256', '00292']) &\n",
    "        pl.col('SHADOW_SUB_GRD1').is_not_null() &\n",
    "        pl.col('SHADOW_SUB_GRD2').is_not_null()\n",
    "    ).then(\n",
    "        pl.struct(['SHADOW_SUB_GRD1', 'SHADOW_SUB_GRD2'])\n",
    "          .map_elements(\n",
    "              lambda x: GRD_LOOKUP_4_1.get((x['SHADOW_SUB_GRD1'], x['SHADOW_SUB_GRD2']), None),\n",
    "              return_dtype=pl.Int64\n",
    "          )\n",
    "    )\n",
    "    .otherwise(pl.col('SHADOW_GRD'))\n",
    "    .alias('SHADOW_GRD')\n",
    "])\n",
    "\n",
    "# 채널 그룹 2: 00268, 00301, 00247, 00330, 00336\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('ASS_INRT_ID') == 'SEG4') &\n",
    "        pl.col('RCV_CHNL_CD_VAL').is_in(['00268', '00301', '00247', '00330', '00336']) &\n",
    "        pl.col('SHADOW_SUB_GRD1').is_not_null() &\n",
    "        pl.col('SHADOW_SUB_GRD2').is_not_null()\n",
    "    ).then(\n",
    "        pl.struct(['SHADOW_SUB_GRD1', 'SHADOW_SUB_GRD2'])\n",
    "          .map_elements(\n",
    "              lambda x: GRD_LOOKUP_4_2.get((x['SHADOW_SUB_GRD1'], x['SHADOW_SUB_GRD2']), None),\n",
    "              return_dtype=pl.Int64\n",
    "          )\n",
    "    )\n",
    "    .otherwise(pl.col('SHADOW_GRD'))\n",
    "    .alias('SHADOW_GRD')\n",
    "])\n",
    "\n",
    "# 채널 그룹 3: 기타\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('ASS_INRT_ID') == 'SEG4') &\n",
    "        ~pl.col('RCV_CHNL_CD_VAL').is_in(['00256', '00292', '00268', '00301', '00247', '00330', '00336']) &\n",
    "        pl.col('SHADOW_SUB_GRD1').is_not_null() &\n",
    "        pl.col('SHADOW_SUB_GRD2').is_not_null()\n",
    "    ).then(\n",
    "        pl.struct(['SHADOW_SUB_GRD1', 'SHADOW_SUB_GRD2'])\n",
    "          .map_elements(\n",
    "              lambda x: GRD_LOOKUP_4_3.get((x['SHADOW_SUB_GRD1'], x['SHADOW_SUB_GRD2']), None),\n",
    "              return_dtype=pl.Int64\n",
    "          )\n",
    "    )\n",
    "    .otherwise(pl.col('SHADOW_GRD'))\n",
    "    .alias('SHADOW_GRD')\n",
    "])\n",
    "\n",
    "# SEG5: 매트릭스 적용\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('ASS_INRT_ID') == 'SEG5') &\n",
    "        pl.col('SHADOW_SUB_GRD1').is_not_null() &\n",
    "        pl.col('SHADOW_SUB_GRD2').is_not_null()\n",
    "    ).then(\n",
    "        pl.struct(['SHADOW_SUB_GRD1', 'SHADOW_SUB_GRD2'])\n",
    "          .map_elements(\n",
    "              lambda x: GRD_LOOKUP_5.get((x['SHADOW_SUB_GRD1'], x['SHADOW_SUB_GRD2']), None),\n",
    "              return_dtype=pl.Int64\n",
    "          )\n",
    "    )\n",
    "    .otherwise(pl.col('SHADOW_GRD'))\n",
    "    .alias('SHADOW_GRD')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "49f954af-a8cd-4e6b-90e8-0dae7048e56c",
   "metadata": {},
   "source": [
    "### AS Package Backscoring(필터링2_2차 / 완화승인)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 154,
   "id": "7579f871-440a-4f19-9d07-cef3c4098264",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ================================\n",
    "# 필터링 2_2차 BL 제거\n",
    "# ================================\n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('FILTER_2ND_2_RJCT_VAL').str.slice(0, 1) == '1').then(1).otherwise(0).alias('FT2_6_01'),\n",
    "    pl.when(pl.col('FILTER_2ND_2_RJCT_VAL').str.slice(1, 1) == '1').then(1).otherwise(0).alias('FT2_6_02'),\n",
    "    pl.when(pl.col('FILTER_2ND_2_RJCT_VAL').str.slice(2, 1) == '1').then(1).otherwise(0).alias('FT2_6_03'),\n",
    "    pl.when(pl.col('FILTER_2ND_2_RJCT_VAL').str.slice(3, 1) == '1').then(1).otherwise(0).alias('FT2_6_04'),\n",
    "    pl.when(pl.col('FILTER_2ND_2_RJCT_VAL').str.slice(4, 1) == '1').then(1).otherwise(0).alias('FT2_6_05'),\n",
    "    pl.lit(0).alias('FT2_6_06')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.sum_horizontal(pl.col(f'FT2_6_{i:02d}') for i in range(1, 7)) > 0).then(1).otherwise(0).alias('필터링_2_2차')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 155,
   "id": "c35e4ab3-ea5b-45ef-a045-a2591d5488de",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# OVERRIDE_TGT 생성\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        pl.col('ASS_DTLS_MDL_ID').is_in(['SEG1', 'SEG2', 'SEG3', 'SEG4', 'SEG5']) &\n",
    "        (pl.col('HNDLNG_BLCKNG_DSTNCTN_VAL') == '0') &\n",
    "        ((pl.col('FT2_6_02') + pl.col('FT2_6_03') + pl.col('FT2_6_04') + \n",
    "          pl.col('FT2_6_05') + pl.col('FT2_6_06')) == 0) &\n",
    "        (pl.col('ASS_GRADE_VAL') != '00010') &\n",
    "        ((pl.col('MDL_APRVL_DSTNCTN_VAL') == '1') | \n",
    "         (pl.col('FILTER1_DSCD_VAL') == '1') | \n",
    "         (pl.col('FILTER_2ND_1_VAL') == '1') | \n",
    "         (pl.col('필터링_2_2차') == 1) | \n",
    "         (pl.col('FILTER_3RD_VAL') == '1'))\n",
    "    ).then(1).otherwise(0).alias('OVERRIDE_TGT')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 156,
   "id": "dba4459f-caa8-462b-a4df-0236cb7f9f19",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# PFCT_OVR_YN (SEG4만 해당)\n",
    "# ================================\n",
    "\n",
    "PFCT_OVR_S4 = np.array([\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0],\n",
    "    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n",
    "    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n",
    "    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n",
    "])\n",
    "\n",
    "PFCT_OVR_S4_LOOKUP = {}\n",
    "for i in range(10):\n",
    "    for j in range(10):\n",
    "        PFCT_OVR_S4_LOOKUP[(i+1, j+1)] = int(PFCT_OVR_S4[i, j])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') &\n",
    "        pl.col('GRD_CSS').is_not_null() &\n",
    "        pl.col('GRD_FDLQ').is_not_null()\n",
    "    ).then(\n",
    "        pl.struct(['GRD_CSS', 'GRD_FDLQ'])\n",
    "        .map_elements(\n",
    "            lambda x: PFCT_OVR_S4_LOOKUP.get((int(x['GRD_CSS']), int(x['GRD_FDLQ'])), 0),\n",
    "            return_dtype=pl.Int64\n",
    "        )\n",
    "    ).otherwise(0).alias('PFCT_OVR_YN')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 157,
   "id": "8407281e-90b5-4b01-9646-42c277c8bd0e",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# CLST (클러스터) 생성\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('OCPT1_DSCD_VAL') == 'B').then(0)\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG1').then(1)\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG2').then(2)\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG3').then(3)\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG4').then(4)\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG5').then(5)\n",
    "    .otherwise(9)\n",
    "    .alias('CLST')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 158,
   "id": "68efc9a8-6267-4b8b-8e83-6272f480a801",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# OVR_YN_ST 생성 (Override 전략 점수)\n",
    "# ================================\n",
    "\n",
    "# CLST = 0 (자영업자 B)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 0)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_arfajdh8') >= 992).then(1)\n",
    "        .when(pl.col('M_arfajdh8') >= 960).then(2)\n",
    "        .when(pl.col('M_arfajdh8') >= 934).then(3)\n",
    "        .when(pl.col('M_arfajdh8') >= 905).then(4)\n",
    "        .when(pl.col('M_arfajdh8') >= 900).then(5)\n",
    "        .when(pl.col('M_boruwtqy') >= 706).then(6)\n",
    "        .when(pl.col('M_boruwtqy') >= 698).then(7)\n",
    "        .when(pl.col('M_arfajdh8') >= 892).then(8)\n",
    "        .when(pl.col('M_arfajdh8') >= 879).then(9)\n",
    "        .when(pl.col('M_boruwtqy') >= 690).then(10)\n",
    "        .when(pl.col('M_arfajdh8') >= 872).then(11)\n",
    "        .when(pl.col('M_arfajdh8') >= 866).then(12)\n",
    "        .when(pl.col('M_luviwzaf') >= 697).then(13)\n",
    "        .when(pl.col('M_boruwtqy') >= 672).then(14)\n",
    "        .when(pl.col('M_boruwtqy') >= 660).then(15)\n",
    "        .when(pl.col('M_0exc8ga5') >= 686).then(16)\n",
    "        .when(pl.col('M_boruwtqy') >= 649).then(17)\n",
    "        .when(pl.col('M_arfajdh8') >= 826).then(18)\n",
    "        .when(pl.col('M_arfajdh8') >= 812).then(19)\n",
    "        .when(pl.col('M_arfajdh8') >= 793).then(20)\n",
    "        .when(pl.col('M_arfajdh8') >= 790).then(21)\n",
    "        .when(pl.col('M_0exc8ga5') >= 632).then(22)\n",
    "        .when(pl.col('M_boruwtqy') >= 635).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_0')\n",
    "])\n",
    "\n",
    "# CLST = 1 (SEG1)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 1)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_arfajdh8') >= 933).then(1)\n",
    "        .when(pl.col('M_boruwtqy') >= 757).then(2)\n",
    "        .when(pl.col('M_arfajdh8') >= 902).then(3)\n",
    "        .when(pl.col('M_boruwtqy') >= 731).then(4)\n",
    "        .when(pl.col('M_arfajdh8') >= 879).then(5)\n",
    "        .when(pl.col('M_arfajdh8') >= 864).then(6)\n",
    "        .when(pl.col('M_boruwtqy') >= 699).then(7)\n",
    "        .when(pl.col('M_boruwtqy') >= 690).then(8)\n",
    "        .when(pl.col('M_boruwtqy') >= 682).then(9)\n",
    "        .when(pl.col('M_arfajdh8') >= 833).then(10)\n",
    "        .when(pl.col('M_arfajdh8') >= 818).then(11)\n",
    "        .when(pl.col('M_arfajdh8') >= 807).then(12)\n",
    "        .when(pl.col('M_arfajdh8') >= 799).then(13)\n",
    "        .when(pl.col('M_arfajdh8') >= 797).then(14)\n",
    "        .when(pl.col('M_boruwtqy') >= 646).then(15)\n",
    "        .when(pl.col('M_boruwtqy') >= 633).then(16)\n",
    "        .when(pl.col('M_arfajdh8') >= 791).then(17)\n",
    "        .when(pl.col('M_boruwtqy') >= 627).then(18)\n",
    "        .when(pl.col('M_arfajdh8') >= 783).then(19)\n",
    "        .when(pl.col('M_arfajdh8') >= 777).then(20)\n",
    "        .when(pl.col('M_arfajdh8') >= 768).then(21)\n",
    "        .when(pl.col('M_boruwtqy') >= 609).then(22)\n",
    "        .when(pl.col('M_arfajdh8') >= 765).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_1')\n",
    "])\n",
    "\n",
    "# CLST = 2 (SEG2)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 2)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_7ijtqual') >= 899).then(1)\n",
    "        .when(pl.col('M_6dx5p0pb') >= 1138).then(2)\n",
    "        .when(pl.col('M_luviwzaf') >= 839).then(3)\n",
    "        .when(pl.col('M_boruwtqy') >= 844).then(4)\n",
    "        .when(pl.col('M_0exc8ga5') >= 818).then(5)\n",
    "        .when(pl.col('M_luviwzaf') >= 808).then(6)\n",
    "        .when(pl.col('M_luviwzaf') >= 798).then(7)\n",
    "        .when(pl.col('M_boruwtqy') >= 792).then(8)\n",
    "        .when(pl.col('M_arfajdh8') >= 967).then(9)\n",
    "        .when(pl.col('M_0exc8ga5') >= 758).then(10)\n",
    "        .when(pl.col('M_boruwtqy') >= 783).then(11)\n",
    "        .when(pl.col('M_luviwzaf') >= 767).then(12)\n",
    "        .when(pl.col('M_boruwtqy') >= 746).then(13)\n",
    "        .when(pl.col('M_luviwzaf') >= 757).then(14)\n",
    "        .when(pl.col('M_boruwtqy') >= 728).then(15)\n",
    "        .when(pl.col('M_arfajdh8') >= 948).then(16)\n",
    "        .when(pl.col('M_luviwzaf') >= 743).then(17)\n",
    "        .when(pl.col('M_luviwzaf') >= 730).then(18)\n",
    "        .when(pl.col('M_boruwtqy') >= 704).then(19)\n",
    "        .when(pl.col('M_7ijtqual') >= 697).then(20)\n",
    "        .when(pl.col('M_6dx5p0pb') >= 1031).then(21)\n",
    "        .when(pl.col('M_0exc8ga5') >= 696).then(22)\n",
    "        .when(pl.col('M_arfajdh8') >= 929).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_2')\n",
    "])\n",
    "\n",
    "# CLST = 3 (SEG3)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 3)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_arfajdh8') >= 886).then(1)\n",
    "        .when(pl.col('M_boruwtqy') >= 721).then(2)\n",
    "        .when(pl.col('M_boruwtqy') >= 669).then(3)\n",
    "        .when(pl.col('M_boruwtqy') >= 646).then(4)\n",
    "        .when(pl.col('M_7ijtqual') >= 682).then(5)\n",
    "        .when(pl.col('M_arfajdh8') >= 831).then(6)\n",
    "        .when(pl.col('M_arfajdh8') >= 797).then(7)\n",
    "        .when(pl.col('M_boruwtqy') >= 636).then(8)\n",
    "        .when(pl.col('M_luviwzaf') >= 660).then(9)\n",
    "        .when(pl.col('M_arfajdh8') >= 792).then(10)\n",
    "        .when(pl.col('M_7ijtqual') >= 641).then(11)\n",
    "        .when(pl.col('M_arfajdh8') >= 778).then(12)\n",
    "        .when(pl.col('M_boruwtqy') >= 593).then(13)\n",
    "        .when(pl.col('M_arfajdh8') >= 771).then(14)\n",
    "        .when(pl.col('M_7ijtqual') >= 594).then(15)\n",
    "        .when(pl.col('M_7ijtqual') >= 579).then(16)\n",
    "        .when(pl.col('M_luviwzaf') >= 592).then(17)\n",
    "        .when(pl.col('M_luviwzaf') >= 583).then(18)\n",
    "        .when(pl.col('M_7ijtqual') >= 550).then(19)\n",
    "        .when(pl.col('M_arfajdh8') >= 762).then(20)\n",
    "        .when(pl.col('M_7ijtqual') >= 543).then(21)\n",
    "        .when(pl.col('M_boruwtqy') >= 564).then(22)\n",
    "        .when(pl.col('M_7ijtqual') >= 531).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_3')\n",
    "])\n",
    "\n",
    "# CLST = 4 (SEG4)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 4)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_luviwzaf') >= 733).then(1)\n",
    "        .when(pl.col('M_0exc8ga5') >= 722).then(2)\n",
    "        .when(pl.col('M_0exc8ga5') >= 694).then(3)\n",
    "        .when(pl.col('M_0exc8ga5') >= 671).then(4)\n",
    "        .when(pl.col('M_6dx5p0pb') >= 971).then(5)\n",
    "        .when(pl.col('M_7ijtqual') >= 651).then(6)\n",
    "        .when(pl.col('M_boruwtqy') >= 676).then(7)\n",
    "        .when(pl.col('M_luviwzaf') >= 627).then(8)\n",
    "        .when(pl.col('M_7ijtqual') >= 602).then(9)\n",
    "        .when(pl.col('M_luviwzaf') >= 602).then(10)\n",
    "        .when(pl.col('M_boruwtqy') >= 620).then(11)\n",
    "        .when(pl.col('M_0exc8ga5') >= 582).then(12)\n",
    "        .when(pl.col('M_boruwtqy') >= 602).then(13)\n",
    "        .when(pl.col('M_luviwzaf') >= 577).then(14)\n",
    "        .when(pl.col('M_luviwzaf') >= 550).then(15)\n",
    "        .when(pl.col('M_0exc8ga5') >= 559).then(16)\n",
    "        .when(pl.col('M_0exc8ga5') >= 520).then(17)\n",
    "        .when(pl.col('M_7ijtqual') >= 515).then(18)\n",
    "        .when(pl.col('M_arfajdh8') >= 752).then(19)\n",
    "        .when(pl.col('M_0exc8ga5') >= 514).then(20)\n",
    "        .when(pl.col('M_7ijtqual') >= 514).then(21)\n",
    "        .when(pl.col('M_7ijtqual') >= 510).then(22)\n",
    "        .when(pl.col('M_0exc8ga5') >= 513).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_4')\n",
    "])\n",
    "\n",
    "# CLST = 5 (SEG5)\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('CLST') == 5)\n",
    "    ).then(\n",
    "        pl.when(pl.col('M_0exc8ga5') >= 751).then(1)\n",
    "        .when(pl.col('M_boruwtqy') >= 707).then(2)\n",
    "        .when(pl.col('M_7ijtqual') >= 723).then(3)\n",
    "        .when(pl.col('M_boruwtqy') >= 673).then(4)\n",
    "        .when(pl.col('M_arfajdh8') >= 821).then(5)\n",
    "        .when(pl.col('M_0exc8ga5') >= 623).then(6)\n",
    "        .when(pl.col('M_arfajdh8') >= 807).then(7)\n",
    "        .when(pl.col('M_arfajdh8') >= 802).then(8)\n",
    "        .when(pl.col('M_luviwzaf') >= 619).then(9)\n",
    "        .when(pl.col('M_boruwtqy') >= 636).then(10)\n",
    "        .when(pl.col('M_0exc8ga5') >= 609).then(11)\n",
    "        .when(pl.col('M_0exc8ga5') >= 599).then(12)\n",
    "        .when(pl.col('M_luviwzaf') >= 577).then(13)\n",
    "        .when(pl.col('M_0exc8ga5') >= 559).then(14)\n",
    "        .when(pl.col('M_arfajdh8') >= 768).then(15)\n",
    "        .when(pl.col('M_0exc8ga5') >= 557).then(16)\n",
    "        .when(pl.col('M_0exc8ga5') >= 556).then(17)\n",
    "        .when(pl.col('M_0exc8ga5') >= 554).then(18)\n",
    "        .when(pl.col('M_luviwzaf') >= 545).then(19)\n",
    "        .when(pl.col('M_boruwtqy') >= 540).then(20)\n",
    "        .when(pl.col('M_6dx5p0pb') >= 893).then(21)\n",
    "        .when(pl.col('M_7ijtqual') >= 544).then(22)\n",
    "        .when(pl.col('M_luviwzaf') >= 543).then(23)\n",
    "        .otherwise(0)\n",
    "    ).otherwise(pl.lit(None).cast(pl.Int64)).alias('OVR_YN_ST_5')\n",
    "])\n",
    "\n",
    "# OVR_YN_ST 통합\n",
    "df = df.with_columns([\n",
    "    pl.coalesce([\n",
    "        pl.col('OVR_YN_ST_0'),\n",
    "        pl.col('OVR_YN_ST_1'),\n",
    "        pl.col('OVR_YN_ST_2'),\n",
    "        pl.col('OVR_YN_ST_3'),\n",
    "        pl.col('OVR_YN_ST_4'),\n",
    "        pl.col('OVR_YN_ST_5')\n",
    "    ]).fill_null(0).alias('OVR_YN_ST')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 159,
   "id": "0ea47ba6-2e38-48e7-95cf-1ff85928cc44",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# OVR_APRV_YN (Override 승인 여부)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('CHNL_DVCD') != '2').then(\n",
    "        # SEG1\n",
    "        pl.when(pl.col('ASS_DTLS_MDL_ID') == 'SEG1').then(\n",
    "            pl.when(pl.col('OVR_YN_ST') > 0).then(0).otherwise(1)\n",
    "        )\n",
    "        # SEG2\n",
    "        .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG2').then(\n",
    "            pl.when(\n",
    "                (pl.col('CHNL_DVCD') == '1') &\n",
    "                (pl.col('RELF_ML_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006','00007'])) &               \n",
    "                (pl.col('OCPT1_DSCD_VAL') != 'B')\n",
    "            ).then(0)\n",
    "            .when(\n",
    "                pl.col('CHNL_DVCD').is_in(['3', '4']) &\n",
    "                (pl.col('RELF_ML_GRADE_VAL').is_in(['00001','00002','00003'])) &\n",
    "                (pl.col('AS0000144') >= 30) &\n",
    "                (pl.col('AS0000140') == 2) &\n",
    "                (pl.col('OCPT1_DSCD_VAL') != 'B')\n",
    "            ).then(0)\n",
    "            .otherwise(1)\n",
    "        )\n",
    "        # SEG3\n",
    "        .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG3').then(\n",
    "            pl.when(pl.col('KC1000001') <= 0).then(\n",
    "                pl.when(pl.col('OVR_YN_ST') > 0).then(0).otherwise(1)\n",
    "            ).otherwise(1)\n",
    "        )\n",
    "        # SEG4\n",
    "        .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG4').then(\n",
    "            pl.when(pl.col('PFCT_OVR_YN') > 0).then(0).otherwise(1)\n",
    "        )\n",
    "        # SEG5\n",
    "        .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG5').then(\n",
    "            pl.when(pl.col('OCPT1_DSCD_VAL') != 'B').then(\n",
    "                pl.when(pl.col('OVR_YN_ST') > 0).then(0).otherwise(1)\n",
    "            ).otherwise(1)\n",
    "        )\n",
    "        .otherwise(1)\n",
    "    ).otherwise(1).alias('OVR_APRV_YN')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 160,
   "id": "e9b6f377-eea6-46d9-83f4-ecc1c5335604",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ================================\n",
    "# 완화승인\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OVERRIDE_TGT') == 1) & (pl.col('OVR_APRV_YN') == 0)\n",
    "    ).then(0).otherwise(1).alias('완화승인')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 161,
   "id": "13ec8b5e-3c31-4a18-a788-9ce29c2cb1a0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 한도 초기값 Setting \n",
    "\n",
    "as_pack_scor_val = ['W_INCOME', 'UPLM_AMT_M', 'LWLM_AMT_M', 'W_LMT_M', 'UPLM_AMT_H', 'LWLM_AMT_H', 'W_LMT_H']\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(None, dtype = pl.Float64).alias(col) for col in as_pack_scor_val\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 162,
   "id": "ab6322fb-bdd3-44ff-ad54-eff9a7876307",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 소득인정 등급\n",
    "# Seg1\n",
    "seg1_income_lookup={}\n",
    "\n",
    "seg1_income = np.array([[1], [0.9], [0.9], [0.8], [0.8], [0.7], [0.7], [0.6], [0.6]])\n",
    "\n",
    "for i in range(seg1_income.shape[0]):\n",
    "    seg1_income_lookup[i+1] = float(seg1_income[i,0])\n",
    "\n",
    "# Seg2\n",
    "seg2_income_lookup={}\n",
    "\n",
    "seg2_income = np.array([[1.2],[1.15],[1.1],[1.05],[1.05],[1.05],[1],[1],[1]])\n",
    "\n",
    "for i in range(seg2_income.shape[0]):\n",
    "    seg2_income_lookup[i+1] = float(seg2_income[i,0])\n",
    "\n",
    "# Seg3\n",
    "seg3_income_lookup={}\n",
    "\n",
    "seg3_income = np.array([[1],[1],[0.9],[0.9],[0.8],[0.8],[0.7],[0.7],[0.6]])\n",
    "\n",
    "for i in range(seg3_income.shape[0]):\n",
    "    seg3_income_lookup[i+1] = float(seg3_income[i,0])\n",
    "\n",
    "# Seg4\n",
    "seg4_income_lookup={}\n",
    "\n",
    "seg4_income = np.array([[1.2],[1.2],[1.15],[1.15],[1.1],[1.1],[1],[1],[0.9]])\n",
    "\n",
    "for i in range(seg4_income.shape[0]):\n",
    "    seg4_income_lookup[i+1] = float(seg4_income[i,0])\n",
    "\n",
    "# Seg5\n",
    "seg5_income_lookup={}\n",
    "\n",
    "seg5_income = np.array([[1.2],[1.2],[1.2],[1],[1],[1],[0.9],[0.9],[0.8]])\n",
    "\n",
    "for i in range(seg5_income.shape[0]):\n",
    "    seg5_income_lookup[i+1] = float(seg5_income[i,0])   \n",
    "\n",
    "\n",
    "# SEG6\n",
    "\n",
    "seg6_income_lookup={}\n",
    "\n",
    "seg6_income = np.array([[1.1],[1.1],[1],[1],[0.9],[0.9],[0.8],[0.8],[0.7]])\n",
    "\n",
    "for i in range(seg6_income.shape[0]):\n",
    "    seg6_income_lookup[i+1] = float(seg6_income[i,0])\n",
    "\n",
    "    \n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( pl.col('ASS_DTLS_MDL_ID') == 'SEG1' )\n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg1_income_lookup.get(x,None),return_dtype=pl.Float64)            \n",
    "        )\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG2')\n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg2_income_lookup.get(x,None),return_dtype=pl.Float64)\n",
    "        )\n",
    "    .when( pl.col('ASS_DTLS_MDL_ID') == 'SEG3')\n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg3_income_lookup.get(x,None),return_dtype=pl.Float64)\n",
    "        )\n",
    "    .when( (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') | ((pl.col('ASS_DTLS_MDL_ID') == 'SEG7') & (pl.col('A0200') == '00010')) ) \n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg4_income_lookup.get(x,None),return_dtype=pl.Float64)\n",
    "        )\n",
    "    .when( (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')  | ((pl.col('ASS_DTLS_MDL_ID') == 'SEG7') & (pl.col('A0200') != '00010')) )\n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg5_income_lookup.get(x,None),return_dtype=pl.Float64)\n",
    "        )\n",
    "\n",
    "    .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG6')\n",
    "        .then(\n",
    "            pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg6_income_lookup.get(x,None),return_dtype=pl.Float64)     )\n",
    "    .otherwise(pl.col('W_INCOME')).alias('W_INCOME')\n",
    "])\n",
    "       \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 163,
   "id": "dac0fad3-790c-4b2b-bf13-642449004398",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Seg1 한도로직\n",
    "seg1_uplm_m_lookup = {}\n",
    "seg1_lwlm_m_lookup = {}\n",
    "seg1_w_lmt_m_lookup = {}\n",
    "seg1_uplm_h_lookup = {}\n",
    "seg1_lwlm_h_lookup = {}\n",
    "seg1_w_lmt_h_lookup = {}\n",
    "\n",
    "seg1_lmt_pack = np.array([\n",
    "    [30000000, 0, 1.70, 1.50],\n",
    "    [30000000, 0, 1.70, 1.50],\n",
    "    [30000000, 0, 1.60, 1.40],\n",
    "    [30000000, 0, 1.60, 1.40],\n",
    "    [20000000, 0, 1.50, 1.30],\n",
    "    [10000000, 0, 1.50, 1.30]\n",
    "])\n",
    "\n",
    "for i in range(seg1_lmt_pack.shape[0]):\n",
    "    seg1_uplm_m_lookup[i+1] = float(seg1_lmt_pack[i,0])\n",
    "    seg1_lwlm_m_lookup[i+1] = float(seg1_lmt_pack[i,1])\n",
    "    seg1_w_lmt_m_lookup[i+1] = float(seg1_lmt_pack[i,2])\n",
    "    seg1_uplm_h_lookup[i+1] = float(seg1_lmt_pack[i,0])\n",
    "    seg1_lwlm_h_lookup[i+1] = float(seg1_lmt_pack[i,1])\n",
    "    seg1_w_lmt_h_lookup[i+1] = float(seg1_lmt_pack[i,3])\n",
    "\n",
    "# Seg2 한도로직    \n",
    "seg2_uplm_m_lookup = {}\n",
    "seg2_lwlm_m_lookup = {}\n",
    "seg2_w_lmt_m_lookup = {}\n",
    "seg2_uplm_h_lookup = {}\n",
    "seg2_lwlm_h_lookup = {}\n",
    "seg2_w_lmt_h_lookup = {}\n",
    "\n",
    "seg2_lmt_pack = np.array([\n",
    "    [100000000, 5000000, 1.60, 1.40],\n",
    "    [80000000, 5000000, 1.55, 1.35],\n",
    "    [70000000, 5000000, 1.45, 1.25],\n",
    "    [50000000, 0, 1.40, 1.20],\n",
    "    [40000000, 0, 1.30, 1.10],\n",
    "    [30000000, 0, 1.30, 1.10]    \n",
    "])\n",
    "\n",
    "for i in range(seg2_lmt_pack.shape[0]):\n",
    "    seg2_uplm_m_lookup[i+1] = float(seg2_lmt_pack[i,0])\n",
    "    seg2_lwlm_m_lookup[i+1] = float(seg2_lmt_pack[i,1])\n",
    "    seg2_w_lmt_m_lookup[i+1] = float(seg2_lmt_pack[i,2])\n",
    "    seg2_uplm_h_lookup[i+1] = float(seg2_lmt_pack[i,0])\n",
    "    seg2_lwlm_h_lookup[i+1] = float(seg2_lmt_pack[i,1])\n",
    "    seg2_w_lmt_h_lookup[i+1] = float(seg2_lmt_pack[i,3])\n",
    "\n",
    "# Seg3 한도로직    \n",
    "seg3_uplm_m_lookup = {}\n",
    "seg3_lwlm_m_lookup = {}\n",
    "seg3_w_lmt_m_lookup = {}\n",
    "seg3_uplm_h_lookup = {}\n",
    "seg3_lwlm_h_lookup = {}\n",
    "seg3_w_lmt_h_lookup = {}\n",
    "\n",
    "seg3_lmt_pack = np.array([\n",
    "    [50000000, 0, 1.50, 1.30],\n",
    "    [50000000, 0, 1.40, 1.20],\n",
    "    [50000000, 0, 1.40, 1.20],\n",
    "    [40000000, 0, 1.30, 1.10],\n",
    "    [40000000, 0, 1.20, 1.00],\n",
    "    [20000000, 0, 1.00, 0.80]    \n",
    "])\n",
    "\n",
    "for i in range(seg3_lmt_pack.shape[0]):\n",
    "    seg3_uplm_m_lookup[i+1] = float(seg3_lmt_pack[i,0])\n",
    "    seg3_lwlm_m_lookup[i+1] = float(seg3_lmt_pack[i,1])\n",
    "    seg3_w_lmt_m_lookup[i+1] = float(seg3_lmt_pack[i,2])\n",
    "    seg3_uplm_h_lookup[i+1] = float(seg3_lmt_pack[i,0])\n",
    "    seg3_lwlm_h_lookup[i+1] = float(seg3_lmt_pack[i,1])\n",
    "    seg3_w_lmt_h_lookup[i+1] = float(seg3_lmt_pack[i,3])\n",
    "    \n",
    "\n",
    "# Seg4_플랫폼 우량 한도로직    \n",
    "seg4_0_uplm_m_lookup = {}\n",
    "seg4_0_lwlm_m_lookup = {}\n",
    "seg4_0_w_lmt_m_lookup = {}\n",
    "seg4_0_uplm_h_lookup = {}\n",
    "seg4_0_lwlm_h_lookup = {}\n",
    "seg4_0_w_lmt_h_lookup = {}\n",
    "\n",
    "seg4_0_lmt_pack = np.array([\n",
    "    [100000000, 5000000, 1.90, 1.70],\n",
    "    [80000000, 5000000, 1.90, 1.70],\n",
    "    [60000000, 5000000, 1.80, 1.60],\n",
    "    [50000000, 0, 1.70, 1.50],\n",
    "    [40000000, 0, 1.50, 1.30],\n",
    "    [30000000, 0, 1.35, 1.15]\n",
    "])\n",
    "\n",
    "for i in range(seg4_0_lmt_pack.shape[0]):\n",
    "    seg4_0_uplm_m_lookup[i+1] = float(seg4_0_lmt_pack[i,0])\n",
    "    seg4_0_lwlm_m_lookup[i+1] = float(seg4_0_lmt_pack[i,1])\n",
    "    seg4_0_w_lmt_m_lookup[i+1] = float(seg4_0_lmt_pack[i,2])\n",
    "    seg4_0_uplm_h_lookup[i+1] = float(seg4_0_lmt_pack[i,0])\n",
    "    seg4_0_lwlm_h_lookup[i+1] = float(seg4_0_lmt_pack[i,1])\n",
    "    seg4_0_w_lmt_h_lookup[i+1] = float(seg4_0_lmt_pack[i,3])\n",
    "\n",
    " \n",
    "# Seg4_플랫폼 일반 한도로직    \n",
    "seg4_1_uplm_m_lookup = {}\n",
    "seg4_1_lwlm_m_lookup = {}\n",
    "seg4_1_w_lmt_m_lookup = {}\n",
    "seg4_1_uplm_h_lookup = {}\n",
    "seg4_1_lwlm_h_lookup = {}\n",
    "seg4_1_w_lmt_h_lookup = {}\n",
    "\n",
    "seg4_1_lmt_pack = np.array([\n",
    "    [100000000, 5000000, 1.90, 1.70],\n",
    "    [80000000, 5000000, 1.80, 1.60],\n",
    "    [60000000, 5000000, 1.70, 1.50],\n",
    "    [50000000, 0, 1.50, 1.30],\n",
    "    [40000000, 0, 1.35, 1.15],\n",
    "    [30000000, 0, 1.20, 1.00]\n",
    "])\n",
    "\n",
    "for i in range(seg4_1_lmt_pack.shape[0]):\n",
    "    seg4_1_uplm_m_lookup[i+1] = float(seg4_1_lmt_pack[i,0])\n",
    "    seg4_1_lwlm_m_lookup[i+1] = float(seg4_1_lmt_pack[i,1])\n",
    "    seg4_1_w_lmt_m_lookup[i+1] = float(seg4_1_lmt_pack[i,2])\n",
    "    seg4_1_uplm_h_lookup[i+1] = float(seg4_1_lmt_pack[i,0])\n",
    "    seg4_1_lwlm_h_lookup[i+1] = float(seg4_1_lmt_pack[i,1])\n",
    "    seg4_1_w_lmt_h_lookup[i+1] = float(seg4_1_lmt_pack[i,3])\n",
    "\n",
    "\n",
    "# Seg5_플랫폼 우량 한도로직    \n",
    "seg5_0_uplm_m_lookup = {}\n",
    "seg5_0_lwlm_m_lookup = {}\n",
    "seg5_0_w_lmt_m_lookup = {}\n",
    "seg5_0_uplm_h_lookup = {}\n",
    "seg5_0_lwlm_h_lookup = {}\n",
    "seg5_0_w_lmt_h_lookup = {}\n",
    "\n",
    "seg5_0_lmt_pack = np.array([\n",
    "    [100000000, 5000000, 1.90, 1.70],\n",
    "    [80000000, 5000000, 1.80, 1.60],\n",
    "    [60000000, 5000000, 1.70, 1.50],\n",
    "    [50000000, 0, 1.50, 1.30],\n",
    "    [40000000, 0, 1.35, 1.15],\n",
    "    [30000000, 0, 1.20, 1.00]   \n",
    "])\n",
    "\n",
    "for i in range(seg5_0_lmt_pack.shape[0]):\n",
    "    seg5_0_uplm_m_lookup[i+1] = float(seg5_0_lmt_pack[i,0])\n",
    "    seg5_0_lwlm_m_lookup[i+1] = float(seg5_0_lmt_pack[i,1])\n",
    "    seg5_0_w_lmt_m_lookup[i+1] = float(seg5_0_lmt_pack[i,2])\n",
    "    seg5_0_uplm_h_lookup[i+1] = float(seg5_0_lmt_pack[i,0])\n",
    "    seg5_0_lwlm_h_lookup[i+1] = float(seg5_0_lmt_pack[i,1])\n",
    "    seg5_0_w_lmt_h_lookup[i+1] = float(seg5_0_lmt_pack[i,3])  \n",
    "\n",
    "# Seg5_플랫폼 우량 한도로직    \n",
    "seg5_1_uplm_m_lookup = {}\n",
    "seg5_1_lwlm_m_lookup = {}\n",
    "seg5_1_w_lmt_m_lookup = {}\n",
    "seg5_1_uplm_h_lookup = {}\n",
    "seg5_1_lwlm_h_lookup = {}\n",
    "seg5_1_w_lmt_h_lookup = {}\n",
    "\n",
    "seg5_1_lmt_pack = np.array([\n",
    "    [100000000, 5000000, 1.90, 1.70],\n",
    "    [80000000, 5000000, 1.70, 1.50],\n",
    "    [60000000, 5000000, 1.40, 1.20],\n",
    "    [30000000, 0, 1.20, 1.00],\n",
    "    [20000000, 0, 1.10, 0.90],\n",
    "    [10000000, 0, 1.10, 0.90]    \n",
    "])\n",
    "\n",
    "for i in range(seg5_1_lmt_pack.shape[0]):\n",
    "    seg5_1_uplm_m_lookup[i+1] = float(seg5_1_lmt_pack[i,0])\n",
    "    seg5_1_lwlm_m_lookup[i+1] = float(seg5_1_lmt_pack[i,1])\n",
    "    seg5_1_w_lmt_m_lookup[i+1] = float(seg5_1_lmt_pack[i,2])\n",
    "    seg5_1_uplm_h_lookup[i+1] = float(seg5_1_lmt_pack[i,0])\n",
    "    seg5_1_lwlm_h_lookup[i+1] = float(seg5_1_lmt_pack[i,1])\n",
    "    seg5_1_w_lmt_h_lookup[i+1] = float(seg5_1_lmt_pack[i,3])  \n",
    "\n",
    "    \n",
    "# Seg6 한도로직    \n",
    "seg6_uplm_m_lookup = {}\n",
    "seg6_lwlm_m_lookup = {}\n",
    "seg6_w_lmt_m_lookup = {}\n",
    "seg6_uplm_h_lookup = {}\n",
    "seg6_lwlm_h_lookup = {}\n",
    "seg6_w_lmt_h_lookup = {}\n",
    "\n",
    "seg6_lmt_pack = np.array([\n",
    "    [50000000, 0, 1.50, 1.30],\n",
    "    [50000000, 0, 1.40, 1.20],\n",
    "    [50000000, 0, 1.40, 1.20],\n",
    "    [40000000, 0, 1.30, 1.10],\n",
    "    [40000000, 0, 1.20, 1.00],\n",
    "    [20000000, 0, 1.00, 0.80]   \n",
    "])\n",
    "\n",
    "for i in range(seg6_lmt_pack.shape[0]):\n",
    "    seg6_uplm_m_lookup[i+1] = float(seg6_lmt_pack[i,0])\n",
    "    seg6_lwlm_m_lookup[i+1] = float(seg6_lmt_pack[i,1])\n",
    "    seg6_w_lmt_m_lookup[i+1] = float(seg6_lmt_pack[i,2])\n",
    "    seg6_uplm_h_lookup[i+1] = float(seg6_lmt_pack[i,0])\n",
    "    seg6_lwlm_h_lookup[i+1] = float(seg6_lmt_pack[i,1])\n",
    "    seg6_w_lmt_h_lookup[i+1] = float(seg6_lmt_pack[i,3])\n",
    "\n",
    "    \n",
    "# Seg7 한도로직    \n",
    "seg7_uplm_m_lookup = {}\n",
    "seg7_lwlm_m_lookup = {}\n",
    "seg7_w_lmt_m_lookup = {}\n",
    "seg7_uplm_h_lookup = {}\n",
    "seg7_lwlm_h_lookup = {}\n",
    "seg7_w_lmt_h_lookup = {}\n",
    "\n",
    "seg7_lmt_pack = np.array([\n",
    "    [100000000, 0, 1.90, 1.70],\n",
    "    [80000000, 0, 1.70, 1.50],\n",
    "    [60000000, 0, 1.40, 1.20],\n",
    "    [30000000, 0, 1.20, 1.00],\n",
    "    [20000000, 0, 1.10, 0.90],\n",
    "    [10000000, 0, 1.10, 0.90]  \n",
    "])\n",
    "\n",
    "for i in range(seg7_lmt_pack.shape[0]):\n",
    "    seg7_uplm_m_lookup[i+1] = float(seg7_lmt_pack[i,0])\n",
    "    seg7_lwlm_m_lookup[i+1] = float(seg7_lmt_pack[i,1])\n",
    "    seg7_w_lmt_m_lookup[i+1] = float(seg7_lmt_pack[i,2])\n",
    "    seg7_uplm_h_lookup[i+1] = float(seg7_lmt_pack[i,0])\n",
    "    seg7_lwlm_h_lookup[i+1] = float(seg7_lmt_pack[i,1])\n",
    "    seg7_w_lmt_h_lookup[i+1] = float(seg7_lmt_pack[i,3])   "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 164,
   "id": "5c76440a-18b4-44f1-b3b7-b8401a1e7f25",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( pl.col('ASS_DTLS_MDL_ID') == 'SEG1')\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg1_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg1_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg1_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg1_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg1_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg1_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( pl.col('ASS_DTLS_MDL_ID') == 'SEG2')\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg2_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg2_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg2_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg2_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg2_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg2_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( pl.col('ASS_DTLS_MDL_ID') == 'SEG3')\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg3_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg3_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg3_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg3_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg3_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg3_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('A0210') == '00010'))\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg4_0_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_0_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_0_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_0_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_0_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_0_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( ((pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('A0210') == '00020')) \n",
    "           | (((pl.col('ASS_DTLS_MDL_ID') == 'SEG7') & (pl.col('A0200') == '00020'))))\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg4_1_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_1_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_1_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_1_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_1_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg4_1_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('A0210') == '00010'))\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg5_0_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_0_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_0_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_0_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_0_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_0_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('A0210') == '00020'))\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg5_1_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_1_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_1_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_1_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_1_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg5_1_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( pl.col('ASS_DTLS_MDL_ID') == 'SEG6')\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg6_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg6_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg6_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg6_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg6_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg6_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .when( pl.col('ASS_DTLS_MDL_ID') == 'SEG7')\n",
    "    .then(\n",
    "        pl.struct([pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "            .map_elements(lambda x: seg7_uplm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_0')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg7_lwlm_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_1')\n",
    "            ,pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg7_w_lmt_m_lookup.get(x,None),return_dtype=pl.Float64).alias('field_2')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg7_uplm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_3')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg7_lwlm_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_4')\n",
    "            ,pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "                .map_elements(lambda x: seg7_w_lmt_h_lookup.get(x,None),return_dtype=pl.Float64).alias('field_5')\n",
    "                  ])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('UPLM_AMT_M').alias('field_0')\n",
    "                   ,pl.col('LWLM_AMT_M').alias('field_1')\n",
    "                   ,pl.col('W_LMT_M').alias('field_2')\n",
    "                   ,pl.col('UPLM_AMT_H').alias('field_3')\n",
    "                   ,pl.col('LWLM_AMT_H').alias('field_4')\n",
    "                   ,pl.col('W_LMT_H').alias('field_5')])\n",
    "    ).alias('AS_SCOR_PACK_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_0').alias('UPLM_AMT_M'),\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_1').alias('LWLM_AMT_M'),\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_2').alias('W_LMT_M'),\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_3').alias('UPLM_AMT_H'),\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_4').alias('LWLM_AMT_H'),\n",
    "    pl.col('AS_SCOR_PACK_STRUCT').struct.field('field_5').alias('W_LMT_H')\n",
    "])\n",
    "\n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "765c952a-c912-4d39-b7ce-eeeae15d42f1",
   "metadata": {},
   "source": [
    "### AS 한도 Backscoring"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 165,
   "id": "384ab1c7-c01f-4f32-90c1-bd6dfec94d80",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# # ================================\n",
    "# # 소득인정배수 및 한도배수 Lookup Dictionary 생성\n",
    "# # ================================\n",
    "\n",
    "# #초기값 필수 \n",
    "# target_cols = ['W_INCOME', 'UPLM_AMT_M', 'LWLM_AMT_M', 'W_LMT_M', 'UPLM_AMT_H', 'LWLM_AMT_H', 'W_LMT_H']\n",
    "\n",
    "# # 모든 target_cols에 대해 초기값으로 None (Float64 타입) 설정\n",
    "# df = df.with_columns([pl.lit(None, dtype=pl.Float64).alias(col) for col in target_cols])\n",
    "\n",
    "# def create_seg_lookup(income_matrix, limit_matrix):\n",
    "#     \"\"\"SEG 매트릭스를 Lookup dictionary로 변환\"\"\"\n",
    "#     income_lookup = {}\n",
    "#     uplm_m_lookup = {}\n",
    "#     lwlm_m_lookup = {}\n",
    "#     w_lmt_m_lookup = {}\n",
    "#     uplm_h_lookup = {}\n",
    "#     lwlm_h_lookup = {}\n",
    "#     w_lmt_h_lookup = {}\n",
    "    \n",
    "#     # 소득 가중치 (1~9등급)\n",
    "#     for i in range(len(income_matrix)):\n",
    "#         income_lookup[i+1] = float(income_matrix[i, 0])\n",
    "    \n",
    "#     # 중금리/고금리 한도 (1~6등급)\n",
    "#     for i in range(len(limit_matrix)):\n",
    "#         uplm_m_lookup[i+1] = float(limit_matrix[i, 0])\n",
    "#         lwlm_m_lookup[i+1] = float(limit_matrix[i, 1])\n",
    "#         w_lmt_m_lookup[i+1] = float(limit_matrix[i, 2])\n",
    "#         uplm_h_lookup[i+1] = float(limit_matrix[i, 0])\n",
    "#         lwlm_h_lookup[i+1] = float(limit_matrix[i, 1])\n",
    "#         w_lmt_h_lookup[i+1] = float(limit_matrix[i, 3])\n",
    "    \n",
    "#     return {\n",
    "#         'income': income_lookup,\n",
    "#         'uplm_m': uplm_m_lookup,\n",
    "#         'lwlm_m': lwlm_m_lookup,\n",
    "#         'w_lmt_m': w_lmt_m_lookup,\n",
    "#         'uplm_h': uplm_h_lookup,\n",
    "#         'lwlm_h': lwlm_h_lookup,\n",
    "#         'w_lmt_h': w_lmt_h_lookup\n",
    "#     }\n",
    "\n",
    "# def apply_seg_matrix_to_df(df, seg_name, seg_lookup, condition=None):\n",
    "#     \"\"\"\n",
    "#     SEG별 매트릭스를 DataFrame에 적용\n",
    "    \n",
    "#     Parameters:\n",
    "#     -----------\n",
    "#     df : Polars DataFrame\n",
    "#     seg_name : str - 'SEG1', 'SEG2', ... 등\n",
    "#     seg_lookup : dict - create_seg_lookup으로 생성한 lookup dictionary\n",
    "#     condition : Polars expression - 추가 조건 (기본: None)\n",
    "#                 예: (pl.col('A0210') == '00010')\n",
    "#     \"\"\"\n",
    "    \n",
    "#     if condition is None:\n",
    "#         condition = pl.col('ASS_DTLS_MDL_ID') == seg_name\n",
    "    \n",
    "#     return df.with_columns([\n",
    "#         # W_INCOME\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('INCOME_RCGNTN_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['income'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('W_INCOME')).alias('W_INCOME'),\n",
    "        \n",
    "#         # UPLM_AMT_M\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['uplm_m'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('UPLM_AMT_M')).alias('UPLM_AMT_M'),\n",
    "        \n",
    "#         # LWLM_AMT_M\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['lwlm_m'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('LWLM_AMT_M')).alias('LWLM_AMT_M'),\n",
    "        \n",
    "#         # W_LMT_M\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('MIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['w_lmt_m'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('W_LMT_M')).alias('W_LMT_M'),\n",
    "        \n",
    "#         # UPLM_AMT_H\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['uplm_h'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('UPLM_AMT_H')).alias('UPLM_AMT_H'),\n",
    "        \n",
    "#         # LWLM_AMT_H\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['lwlm_h'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('LWLM_AMT_H')).alias('LWLM_AMT_H'),\n",
    "        \n",
    "#         # W_LMT_H\n",
    "#         pl.when(condition).then(\n",
    "#             pl.col('HIRT_LMT_GRADE_VAL').cast(pl.Int64)\n",
    "#             .map_elements(lambda x: seg_lookup['w_lmt_h'].get(x, None), return_dtype=pl.Float64)\n",
    "#         ).otherwise(pl.col('W_LMT_H')).alias('W_LMT_H')\n",
    "#     ])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 166,
   "id": "50c59cc7-3047-42fb-8e3d-53731953b417",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# # ================================\n",
    "# # 매트릭스 정의\n",
    "# # ================================\n",
    "\n",
    "# grd1_3 = np.array([[1], [0.9], [0.9], [0.8], [0.8], [0.7], [0.7], [0.6], [0.6]])\n",
    "# grd1_4 = np.array([\n",
    "#     [30000000, 0, 1.70, 1.50],\n",
    "#     [30000000, 0, 1.70, 1.50],\n",
    "#     [30000000, 0, 1.60, 1.40],\n",
    "#     [30000000, 0, 1.60, 1.40],\n",
    "#     [20000000, 0, 1.50, 1.30],\n",
    "#     [10000000, 0, 1.50, 1.30]\n",
    "# ])\n",
    "\n",
    "# grd2_3 = np.array([[1.2], [1.15], [1.1], [1.05], [1.05], [1.05], [1], [1], [1]])\n",
    "# grd2_4 = np.array([\n",
    "#     [100000000, 5000000, 1.60, 1.40],\n",
    "#     [80000000, 5000000, 1.55, 1.35],\n",
    "#     [70000000, 5000000, 1.45, 1.25],\n",
    "#     [50000000, 0, 1.40, 1.20],\n",
    "#     [40000000, 0, 1.30, 1.10],\n",
    "#     [30000000, 0, 1.30, 1.10]\n",
    "# ])\n",
    "\n",
    "# grd3_3 = np.array([[1], [1], [0.9], [0.9], [0.8], [0.8], [0.7], [0.7], [0.6]])\n",
    "# grd3_4 = np.array([\n",
    "#     [50000000, 0, 1.50, 1.30],\n",
    "#     [50000000, 0, 1.40, 1.20],\n",
    "#     [50000000, 0, 1.40, 1.20],\n",
    "#     [40000000, 0, 1.30, 1.10],\n",
    "#     [40000000, 0, 1.20, 1.00],\n",
    "#     [20000000, 0, 1.00, 0.80]\n",
    "# ])\n",
    "\n",
    "# grd4_3_0 = np.array([[1.2], [1.2], [1.15], [1.15], [1.1], [1.1], [1], [1], [0.9]])\n",
    "# grd4_4_0 = np.array([\n",
    "#     [100000000, 5000000, 1.90, 1.70],\n",
    "#     [80000000, 5000000, 1.90, 1.70],\n",
    "#     [60000000, 5000000, 1.80, 1.60],\n",
    "#     [50000000, 0, 1.70, 1.50],\n",
    "#     [40000000, 0, 1.50, 1.30],\n",
    "#     [30000000, 0, 1.35, 1.15]\n",
    "# ])\n",
    "\n",
    "# grd4_3_1 = np.array([[1.2], [1.2], [1.15], [1.15], [1.1], [1.1], [1], [1], [0.9]])\n",
    "# grd4_4_1 = np.array([\n",
    "#     [100000000, 5000000, 1.90, 1.70],\n",
    "#     [80000000, 5000000, 1.80, 1.60],\n",
    "#     [60000000, 5000000, 1.70, 1.50],\n",
    "#     [50000000, 0, 1.50, 1.30],\n",
    "#     [40000000, 0, 1.35, 1.15],\n",
    "#     [30000000, 0, 1.20, 1.00]\n",
    "# ])\n",
    "\n",
    "# grd5_3_0 = np.array([[1.2], [1.2], [1.2], [1], [1], [1], [0.9], [0.9], [0.8]])\n",
    "# grd5_4_0 = np.array([\n",
    "#     [100000000, 5000000, 1.90, 1.70],\n",
    "#     [80000000, 5000000, 1.80, 1.60],\n",
    "#     [60000000, 5000000, 1.70, 1.50],\n",
    "#     [50000000, 0, 1.50, 1.30],\n",
    "#     [40000000, 0, 1.35, 1.15],\n",
    "#     [30000000, 0, 1.20, 1.00]\n",
    "# ])\n",
    "\n",
    "# grd5_3_1 = np.array([[1.2], [1.2], [1.2], [1], [1], [1], [0.9], [0.9], [0.8]])\n",
    "# grd5_4_1 = np.array([\n",
    "#     [100000000, 5000000, 1.90, 1.70],\n",
    "#     [80000000, 5000000, 1.70, 1.50],\n",
    "#     [60000000, 5000000, 1.40, 1.20],\n",
    "#     [30000000, 0, 1.20, 1.00],\n",
    "#     [20000000, 0, 1.10, 0.90],\n",
    "#     [10000000, 0, 1.10, 0.90]\n",
    "# ])\n",
    "\n",
    "# grd6_3 = np.array([[1.1], [1.1], [1], [1], [0.9], [0.9], [0.8], [0.8], [0.7]])\n",
    "# grd6_4 = np.array([\n",
    "#     [50000000, 0, 1.50, 1.30],\n",
    "#     [50000000, 0, 1.40, 1.20],\n",
    "#     [50000000, 0, 1.40, 1.20],\n",
    "#     [40000000, 0, 1.30, 1.10],\n",
    "#     [40000000, 0, 1.20, 1.00],\n",
    "#     [20000000, 0, 1.00, 0.80]\n",
    "# ])\n",
    "\n",
    "# grd7_3 = np.array([[1.2], [1.2], [1.2], [1], [1], [1], [0.9], [0.9], [0.8]])\n",
    "# grd7_4 = np.array([\n",
    "#     [100000000, 0, 1.90, 1.70],\n",
    "#     [80000000, 0, 1.70, 1.50],\n",
    "#     [60000000, 0, 1.40, 1.20],\n",
    "#     [30000000, 0, 1.20, 1.00],\n",
    "#     [20000000, 0, 1.10, 0.90],\n",
    "#     [10000000, 0, 1.10, 0.90]\n",
    "# ])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 167,
   "id": "284e9d78-5570-45f3-94df-7cc781af09a5",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# # ================================\n",
    "# # Lookup dictionary 생성\n",
    "# # ================================\n",
    "\n",
    "# seg1_lookup = create_seg_lookup(grd1_3, grd1_4)\n",
    "# seg2_lookup = create_seg_lookup(grd2_3, grd2_4)\n",
    "# seg3_lookup = create_seg_lookup(grd3_3, grd3_4)\n",
    "# seg4_0_lookup = create_seg_lookup(grd4_3_0, grd4_4_0)\n",
    "# seg4_1_lookup = create_seg_lookup(grd4_3_1, grd4_4_1)\n",
    "# seg5_0_lookup = create_seg_lookup(grd5_3_0, grd5_4_0)\n",
    "# seg5_1_lookup = create_seg_lookup(grd5_3_1, grd5_4_1)\n",
    "# seg6_lookup = create_seg_lookup(grd6_3, grd6_4)\n",
    "# seg7_lookup = create_seg_lookup(grd7_3, grd7_4)\n",
    "\n",
    "# # ================================\n",
    "# # DataFrame에 적용 (한 줄씩!)\n",
    "# # ================================\n",
    "\n",
    "# # SEG1\n",
    "# df = apply_seg_matrix_to_df(df, 'SEG1', seg1_lookup)\n",
    "\n",
    "# # SEG2\n",
    "# df = apply_seg_matrix_to_df(df, 'SEG2', seg2_lookup)\n",
    "\n",
    "# # SEG3\n",
    "# df = apply_seg_matrix_to_df(df, 'SEG3', seg3_lookup)\n",
    "\n",
    "# # SEG4 (A0210='00010')\n",
    "# df = apply_seg_matrix_to_df(\n",
    "#     df, 'SEG4_0010', seg4_0_lookup,\n",
    "#     condition=((pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('A0210') == '00010'))\n",
    "# )\n",
    "\n",
    "# # SEG4 (A0210='00020') 또는 SEG7 (A0200='00010')\n",
    "# df = apply_seg_matrix_to_df(\n",
    "#     df, 'SEG4_0020', seg4_1_lookup,\n",
    "#     condition=(\n",
    "#         ((pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('A0210') == '00020')) |\n",
    "#         ((pl.col('ASS_DTLS_MDL_ID') == 'SEG7') & (pl.col('A0200') == '00010'))\n",
    "#     )\n",
    "# )\n",
    "\n",
    "# # SEG5 (A0210='00010')\n",
    "# df = apply_seg_matrix_to_df(\n",
    "#     df, 'SEG5_0010', seg5_0_lookup,\n",
    "#     condition=((pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('A0210') == '00010'))\n",
    "# )\n",
    "\n",
    "# # SEG5 (A0210='00020')\n",
    "# df = apply_seg_matrix_to_df(\n",
    "#     df, 'SEG5_0020', seg5_1_lookup,\n",
    "#     condition=((pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('A0210') == '00020'))\n",
    "# )\n",
    "\n",
    "# # SEG6\n",
    "# df = apply_seg_matrix_to_df(df, 'SEG6', seg6_lookup)\n",
    "\n",
    "# # SEG7 (다른 조건) - A0200이 '00010'이 아닌 경우\n",
    "# df = apply_seg_matrix_to_df(\n",
    "#     df, 'SEG7_other', seg7_lookup,\n",
    "#     condition=((pl.col('ASS_DTLS_MDL_ID') == 'SEG7') & (pl.col('A0200') != '00010'))\n",
    "# )\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 168,
   "id": "dc5dd54f-9f81-496b-b609-341d4c65db91",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 소득 계산 (INCOME_F)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('EVDN_INCOME_AMT') > 0).then(\n",
    "        pl.when(pl.col('IE0400007') * 10000 >= pl.col('EVDN_INCOME_AMT')).then(\n",
    "            pl.min_horizontal([\n",
    "                pl.col('IE0400007') * 10000,\n",
    "                (pl.col('EVDN_INCOME_AMT') * 1.5 / 10000).cast(pl.Int64) * 10000\n",
    "            ])\n",
    "        ).otherwise(\n",
    "            pl.min_horizontal([\n",
    "                ((pl.col('IE0400007') * 10000 + pl.col('EVDN_INCOME_AMT')) / 2 / 10000).cast(pl.Int64) * 10000,\n",
    "                pl.col('IE0400007') * 20000\n",
    "            ])\n",
    "        )\n",
    "    ).otherwise(pl.col('IE0400007') * 10000)\n",
    "    .alias('INCOME_F')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 169,
   "id": "07e604ad-8f86-46c7-a282-2ab82e18e738",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 급여 채무비 1이하 한도배수 0.1 추가\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('RMIX00001') > 0)\n",
    "    ).then(1).otherwise(0).alias('W_INCOME_ADD_TGT')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('W_INCOME_ADD_TGT') == 1).then(\n",
    "        pl.col('W_INCOME') + 0.1\n",
    "    ).otherwise(pl.col('W_INCOME')).alias('W_INCOME')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 170,
   "id": "e536aa08-0d64-455b-87a4-8f9b5354a13e",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 한도추가 가중치 계산 (W_ADD_M, W_ADD_H)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('A0110') == '00010') & (pl.col('A0150') == '00020') & (pl.col('A0190') == '00010')\n",
    "    ).then(pl.struct([pl.lit(0.6).alias('field_0'), pl.lit(0.6).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00010') & (pl.col('A0150') == '00020') & (pl.col('A0190') == '00020')\n",
    "    ).then(pl.struct([pl.lit(0.1).alias('field_0'), pl.lit(0.1).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00020') & (pl.col('A0150') == '00010') & (pl.col('A0190') == '00010')\n",
    "    ).then(pl.struct([pl.lit(0.6).alias('field_0'), pl.lit(0.6).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00020') & (pl.col('A0150') == '00010') & (pl.col('A0190') == '00020')\n",
    "    ).then(pl.struct([pl.lit(0.1).alias('field_0'), pl.lit(0.1).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00010') & (pl.col('A0150') == '00010') & (pl.col('A0190') == '00010')\n",
    "    ).then(pl.struct([pl.lit(0.7).alias('field_0'), pl.lit(0.7).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00010') & (pl.col('A0150') == '00010') & (pl.col('A0190') == '00020')\n",
    "    ).then(pl.struct([pl.lit(0.2).alias('field_0'), pl.lit(0.2).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00020') & (pl.col('A0150') == '00020') & (pl.col('A0190') == '00010')\n",
    "    ).then(pl.struct([pl.lit(0.5).alias('field_0'), pl.lit(0.5).alias('field_1')]))\n",
    "    .when(\n",
    "        (pl.col('A0110') == '00020') & (pl.col('A0150') == '00020') & (pl.col('A0190') == '00020')\n",
    "    ).then(pl.struct([pl.lit(0.0).alias('field_0'), pl.lit(0.0).alias('field_1')]))\n",
    "    .otherwise(pl.struct([pl.lit(0.0).alias('field_0'), pl.lit(0.0).alias('field_1')]))\n",
    "    .alias('W_ADD_STRUCT')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.col('W_ADD_STRUCT').struct.field('field_0').alias('W_ADD_M'),\n",
    "    pl.col('W_ADD_STRUCT').struct.field('field_1').alias('W_ADD_H')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 171,
   "id": "751367ec-2db2-45d0-8c27-13c474a77032",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 내부잔액 설정\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(0).alias('내부잔액')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 172,
   "id": "262c41f9-4d86-488a-a6de-1b24c4cdf8d8",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# 신용기초 한도 계산 (LMT_AMT_FST_M, LMT_AMT_FST_H)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    # 중금리 한도\n",
    "    (((\n",
    "        pl.max_horizontal([\n",
    "            pl.min_horizontal([\n",
    "                (pl.col('INCOME_F') * pl.col('W_INCOME') - pl.col('ANLZD_PIAMT_RPYMNT_AMT')) * (pl.col('W_LMT_M') + pl.col('W_ADD_M')), pl.col('UPLM_AMT_M')\n",
    "            ]),\n",
    "            pl.col('LWLM_AMT_M')\n",
    "        ]) / 1000000\n",
    "    ).cast(pl.Int64)) * 1000000)\n",
    "    .alias('LMT_AMT_FST_M') ,\n",
    "    \n",
    "    # 고금리 한도\n",
    "    (((\n",
    "        pl.max_horizontal([\n",
    "            pl.min_horizontal([\n",
    "                (pl.col('INCOME_F') * pl.col('W_INCOME') - pl.col('ANLZD_PIAMT_RPYMNT_AMT')) * \n",
    "                (pl.col('W_LMT_H') + pl.col('W_ADD_H')),\n",
    "                pl.col('UPLM_AMT_H')\n",
    "            ]),\n",
    "            pl.col('LWLM_AMT_H')\n",
    "        ]) / 1000000\n",
    "    ).cast(pl.Int64)) * 1000000)\n",
    "    .alias('LMT_AMT_FST_H')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 173,
   "id": "d62e8d62-79cc-47f7-9e8d-02916ac6d11f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ================================\n",
    "# AS 한도거절 (APRV_AMT_YN_M, APRV_AMT_YN_H)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('LMT_AMT_FST_M') > 1000000).then(0).otherwise(1).alias('APRV_AMT_YN_M_0')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('LMT_AMT_FST_H') > 1000000).then(0).otherwise(1).alias('APRV_AMT_YN_H'),    \n",
    "    pl.when(pl.col('LMT_AMT_FST_H') > 1000000).then('APRV_AMT_YN_M_0').otherwise(1).alias('APRV_AMT_YN_M')    \n",
    "]).drop(['APRV_AMT_YN_M_0'])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "235cbc22-df1f-4d52-bbb6-a11d4d119010",
   "metadata": {},
   "source": [
    "### AS Package 승인 및 한도 , 금리 seg 변경"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 174,
   "id": "7392d4de-1779-478e-a949-efed44756009",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# AS Package 최종 승인 (ASS_DECISION_M, ASS_DECISION_H)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    # Override 대상이고 완화승인 = 0인 경우\n",
    "    pl.when( (pl.col('OVERRIDE_TGT') == 1) & (pl.col('완화승인') == 0)\n",
    "    )\n",
    "    .then(\n",
    "        pl.when(pl.col('APRV_AMT_YN_H') == 1)\n",
    "            .then(\n",
    "            pl.struct([pl.lit('00020').alias('field_0'), pl.lit('00020').alias('field_1')])\n",
    "            )\n",
    "        .when(pl.col('APRV_AMT_YN_H') == 0)\n",
    "            .then( pl.when(pl.col('LMT_MLTP_PRF_YN') == '1') \n",
    "                        .then(\n",
    "                            pl.struct([pl.lit('00010').alias('field_0'), pl.lit('00010').alias('field_1')])\n",
    "                            )\n",
    "                .otherwise(\n",
    "                    pl.struct([pl.lit('00020').alias('field_0'), pl.lit('00010').alias('field_1')])\n",
    "                    )\n",
    "        )\n",
    "        .otherwise(pl.struct([pl.lit('00020').alias('field_0'), pl.lit('00020').alias('field_1')]))\n",
    "    )\n",
    "    # 일반 경우\n",
    "    .otherwise(\n",
    "        pl.when(\n",
    "            (pl.col('HNDLNG_BLCKNG_DSTNCTN_VAL') == '1') |\n",
    "            (pl.col('MDL_APRVL_DSTNCTN_VAL') == '1') |\n",
    "            (pl.col('FILTER1_DSCD_VAL') == '1') |\n",
    "            (pl.col('FILTER_2ND_1_VAL') == '1') |\n",
    "            (pl.col('필터링_2_2차') > 0) |\n",
    "            (pl.col('FILTER_3RD_VAL') == '1') |\n",
    "            (pl.col('APRV_AMT_YN_H') == 1)\n",
    "        ).then(\n",
    "            pl.struct([pl.lit('00020').alias('field_0'), pl.lit('00020').alias('field_1')])\n",
    "        )\n",
    "        .otherwise(\n",
    "            pl.when(pl.col('LMT_MLTP_PRF_YN') == '1').then(\n",
    "                pl.struct([pl.lit('00010').alias('field_0'), pl.lit('00010').alias('field_1')])\n",
    "            ).otherwise(\n",
    "                pl.struct([pl.lit('00020').alias('field_0'), pl.lit('00010').alias('field_1')])\n",
    "            )\n",
    "        )\n",
    "    )\n",
    "    .alias('ASS_DECISION_STRUCT')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.col('ASS_DECISION_STRUCT').struct.field('field_0').alias('ASS_DECISION_M'),\n",
    "    pl.col('ASS_DECISION_STRUCT').struct.field('field_1').alias('ASS_DECISION_H')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 175,
   "id": "0ec94228-3c74-4fb1-a50d-07a5564cf7d1",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# ================================\n",
    "# LMT_AMT_FST_M_ST00, LMT_AMT_FST_H_ST00\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('ASS_DECISION_M') == '00010').then(\n",
    "        pl.col('LMT_AMT_FST_M')\n",
    "    ).otherwise(0).alias('LMT_AMT_FST_M_ST00'),\n",
    "    \n",
    "    pl.when(pl.col('ASS_DECISION_H') == '00010').then(\n",
    "        pl.col('LMT_AMT_FST_H')\n",
    "    ).otherwise(0).alias('LMT_AMT_FST_H_ST00')\n",
    "]).with_columns([\n",
    "    pl.col('LMT_AMT_FST_M_ST00').alias('NpSprNmLimit'),\n",
    "    pl.col('LMT_AMT_FST_H_ST00').alias('DtirUniLmtAmt')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 176,
   "id": "35a0b780-bbb2-4cfa-9554-95c0a9d1e598",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 금리 Seg 변경 (AS Package 최종금리 추가시 필)\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    # 외국인 외\n",
    "    # row_number : 1\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') != 'E') \n",
    "             & (pl.col('CHNL_DVCD') == '2') & (pl.col('IntScrId') == 'SEG4'))\n",
    "        .then(\n",
    "            pl.struct([pl.lit('SEG5').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "        )\n",
    "        \n",
    "    # row_number : 2\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E') \n",
    "           & (pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5'])) & (pl.col('AsRtgCdH') == '00006')\n",
    "    )\n",
    "        .then(\n",
    "            pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])        \n",
    "    )\n",
    "        \n",
    "    #row_number : 3        \n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5'])) & (pl.col('AsRtgCdH').is_in(['00001','00002','00003','00004','00005']))\n",
    "    )\n",
    "        .then(\n",
    "            pl.struct([pl.lit('SEG1').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "        )\n",
    "     # row_number : 4   \n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00001')        \n",
    "    )\n",
    "        .then(\n",
    "            pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00002').alias('field_1'),pl.lit('00002').alias('field_2')])\n",
    "            )\n",
    "\n",
    "     # row_number : 5   \n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00002')         \n",
    "    )\n",
    "        .then(\n",
    "            pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00003').alias('field_1'),pl.lit('00003').alias('field_2')])            \n",
    "        )\n",
    "\n",
    "    # row_number : 6\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00003')            \n",
    "    ).then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00004').alias('field_1'),pl.lit('00004').alias('field_2')])\n",
    "        \n",
    "    )\n",
    "\n",
    "    # row_number : 7\n",
    "   .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00004')            \n",
    "    ).then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])\n",
    "        \n",
    "    )\n",
    "\n",
    "    # row_number : 8\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') != 'E')\n",
    "            & (pl.col('IntScrId') == 'SEG4') & (pl.col('완화승인') == 0 )\n",
    "    ).then(\n",
    "        pl.struct([pl.lit('SEG5').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 9\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') != 'E')\n",
    "           & (pl.col('CHNL_DVCD') == '1') & (pl.col('IntScrId') == 'SEG4') & (pl.col('ML_ODR3_GRADE_VAL') == '00007')\n",
    "        \n",
    "    ).then(\n",
    "        pl.struct([pl.lit('SEG5').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 10\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') != 'E')\n",
    "           & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('IntScrId') == 'SEG4') \n",
    "           & (pl.col('ML_ODR3_GRADE_VAL') == '00007') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG5').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 11\n",
    "    .when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('OCPT1_DSCD_VAL') != 'E')\n",
    "           & (pl.col('IntScrId') == 'SEG4') & (pl.col('ML_ODR3_GRADE_VAL').is_in(['00008','00009','00010']))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG5').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # 외국인 금리seg 변경\n",
    "    # row_number : 1\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & ((pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5']))) \n",
    "        & (pl.col('AsRtgCdH') == '00006')\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & ((pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5']))) \n",
    "        & (pl.col('AsRtgCdH').is_in(['00001','00002','00003','00004','00005']))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00001')\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00002').alias('field_1'),pl.lit('00002').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 4\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00002')\n",
    "           )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00003').alias('field_1'),pl.lit('00003').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 5\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00003')           \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00004').alias('field_1'),pl.lit('00004').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 6\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0210001001','0211002004'])) & (pl.col('IntScrId') == 'SEG3') & (pl.col('AsRtgCdH') == '00004')  \n",
    "\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])\n",
    "    )\n",
    "    # 성실상환론 금리 seg 변경\n",
    "    # row_number : 1\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5']))\n",
    "           & (pl.col('AsRtgCdH') == '00006') )    \n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])\n",
    "    )\n",
    "        \n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId').is_in(['SEG2','SEG4','SEG5']))\n",
    "            & (pl.col('AsRtgCdH').is_in(['00001','00002','00003','00004','00005']))         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    )\n",
    "        \n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId') == 'SEG3') & ( pl.col('AsRtgCdH') == '00001')\n",
    "        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00002').alias('field_1'),pl.lit('00002').alias('field_2')])\n",
    "    )\n",
    "        \n",
    "     # row_number : 4   \n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId') == 'SEG3') & ( pl.col('AsRtgCdH') == '00002')      \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00003').alias('field_1'),pl.lit('00003').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 5  \n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId') == 'SEG3') & ( pl.col('AsRtgCdH') == '00003')  \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00004').alias('field_1'),pl.lit('00004').alias('field_2')])\n",
    "    )\n",
    "        \n",
    "    # row_number : 6   \n",
    "    .when( (pl.col('LN_PD_VAL').is_in(['0205001013','0201001109'])) & (pl.col('IntScrId') == 'SEG3') & ( pl.col('AsRtgCdH') == '00004')   \n",
    "\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('SEG1').alias('field_0'),pl.lit('00005').alias('field_1'),pl.lit('00005').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('IntScrId').alias('field_0'),pl.col('AsRtgCdM').alias('field_1'),pl.col('AsRtgCdH').alias('field_2')])\n",
    "    ).alias('IntScrId_200_STRUCT')   \n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('IntScrId_200_STRUCT').struct.field('field_0').alias('IntScrId'), \n",
    "    pl.col('IntScrId_200_STRUCT').struct.field('field_1').alias('AsRtgCdM'), \n",
    "    pl.col('IntScrId_200_STRUCT').struct.field('field_2').alias('AsRtgCdH')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 177,
   "id": "cd4d2e0c-b45d-4940-8025-25cdcf9d45ca",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 확인필요 AS Package 최종 승인여부 및 한도 us 초기 세팅 여부\n",
    "df = df.with_columns([\n",
    "    (pl.col('ASS_DECISION_H')).alias('Decision') ,\n",
    "    (pl.col('ASS_DECISION_M')).alias('npWronFltrVl') ,\n",
    "    (pl.col('LMT_AMT_FST_H_ST00')).alias('FnlLmtAmt') ,\n",
    "    (pl.col('LMT_AMT_FST_M_ST00')).alias('npDtirUniLmtAmt'),\n",
    "    pl.lit(None).alias('C0015') # 땡겨받는 통장 Bacskcoring 불가\n",
    "   \n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "120707d2-1508-43b8-9bfc-ca4b6667a99c",
   "metadata": {},
   "source": [
    "### US 전략  Seg2 오버라이드 대상 구분"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 178,
   "id": "b7d100e1-9bdd-4b07-8236-a9450129ca8e",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# T0400_SEG2_AS오버라이드대상_여부 입력정보 정규화 / T0400 Setting\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit('00030').alias('T0400') ,\n",
    "    pl.lit('00020').alias('T0561') ,\n",
    "    pl.lit(None).alias('C0099'), \n",
    "    pl.lit(None).alias('C99_400'),\n",
    "    \n",
    "    pl.when(pl.col('IE0400007')==0).then(pl.lit(0))    \n",
    "    .otherwise((((pl.col('KC1000001')*1000000)/(pl.col('IE0400007')*10000)*100).floor())/100).alias('T0560')\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.when(pl.col('KC1000001') <= 50).then(pl.lit('00010'))\n",
    "    .when(pl.col('T0560') <= 1).then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('T0561')).alias('T0561')\n",
    "    \n",
    "]).with_columns([    \n",
    "    pl.when((pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('OVERRIDE_TGT') == 1)\n",
    "            & (pl.col('RELF_ML_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006','00007'])) \n",
    "            & (pl.col('LMT_AMT_FST_H') > 1000000) & (pl.col('ASS_DECISION_H') == '00020') \n",
    "            & ((pl.col('OCPT1_DSCD_VAL') == 'A') | ((pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0561') == '00010')))           \n",
    "           ).then(pl.lit('C99')).otherwise(pl.col('C0099')).alias('C0099')\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.when(pl.col('C0099') == 'C99').then(pl.lit('00010')).otherwise(pl.col('Decision')).alias('Decision') , \n",
    "    pl.when(pl.col('C0099') == 'C99').then(pl.col('LMT_AMT_FST_H')).otherwise(pl.col('FnlLmtAmt')).alias('FnlLmtAmt'),\n",
    "    pl.when(pl.col('C0099') == 'C99').then(pl.lit('00010')).otherwise(pl.col('T0400')).alias('T0400')\n",
    "])    "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "350462fa-7078-4e6b-bd34-af18aabd7d03",
   "metadata": {},
   "source": [
    "### US CUT OFF_V1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 179,
   "id": "b18a5396-2c5f-4f4b-b0cb-89f7d2a9902d",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ==============================================================================\n",
    "# RF 200_CUTOFF\n",
    "# ==============================================================================\n",
    "\n",
    "# C02_3일내 이동통신개통건수 1건 이상\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('STRTG_MTCH1_VAL').str.len_bytes() > 1)&(pl.col('STRTG_MTCH1_VAL').str.slice(1,1) == '1')).then(1).otherwise(0).alias('C02')     \n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C02') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C02') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C02') > 0).then(pl.lit('C02')).otherwise(pl.lit(None)).alias('C0002')    \n",
    "]).drop(['C02'])\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 180,
   "id": "27c174a6-2d83-4e08-be65-bed295fbc582",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C07: 등급 하위 \n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('SI0001000').is_in([8,9,10]))).then(1)        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('S8R201000').is_in([9,10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('SPP001000').is_in([7, 8, 9, 10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('SS1001000').is_in([7, 8, 9, 10, 11]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('SUL001000').is_in([8, 9, 10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('T0330') != '00010') & (pl.col('GRD_ML0600_000').is_in([7, 8, 9, 10]))).then(1)        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('SI0001000').is_in([9,10]))).then(1)        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('S8R201000').is_in([9,10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('SPP001000').is_in([8, 9, 10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('SS1001000').is_in([10,11]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('SUL001000').is_in([8, 9, 10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'B') & (pl.col('T0330') != '00010') & (pl.col('GRD_ML0600_000').is_in([10]))).then(1)           \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0330') != '00010') & (pl.col('GRD_RK0600_700').is_in([7,8,9,10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0330') != '00010') & (pl.col('SCR_RK0600_000') <= 600)).then(1)    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0330') != '00010') & (pl.col('GRD_ML0100_002').is_in([9,10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0330') != '00010') & (pl.col('GRD_ML0700_000_s').is_in([10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0330') != '00010') & (pl.col('S92201000').is_in([9,10,11]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') <= 600 )).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0302006').is_in([7,8,9,10]))).then(1)        \n",
    "    .otherwise(0).alias('C07')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C07') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C07') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C07') > 0).then(pl.lit('C07')).otherwise(pl.lit(None)).alias('C0007')\n",
    "]).drop(['C07'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 181,
   "id": "8fcfce91-5dea-4795-9d3d-c61c358a8aa4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C13 FINDA채널제어\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') & (pl.col('GRD_ML0100_001') >= 9 )).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') & (pl.col('SUL001000') >= 6)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') & (pl.col('SI0001000').is_in([8,9,10]))).then(1)        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('SF3001000') >= 5)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('SD0001000') >= 7)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('GRD_PD0801_000') >= 15)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('LA0000101') == 0)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'B')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('GRD_ML0100_002') >= 7) & (pl.col('S8R201000') >= 6)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('C00000074') >= 3)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('LA0000038') >= 2)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('SUL001000') >= 6)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_IE0305_000') >= 15)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('L00140001') >= 2)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_ML0100_001') >= 7)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_NK0300_000') >= 6)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('T0140') == 0)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('L00080001') >= 4)).then(1)        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_ML0700_000_s') >= 9)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_IE0305_000') >= 15)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('C00000074') >= 2)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('GRD_PD2400_000') >= 4)).then(1)\n",
    "    .otherwise(0).alias('C13')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C13') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C13') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C13') > 0).then(pl.lit('C13')).otherwise(pl.lit(None)).alias('C0013')\n",
    "]).drop(['C13'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 182,
   "id": "5e9ccb7d-f57f-49ea-83f6-46b4136dd20b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C14 동시대출제어\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('STRTG_MTCH1_VAL').str.len_bytes() > 14) & (pl.col('STRTG_MTCH1_VAL').str.slice(13,1) == '1')).then(1)\n",
    "    .otherwise(0).alias('C14')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C14') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C14') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C14') > 0).then(pl.lit('C14')).otherwise(pl.lit(None)).alias('C0014')\n",
    "]).drop(['C14'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 183,
   "id": "f36aa867-61f0-486d-bc85-71ec9312bd99",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C18 FINDA채널제어2\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') & (pl.col('GNDR_DSCD') != '00001')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG1') & (pl.col('GNDR_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') != 'A')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('OCPT1_DSCD_VAL') != 'A')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.max_horizontal([pl.col('AS0000136'), pl.col('AS0000137')]) >= 50)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4','SEG5'])) & (pl.col('OCPT1_DSCD_VAL') == 'B')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00301') & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4','SEG5'])) & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.max_horizontal([pl.col('AS0000136'), pl.col('AS0000137')]) >= 50)).then(1)        \n",
    "    .otherwise(0).alias('C18')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C18') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C18') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C18') > 0).then(pl.lit('C18')).otherwise(pl.lit(None)).alias('C0018')\n",
    "]).drop(['C18'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 184,
   "id": "5eac006b-10fe-4a6d-8095-f605e951e0c0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C19 자영업자 추가 제어 입력값 대체 없어 backscoring 불가 \n",
    "# 운영시점 가능\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when( (pl.col('STRTG_MTCH1_VAL').str.len_bytes() > 1 ) & (pl.col('STRTG_MTCH1_VAL').str.slice(18,1) == '1' ) )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C19').alias('field_2')])        \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.lit(None).alias('field_2')])        \n",
    "    ).alias('C19_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C19_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C19_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C19_STRUCT').struct.field('field_2').alias('C0019')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 185,
   "id": "6a2a0f03-67a2-49a4-9fb9-badd689d7659",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C24 SEG2제휴_거절\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('CHNL_DVCD').is_in(['3', '4', '5'])) \n",
    "             & (pl.col('HIRT_LMT_GRADE_VAL').is_in(['00004', '00005', '00006'])))\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C24').alias('field_2')])        \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.lit(None).alias('field_2')])        \n",
    "    ).alias('C24_STRUCT')\n",
    "]).with_columns([\n",
    "    pl.col('C24_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C24_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C24_STRUCT').struct.field('field_2').alias('C0024')   \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 186,
   "id": "e064b2b6-b91f-4d1b-8057-205a609b7ad1",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C01 FB등급제어V2\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (pl.col('STRTG_MTCH1_VAL').str.len_bytes() > 1) & (pl.col('STRTG_MTCH1_VAL').str.slice(0,1) == '1')        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C01').alias('field_2')])           \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.lit(None).alias('field_2')])         \n",
    "    )\n",
    "    .alias('C01_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C01_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C01_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C01_STRUCT').struct.field('field_2').alias('C0001')   \n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 187,
   "id": "0ae69b46-c650-4cf7-a40a-4efaa663a7fa",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C04 SP채무건전성하위제어V2\n",
    "\n",
    "df = df.with_columns([    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530') == '00020') & (pl.col('GRD_ML1300_500').is_in([9, 10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530') == '00020') & (pl.col('GRD_ML1300_500').is_in([8, 9, 10])) & (pl.col('CHNL_DVCD').is_in(['3', '4', '5'])) & (pl.col('OCPT1_DSCD_VAL') == 'B')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00031','00033','00051','00053'])) & (pl.col('GRD_ML1300_500').is_in([9, 10]))).then(1)\n",
    "    .otherwise(0).alias('C04')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C04') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C04') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C04') > 0).then(pl.lit('C04')).otherwise(pl.lit(None)).alias('C0004')\n",
    "]).drop(['C04'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 188,
   "id": "ded17098-8dd5-48b9-98be-47a4e84f1ef5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C06 SP업권다중채무자제어V2\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['2', '3', '4', '5'])) \n",
    "            & (pl.col('T0530').is_in(['00013','00020','00032'])) \n",
    "            & (pl.max_horizontal([pl.col('AS0000136'), pl.col('AS0000137')]) <= 35) & (pl.col('GNDR_DSCD') == '00003') \n",
    "            & (pl.col('T0090') >= 3))\n",
    "        .then(\n",
    "            pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C06').alias('field_2')])              \n",
    "        )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.lit(None).alias('field_2')])\n",
    "    ).alias('C06_STRUCT')\n",
    "]).with_columns([\n",
    "    pl.col('C06_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C06_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C06_STRUCT').struct.field('field_2').alias('C0006')      \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 189,
   "id": "4779d212-01ed-4466-9ffd-d0d4f7f3cf71",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C08 다중채무제어V2\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & ~(pl.col('CHNL_DVCD').is_in(['1'])) \n",
    "            & (pl.col('SD0001000').is_in([6,7,8,9,10])) & (pl.col('T0100') >= 3) & (pl.col('L12000001') >= 2))\n",
    "        .then(\n",
    "            pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C08').alias('field_2')])\n",
    "        )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.lit(None).alias('field_2')])        \n",
    "    ).alias('C08_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C08_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C08_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C08_STRUCT').struct.field('field_2').alias('C0008')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 190,
   "id": "79c4892b-ca6f-45e7-8f4d-cb5d88414829",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C12 신규모형오픈후_불량속성제어V2\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00020'])) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "            & (pl.col('완화승인') == 0) & (pl.col('RELF_ML_GRADE_VAL') == '00003')).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00041','00051','00043','00053'])) & (pl.col('CHNL_DVCD').is_in(['2'])) \n",
    "          & (pl.col('L00080001') >= 1 ) & (pl.col('C00000074') >= 1) & (pl.col('CL0600908') > 50) & (pl.col('CL0600908') != 999999991)).then(1)\n",
    "    .otherwise(0).alias('C12')\n",
    "    \n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C12') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C12') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C12') > 0).then(pl.lit('C12')).otherwise(pl.lit(None)).alias('C0012')\n",
    "]).drop(['C12'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 191,
   "id": "acb02b69-4b99-4363-a172-cb45392deb1b",
   "metadata": {},
   "outputs": [],
   "source": [
    "#  C16 4차필터링제어V3\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('SCR_ML0700_000_s') <= 700)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('LC1200103') >= 3)).then(1)\n",
    "    .otherwise(0).alias('C16')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C16') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C16') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C16') > 0).then(pl.lit('C16')).otherwise(pl.lit(None)).alias('C0016')\n",
    "]).drop(['C16'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 192,
   "id": "114f552d-dc95-4dd8-aa2c-4b2d879a11c6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# PFCT 등급 RENAME\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.col('M_arfajdh8').alias('SCR_AIR_FDLQ_A'),\n",
    "    pl.col('M_boruwtqy').alias('SCR_AIR_CSS_A'),\n",
    "    pl.col('M_luviwzaf').alias('SCR_AIR_CSS_B'),\n",
    "    pl.col('M_0exc8ga5').alias('SCR_AIR_FDLQ_B'),\n",
    "    pl.col('M_qm9cmoed').alias('SCR_AIR_REHAB_A'),\n",
    "    pl.col('M_6dx5p0pb').alias('SCR_AIR_REHAB_B'),\n",
    "    pl.col('M_7ijtqual').alias('SCR_AIR_CVIX') \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 193,
   "id": "f91e5014-9818-4302-9c1d-e072a54e1a40",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C25 피플등급_하위제어V3\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl\n",
    "      # row number: 1  \n",
    "     .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00010','00012'])) \n",
    "            & (pl.col('SCR_AIR_CSS_A') > 0) & (pl.col('SCR_AIR_CSS_A') < 670)).then(1)\n",
    "     # row number: 2\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00011','00013'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0) & (pl.col('SCR_AIR_CSS_A') < 597)).then(1)\n",
    "    # row number: 3\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00011'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 582 )).then(1)\n",
    "     # row number: 4     \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00011','00013'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_A') > 0 ) & (pl.col('SCR_AIR_FDLQ_A') < 742 )).then(1)        \n",
    "    # row number: 5    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00011','00013'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 478 )).then(1)\n",
    "    # row number: 6   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00030'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 500 )).then(1)   \n",
    "     # row number: 7  \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00030','00032'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 494 )).then(1)\n",
    "     # row number: 8   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00030'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_B') > 0 ) & (pl.col('SCR_AIR_FDLQ_B') < 477 )).then(1)   \n",
    "    # row number: 9     \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00030'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 505 )).then(1)  \n",
    "    # row number: 10    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00031','00033'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 559 )).then(1)  \n",
    "     # row number: 11    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00031'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 520)).then(1)    \n",
    "    # row number: 12   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00031','00033','00051','00053'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_B') > 0 ) & (pl.col('SCR_AIR_FDLQ_B') < 495 )).then(1)   \n",
    "    # row number: 13\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00031','00033'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 477 )).then(1)    \n",
    "    # row number: 14    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00040'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 497 )).then(1)   \n",
    "    # row number: 15   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00040'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 470 )).then(1)        \n",
    "    # row number: 16   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00040','00042'])) \n",
    "          & (pl.col('SCR_AIR_REHAB_A') > 0 ) & (pl.col('SCR_AIR_REHAB_A') < 546 )).then(1)   \n",
    "    # row number: 17   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00040'])) \n",
    "          & (pl.col('SCR_AIR_REHAB_B') > 0 ) & (pl.col('SCR_AIR_REHAB_B') < 743 )).then(1)        \n",
    "    # row number: 18    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00041','00043'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 518 )).then(1) \n",
    "    # row number: 19       \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00041','00043'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 565 )).then(1)      \n",
    "     # row number: 20   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00041','00043'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_B') > 0 ) & (pl.col('SCR_AIR_FDLQ_B') <  522)).then(1)\n",
    "    # row number: 21        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00041','00043'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 558 )).then(1)   \n",
    "    # row number: 22    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00052'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_A') > 0 ) & (pl.col('SCR_AIR_FDLQ_A') < 692 )).then(1)  \n",
    "    # row number: 23   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00051','00053'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 528 )).then(1)\n",
    "    # row number: 24    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00051','00053'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 539 )).then(1) \n",
    "    # row number: 25    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00012'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_A') > 0 ) & (pl.col('SCR_AIR_FDLQ_A') < 761 )).then(1)\n",
    "    # row number: 26       \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00012'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 642 )).then(1)         \n",
    "    # row number: 27    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00013'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 599 )).then(1)    \n",
    "    # row number: 28    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00032'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 577 )).then(1)     \n",
    "    # row number: 29    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00032'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_B') > 0 ) & (pl.col('SCR_AIR_FDLQ_B') <  575)).then(1)   \n",
    "    # row number: 30        \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00032'])) \n",
    "          & (pl.col('SCR_AIR_CVIX') > 0 ) & (pl.col('SCR_AIR_CVIX') < 571 )).then(1)       \n",
    "    # row number: 31    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00032'])) \n",
    "          & (pl.col('SCR_AIR_REHAB_A') > 0 ) & (pl.col('SCR_AIR_REHAB_A') < 507 )).then(1)      \n",
    "    # row number: 32    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00033','00052'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 584 )).then(1)  \n",
    "    # row number: 33    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00033'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_A') > 0 ) & (pl.col('SCR_AIR_FDLQ_A') < 705 )).then(1)  \n",
    "    # row number: 34   \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00042'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 556 )).then(1) \n",
    "    # row number: 35    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00042'])) \n",
    "          & (pl.col('SCR_AIR_CSS_B') > 0 ) & (pl.col('SCR_AIR_CSS_B') < 534 )).then(1)  \n",
    "    # row number: 36\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00042'])) \n",
    "          & (pl.col('SCR_AIR_FDLQ_A') > 0 ) & (pl.col('SCR_AIR_FDLQ_A') < 768 )).then(1)    \n",
    "    # row number: 37    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00042'])) \n",
    "          & (pl.col('SCR_AIR_REHAB_B') > 0 ) & (pl.col('SCR_AIR_REHAB_B') < 796 )).then(1)   \n",
    "    # row number: 38    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00052'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 606 )).then(1)     \n",
    "    # row number: 39    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00053'])) \n",
    "          & (pl.col('SCR_AIR_CSS_A') > 0 ) & (pl.col('SCR_AIR_CSS_A') < 527 )).then(1)   \n",
    "    # row number: 40    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00051','00052','00053'])) \n",
    "          & (pl.col('GRD_CSS').is_in([9,10]) ) ).then(1) \n",
    "    # row number: 41    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00051','00052','00053'])) \n",
    "          & (pl.col('GRD_FDLQ').is_in([9,10]) ) ).then(1) \n",
    "    # row number: 42    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00051','00052','00053'])) \n",
    "          & (pl.col('GRD_REHAB').is_in([9,10]) ) ).then(1) \n",
    "    # row number: 43    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00051','00052','00053'])) \n",
    "          & (pl.col('GRD_7ijtqual').is_in([8,9,10]))).then(1)         \n",
    "    # row number: 44    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') \n",
    "          & (pl.col('GRD_CSS').is_in([9,10]))).then(1)   \n",
    "    # row number: 45    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') \n",
    "          & (pl.col('GRD_FDLQ').is_in([7,8,9,10]))).then(1)       \n",
    "    # row number: 46    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['2'])) \n",
    "          & (pl.col('GRD_CSS').is_in([8,9,10]))).then(1) \n",
    "    # row number: 47    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['2'])) \n",
    "          & (pl.col('GRD_REHAB').is_in([7,8,9,10]))).then(1) \n",
    "    # row number: 48    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['2'])) \n",
    "          & (pl.col('GRD_FDLQ').is_in([5,6,7,8,9,10]))).then(1)\n",
    "    # row number: 49    \n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('LA0000120') >= 4 ) & (pl.col('GRD_FDLQ').is_in([7,8,9,10])) ).then(1)\n",
    "    .otherwise(0).alias('C25')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C25') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C25') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C25') > 0).then(pl.lit('C25')).otherwise(pl.lit(None)).alias('C0025')\n",
    "]).drop(['C25'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 194,
   "id": "68dac473-1173-4921-ba18-1cc4241cd9cf",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C26 금리인하_확대에따른_추가제어V2\n",
    "df = df.with_columns([    \n",
    "    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00040','00041','00050','00013','00042','00043','00052'])) \n",
    "        & (pl.col('GRD_ML2000_000_SB') >= 8) & (pl.col('S8R201000') >= 6)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00050','00052'])) & (pl.col('GRD_ML2000_000_SB') >= 8) \n",
    "        & (pl.col('S8R201000') < 6) & (pl.col('S92201000') >= 5) ).then(1)\n",
    "    .otherwise(0).alias('C26')\n",
    "    \n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C26') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C26') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C26') > 0).then(pl.lit('C26')).otherwise(pl.lit(None)).alias('C0026')\n",
    "    \n",
    "]).drop(['C26'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 195,
   "id": "eb8ea5a0-f055-4270-bf5e-471edb50d8bf",
   "metadata": {},
   "outputs": [],
   "source": [
    "#C10 다날 항목은 Backscoring 불가로 그 전략만 반영\n",
    "#C11 불가\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SC1201005') <= 600) & (pl.col('SC1202006').is_in([7,8,9,10]))).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL').is_in(['A','E'])) & (pl.col('SC1202006').is_in([7,8,9,10])) & (pl.col('GRD_ML1500_000') >= 9)).then(1)\n",
    "    .otherwise(0).alias('C10')     \n",
    "    \n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C10') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C10') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C10') > 0).then(pl.lit('C10')).otherwise(pl.lit(None)).alias('C0010'),\n",
    "    pl.lit(None).alias('C0011')\n",
    "    \n",
    "]).drop(['C10'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 196,
   "id": "90017d23-cb04-4e3f-aa38-3a35239327e9",
   "metadata": {},
   "outputs": [],
   "source": [
    "#C29 최하CB및SP하위경험제어2\n",
    "\n",
    "df = df.with_columns([    \n",
    "    \n",
    "    (pl.col('SCR_RK0600_000') - pl.col('SC0301005')).alias('T0620') ,\n",
    "\n",
    "    pl.when(pl.col('LC0300210') == 0).then(pl.lit(1))\n",
    "    .when(pl.col('LC0000202') == 0).then(pl.lit(0))\n",
    "    .otherwise(((pl.col('LC0000202')/pl.col('LC0300210')*100).floor())/100).alias('T0621')    \n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') > 800) & (pl.col('T0620') <= -50) ).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') > 700) & (pl.col('SC0301005') <= 800) \n",
    "          & (pl.col('T0620') > 100) & (pl.col('T0621') >= 0.95)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') > 700) & (pl.col('SC0301005') <= 800) \n",
    "          & (pl.col('T0620') <= 100) & (pl.col('T0620') > 50) & (pl.col('GRD_ML1500_000') >= 7)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') <= 700) \n",
    "          & (pl.col('T0620') > 50)  & (pl.col('GRD_ML1500_000') >= 7)).then(1)\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('SC0301005') <= 700) & (pl.col('T0620') > 100) & (pl.col('SPP001000') >= 6)).then(1)\n",
    "    .otherwise(0).alias('C29')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C29') > 0).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision'),\n",
    "    pl.when(pl.col('C29') > 0).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl'),\n",
    "    pl.when(pl.col('C29') > 0).then(pl.lit('C29')).otherwise(pl.lit(None)).alias('C0029')\n",
    "]).drop(['C29'])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 197,
   "id": "86749ef6-eb42-499b-b718-ca8887f76393",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 100_SEG2제휴_오버라이드_급여_V2\n",
    "\n",
    "df = df.with_columns([   \n",
    "    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') &  (pl.col('OCPT1_DSCD_VAL') == 'A')\n",
    "           & (pl.col('RELF_ML_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006','00007'])) \n",
    "           & (pl.col('Decision') == '00020') & ((pl.col('T0400') == '00010') | (pl.col('ASS_DECISION_H') == '00010'))           \n",
    "           ).then(pl.lit(1)).otherwise(pl.col('C99_400')).alias('C99_400')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C99_400') == 1).then(pl.lit('00010')).otherwise(pl.col('Decision')).alias('Decision') ,\n",
    "    pl.when(pl.col('C99_400') == 1).then(pl.lit('00020')).otherwise(pl.col('T0400')).alias('T0400') ,\n",
    "    pl.when(pl.col('C99_400') == 1).then(pl.lit('C99')).otherwise(pl.col('C0099')).alias('C0099')\n",
    "    \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 198,
   "id": "9ef1a5e1-8974-4ef7-8fa9-5fb27700ae54",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 100_SEG2제휴_오버라이드_자영_V2\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') &  (pl.col('OCPT1_DSCD_VAL') == 'B')\n",
    "           & (pl.col('RELF_ML_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006','00007'])) \n",
    "           & (pl.col('Decision') == '00020') \n",
    "           & (((pl.col('T0400') == '00010') & (pl.col('T0561') == '00010')) | ((pl.col('ASS_DECISION_H') == '00010') & (pl.col('T0561')=='00010')))           \n",
    "           ).then(pl.lit(2)).otherwise(pl.col('C99_400')).alias('C99_400')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('C99_400') == 2).then(pl.lit('00010')).otherwise(pl.col('Decision')).alias('Decision') ,\n",
    "    pl.when(pl.col('C99_400') == 2).then(pl.lit('00020')).otherwise(pl.col('T0400')).alias('T0400') ,\n",
    "    pl.when(pl.col('C99_400') == 2).then(pl.lit('C99')).otherwise(pl.col('C0099')).alias('C0099')\n",
    "    \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 199,
   "id": "441ad7b7-0135-429e-b2c7-a6f0145e9478",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 410_필수거절대상\n",
    "\n",
    "df = df.with_columns([    \n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0001') == 'C01')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0002') == 'C02')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0013') == 'C13')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0014') == 'C14')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0015') == 'C15')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0010') == 'C10')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0011') == 'C11')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('C0029') == 'C29')).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('SC0301005') <= 600 )).then(pl.lit(1))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('SC0302006').is_in([7,8,9,10]))).then(pl.lit(1))\n",
    "    .otherwise(pl.lit(0)).alias('RF410')\n",
    "]).with_columns([\n",
    "    pl.when(pl.col('RF410') == 1).then(pl.lit('00020')).otherwise(pl.col('Decision')).alias('Decision') ,\n",
    "   pl.when(pl.col('RF410') == 1).then(pl.lit('00020')).otherwise(pl.col('npWronFltrVl')).alias('npWronFltrVl')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "69a87c74-d203-421a-9a5d-bfcab7efc0cf",
   "metadata": {},
   "source": [
    "### 금리 SEG 변경(US)/금리인하 대상 구분"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 200,
   "id": "a502726b-36de-4631-8b73-1e1677968a5a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF420_금리SEG변경_SEG2 \n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when((~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004','0201001109','0201001109']))) \n",
    "            & (pl.col('OCPT1_DSCD_VAL') != 'E') & (pl.col('IntScrId')=='SEG2')\n",
    "           & (pl.col('AsRtgCdH').is_in(['00001','00002','00003'])) & (pl.col('T0400').is_in(['00010','00020']))).then(pl.lit(1))\n",
    "    .when((~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004','0201001109','0201001109']))) \n",
    "          & (pl.col('OCPT1_DSCD_VAL') != 'E') & (pl.col('IntScrId')=='SEG2')\n",
    "           & (pl.col('AsRtgCdH').is_in(['00004','00005'])) & (pl.col('T0400').is_in(['00010','00020']))).then(pl.lit(2))\n",
    "    .otherwise(pl.lit(0)).alias('RF420')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when(pl.col('RF420').is_in([1,2])).then(pl.lit('SEG5')).otherwise(pl.col('IntScrId')).alias('IntScrId'),\n",
    "\n",
    "    pl.when(pl.col('RF420') == 1).then(pl.lit('00005'))\n",
    "    .when(pl.col('RF420') == 2).then(pl.lit('00006'))\n",
    "    .otherwise(pl.col('AsRtgCdM')).alias('AsRtgCdM'),\n",
    "\n",
    "     pl.when(pl.col('RF420') == 1).then(pl.lit('00005'))\n",
    "    .when(pl.col('RF420') == 2).then(pl.lit('00006'))\n",
    "    .otherwise(pl.col('AsRtgCdH')).alias('AsRtgCdH')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 201,
   "id": "68d4d56c-e286-4364-83d1-6e80e98cb29d",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF430 금리 INTSG\n",
    "# check : ml2000_000 grd 저축인지 tot 인지 확인\n",
    "# NeedsYn_IntSG 초기값 부여\n",
    "\n",
    "df = df.with_columns([\n",
    "    # 초기값 부여\n",
    "    (pl.lit(0)).alias('NeedsYn_IntSG') ,\n",
    "\n",
    "    #APS_SB 10등급 치환\n",
    "    grd_0_to_10('GRD_ML2000_000_SB')    \n",
    "])\n",
    "\n",
    "#SEG4~5 Matrix\n",
    "# IntSG_SEG4_TOSS\n",
    "IntSG_SEG4_TOSS = np.array([\n",
    "    [1, 1, 1, 2, 2, 2, 2, 3, 4, 7, 7],\n",
    "    [2, 1, 2, 2, 2, 2, 2, 3, 4, 7, 7],\n",
    "    [5, 2, 2, 2, 2, 2, 2, 4, 5, 7, 7],\n",
    "    [6, 2, 3, 3, 3, 3, 3, 4, 6, 7, 7],\n",
    "    [6, 3, 3, 3, 3, 3, 3, 5, 6, 7, 7],\n",
    "    [7, 4, 4, 4, 4, 4, 4, 5, 7, 7, 7],\n",
    "    [7, 4, 5, 5, 5, 5, 6, 6, 8, 8, 8],\n",
    "    [8, 5, 5, 5, 5, 5, 6, 7, 8, 8, 8],\n",
    "    [8, 6, 6, 8, 8, 8, 8, 8, 8, 10, 10],\n",
    "    [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]\n",
    "])\n",
    "\n",
    "IntSG_SEG4_TOSS_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG4_TOSS_LOOKUP[(i+1,j)]=int(IntSG_SEG4_TOSS[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1300_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG4_TOSS_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1300_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG4_TOSS')\n",
    "\n",
    "])        \n",
    "\n",
    "\n",
    "# IntSG_SEG4_KAKAOPAY\n",
    "IntSG_SEG4_KAKAOPAY = np.array([\n",
    "    [2,\t1,\t1,\t1,\t1,\t1,\t2,\t3,\t4,\t7,\t7],\n",
    "    [3,\t1,\t1,\t1,\t1,\t1,\t2,\t3,\t4,\t7,\t7],\n",
    "    [4,\t1,\t2,\t2,\t2,\t2,\t2,\t4,\t5,\t7,\t7],\n",
    "    [4,\t2,\t2,\t2,\t2,\t2,\t2,\t4,\t6,\t7,\t7],\n",
    "    [5,\t3,\t3,\t3,\t3,\t3,\t4,\t5,\t6,\t7,\t7],\n",
    "    [5,\t3,\t3,\t4,\t4,\t4,\t4,\t6,\t6,\t7,\t7],\n",
    "    [6,\t4,\t4,\t4,\t5,\t5,\t6,\t7,\t8,\t8,\t8],\n",
    "    [7,\t5,\t5,\t5,\t5,\t6,\t7,\t8,\t8,\t8,\t8],\n",
    "    [8,\t6,\t6,\t8,\t8,\t8,\t8,\t8,\t8,\t8,\t8],\n",
    "    [10, 8,\t8,\t8,\t10,\t10,\t10,\t10,\t10,\t10,\t10]\n",
    "])\n",
    "\n",
    "IntSG_SEG4_KAKAOPAY_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG4_KAKAOPAY_LOOKUP[(i+1,j)]=int(IntSG_SEG4_KAKAOPAY[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1300_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG4_KAKAOPAY_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1300_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG4_KAKAOPAY')\n",
    "])        \n",
    "\n",
    "\n",
    "# IntSG_SEG4_KAKAOBANK\n",
    "IntSG_SEG4_KAKAOBANK = np.array([\n",
    "    [1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t4,\t4],\n",
    "    [2,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t4,\t4],\n",
    "    [3,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t2,\t4,\t4],\n",
    "    [3,\t1,\t1,\t2,\t2,\t2,\t2,\t2,\t2,\t4,\t4],\n",
    "    [4,\t2,\t2,\t2,\t2,\t3,\t3,\t3,\t4,\t4,\t4],\n",
    "    [4,\t3,\t3,\t3,\t3,\t4,\t4,\t4,\t6,\t6,\t6],\n",
    "    [5,\t4,\t4,\t4,\t5,\t5,\t5,\t6,\t6,\t6,\t6],\n",
    "    [6,\t5,\t5,\t5,\t6,\t6,\t6,\t6,\t6,\t6,\t6],\n",
    "    [6,\t6,\t6,\t6,\t6,\t6,\t6,\t6,\t10,\t10,\t10],\n",
    "    [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]\n",
    "])\n",
    "\n",
    "IntSG_SEG4_KAKAOBANK_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG4_KAKAOBANK_LOOKUP[(i+1,j)]=int(IntSG_SEG4_KAKAOBANK[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1300_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG4_KAKAOBANK_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1300_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG4_KAKAOBANK')\n",
    "])  \n",
    "\n",
    "\n",
    "# IntSG_SEG4_ETC\n",
    "IntSG_SEG4_ETC = np.array([\n",
    "    [1,\t1,\t2,\t2,\t2,\t2,\t2,\t3,\t4,\t7,\t7],\n",
    "    [3,\t1,\t2,\t2,\t2,\t2,\t3,\t3,\t4,\t7,\t7],\n",
    "    [5,\t2,\t2,\t2,\t3,\t4,\t4,\t4,\t5,\t7,\t7],\n",
    "    [6,\t3,\t3,\t3,\t3,\t4,\t4,\t4,\t6,\t7,\t7],\n",
    "    [6,\t3,\t3,\t3,\t3,\t4,\t4,\t5,\t6,\t7,\t7],\n",
    "    [6,\t4,\t4,\t4,\t4,\t5,\t5,\t5,\t7,\t7,\t7],\n",
    "    [7,\t4,\t4,\t4,\t5,\t5,\t5,\t6,\t7,\t7,\t7],\n",
    "    [7,\t5,\t5,\t5,\t6,\t6,\t6,\t7,\t7,\t7,\t7],\n",
    "    [7,\t6,\t6,\t6,\t7,\t7,\t7,\t7,\t7,\t7,\t7],\n",
    "    [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]\n",
    "])\n",
    "\n",
    "IntSG_SEG4_ETC_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG4_ETC_LOOKUP[(i+1,j)]=int(IntSG_SEG4_ETC[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1300_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG4_ETC_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1300_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG4_ETC')\n",
    "])  \n",
    "\n",
    "\n",
    "# IntSG_SEG5_TOSS\n",
    "IntSG_SEG5_TOSS = np.array([\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t5],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t2,\t5],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t2,\t2,\t2,\t4,\t10],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t2,\t3,\t4,\t5,\t10],\n",
    "    [10, 2,\t2,\t2,\t3,\t3,\t3,\t3,\t4,\t5,\t10],\n",
    "    [10, 3,\t3,\t3,\t4,\t4,\t4,\t4,\t5,\t6,\t10],\n",
    "    [10, 4,\t4,\t4,\t4,\t5,\t5,\t5,\t6,\t7,\t10],\n",
    "    [10, 5,\t5,\t5,\t5,\t6,\t6,\t7,\t7,\t8,\t10],\n",
    "    [10, 6,\t6,\t6,\t7,\t7,\t7,\t8,\t9,\t10,\t10],\n",
    "    [10, 9,\t9,\t9,\t10,\t10,\t10,\t10,\t10,\t10,\t10]\n",
    "])\n",
    "\n",
    "IntSG_SEG5_TOSS_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG5_TOSS_LOOKUP[(i+1,j)]=int(IntSG_SEG5_TOSS[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1600_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG5_TOSS_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1600_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG5_TOSS')\n",
    "\n",
    "])   \n",
    "\n",
    "\n",
    "# IntSG_SEG5_KAKAOPAY\n",
    "IntSG_SEG5_KAKAOPAY = np.array([\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t4],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t2,\t4],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t2,\t2,\t4,\t4],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t2,\t3,\t3,\t5,\t7],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t3,\t3,\t3,\t5,\t8],\n",
    "    [10, 3,\t3,\t3,\t3,\t4,\t4,\t4,\t5,\t6,\t9],\n",
    "    [10, 4,\t4,\t4,\t4,\t4,\t5,\t5,\t5,\t7,\t10],\n",
    "    [10, 5,\t5,\t5,\t5,\t5,\t5,\t6,\t7,\t8,\t10],\n",
    "    [10, 6,\t6,\t6,\t6,\t6,\t6,\t8,\t8,\t10,\t10],\n",
    "    [10, 8,\t8,\t8,\t9,\t9,\t9,\t10,\t10,\t10,\t10]\n",
    "])\n",
    "\n",
    "IntSG_SEG5_KAKAOPAY_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG5_KAKAOPAY_LOOKUP[(i+1,j)]=int(IntSG_SEG5_KAKAOPAY[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1600_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG5_KAKAOPAY_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1600_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG5_KAKAOPAY')\n",
    "\n",
    "])        \n",
    "\n",
    "\n",
    "# IntSG_SEG5_KAKAOBANK\n",
    "IntSG_SEG5_KAKAOBANK = np.array([\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t3],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t2,\t3],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t2,\t3,\t3,\t4],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t2,\t2,\t3,\t3,\t5],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t3,\t3,\t3,\t4,\t7],\n",
    "    [10, 3,\t3,\t3,\t3,\t3,\t3,\t4,\t4,\t5,\t9],\n",
    "    [10, 4,\t4,\t4,\t4,\t4,\t4,\t5,\t5,\t6,\t10],\n",
    "    [10, 4,\t4,\t4,\t5,\t5,\t5,\t6,\t7,\t8,\t10],\n",
    "    [10, 5,\t5,\t5,\t5,\t5,\t6,\t8,\t8,\t10,\t10],\n",
    "    [10, 8,\t8,\t8,\t8,\t8,\t9,\t9,\t10,\t10,\t10]\n",
    "])\n",
    "\n",
    "IntSG_SEG5_KAKAOBANK_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG5_KAKAOBANK_LOOKUP[(i+1,j)]=int(IntSG_SEG5_KAKAOBANK[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1600_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG5_KAKAOBANK_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1600_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG5_KAKAOBANK')\n",
    "\n",
    "])        \n",
    "\n",
    "\n",
    "# IntSG_SEG5_ETC\n",
    "IntSG_SEG5_ETC = np.array([\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t1,\t5],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t1,\t2,\t3,\t3,\t5],\n",
    "    [10, 1,\t1,\t1,\t1,\t1,\t2,\t2,\t3,\t4,\t5],\n",
    "    [10, 2,\t2,\t2,\t2,\t2,\t2,\t3,\t4,\t5,\t9],\n",
    "    [10, 2,\t2,\t2,\t3,\t3,\t3,\t3,\t4,\t6,\t9],\n",
    "    [10, 3,\t3,\t4,\t4,\t4,\t4,\t4,\t5,\t6,\t9],\n",
    "    [10, 4,\t4,\t4,\t4,\t4,\t5,\t5,\t5,\t7,\t9],\n",
    "    [10, 5,\t5,\t5,\t5,\t5,\t6,\t6,\t7,\t8,\t10],\n",
    "    [10, 6,\t6,\t6,\t6,\t6,\t8,\t8,\t8,\t10,\t10],\n",
    "    [10, 9,\t9,\t9,\t9,\t9,\t9,\t10,\t10,\t10,\t10]\n",
    "])\n",
    "\n",
    "IntSG_SEG5_ETC_LOOKUP={}\n",
    "for i in range(10):\n",
    "    for j in range(11):\n",
    "        IntSG_SEG5_ETC_LOOKUP[(i+1,j)]=int(IntSG_SEG5_ETC[i,j])\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.struct(['R1_GRD_ML2000_000_SB','GRD_ML1600_500'])\n",
    "    .map_elements(\n",
    "        lambda x:IntSG_SEG5_ETC_LOOKUP.get((int(x['R1_GRD_ML2000_000_SB']),int(x['GRD_ML1600_500'])),None), return_dtype=pl.Int64\n",
    "    ).alias('GRD_IntSG_SEG5_ETC')\n",
    "\n",
    "]) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 202,
   "id": "84c9f65f-2ef4-40a4-a7d3-6a9dd2d20532",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') >= 9)).then(pl.lit(5))\n",
    "    .when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') >= 8) & (pl.col('GRD_ML2000_000_SB') <= 8)).then(pl.lit(4))\n",
    "    .when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') >= 6) & (pl.col('GRD_ML2000_000_SB') <= 7)).then(pl.lit(3))\n",
    "    .when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') >= 5) & (pl.col('GRD_ML2000_000_SB') <= 5)).then(pl.lit(2))\n",
    "    .when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') >= 1) & (pl.col('GRD_ML2000_000_SB') <= 4)).then(pl.lit(1))\n",
    "    .when((pl.col('IntScrId') == 'SEG1') & (pl.col('GRD_ML2000_000_SB') <= 0)).then(pl.lit(5))        \n",
    "\n",
    "    .when((pl.col('IntScrId') == 'SEG2') & (pl.col('SCR_ML1000_001_MID') >= 780)).then(pl.lit(1))\n",
    "    .when((pl.col('IntScrId') == 'SEG2') & (pl.col('SCR_ML1000_001_MID') >= 765) & (pl.col('SCR_ML1000_001_MID') <= 779)).then(pl.lit(2))\n",
    "    .when((pl.col('IntScrId') == 'SEG2') & (pl.col('SCR_ML1000_001_MID') >= 740) & (pl.col('SCR_ML1000_001_MID') <= 764)).then(pl.lit(3))    \n",
    "    .when((pl.col('IntScrId') == 'SEG2') & (pl.col('SCR_ML1000_001_MID') >= 720) & (pl.col('SCR_ML1000_001_MID') <= 739)).then(pl.lit(4))    \n",
    "    .when((pl.col('IntScrId') == 'SEG2') & (pl.col('SCR_ML1000_001_MID') >= 0) & (pl.col('SCR_ML1000_001_MID') <= 719)).then(pl.lit(5))    \n",
    "\n",
    "    .when((pl.col('IntScrId') == 'SEG3') & (pl.col('SCR_ML1600_500') >= 820)).then(pl.lit(1))\n",
    "    .when((pl.col('IntScrId') == 'SEG3') & (pl.col('SCR_ML1600_500') >= 780) & (pl.col('SCR_ML1600_500') <= 819)).then(pl.lit(2))\n",
    "    .when((pl.col('IntScrId') == 'SEG3') & (pl.col('SCR_ML1600_500') >= 740) & (pl.col('SCR_ML1600_500') <= 779)).then(pl.lit(3))\n",
    "    .when((pl.col('IntScrId') == 'SEG3') & (pl.col('SCR_ML1600_500') >= 700) & (pl.col('SCR_ML1600_500') <= 739)).then(pl.lit(4))\n",
    "    .when((pl.col('IntScrId') == 'SEG3') & (pl.col('SCR_ML1600_500') >= 0) & (pl.col('SCR_ML1600_500') <= 699)).then(pl.lit(5))        \n",
    "\n",
    "    .when((pl.col('IntScrId') == 'SEG4') & (pl.col('RCV_CHNL_CD_VAL') == '00256')).then(pl.col('GRD_IntSG_SEG4_TOSS'))\n",
    "    .when((pl.col('IntScrId') == 'SEG4') & (pl.col('RCV_CHNL_CD_VAL') == '00292')).then(pl.col('GRD_IntSG_SEG4_KAKAOPAY'))\n",
    "    .when((pl.col('IntScrId') == 'SEG4') & (pl.col('RCV_CHNL_CD_VAL') == '00268')).then(pl.col('GRD_IntSG_SEG4_KAKAOBANK'))\n",
    "    .when((pl.col('IntScrId') == 'SEG4') & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))).then(pl.col('GRD_IntSG_SEG4_ETC'))\n",
    "\n",
    "    .when((pl.col('IntScrId') == 'SEG5') & (pl.col('RCV_CHNL_CD_VAL') == '00256')).then(pl.col('GRD_IntSG_SEG5_TOSS'))\n",
    "    .when((pl.col('IntScrId') == 'SEG5') & (pl.col('RCV_CHNL_CD_VAL') == '00292')).then(pl.col('GRD_IntSG_SEG5_KAKAOPAY'))\n",
    "    .when((pl.col('IntScrId') == 'SEG5') & (pl.col('RCV_CHNL_CD_VAL') == '00268')).then(pl.col('GRD_IntSG_SEG5_KAKAOBANK'))\n",
    "    .when((pl.col('IntScrId') == 'SEG5') & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))).then(pl.col('GRD_IntSG_SEG5_ETC'))\n",
    "    \n",
    "    .otherwise(pl.col('NeedsYn_IntSG')).alias('NeedsYn_IntSG')\n",
    "])\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 203,
   "id": "97f47702-4ccf-4e3a-85e4-bd01f9c8b034",
   "metadata": {},
   "outputs": [],
   "source": [
    "#RF_440 금리인하대상"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 204,
   "id": "89692fc3-7b0d-4508-8f33-e1f70c0386ef",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = df.with_columns([\n",
    "    pl.col('AsRtgCdH').fill_null('0').cast(pl.Int64).alias('AsRtgCdH_INT64')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 205,
   "id": "18132efe-7e51-456c-999f-468a65029b9e",
   "metadata": {},
   "outputs": [],
   "source": [
    "#RF_1100 금리인하대상 SEG4_TOSS\n",
    "\n",
    "Int_down_SEG4_TOSS = np.array([\n",
    "    \n",
    "    [10, 10, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 10, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 20, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 30, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 20, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 20, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG4_TOSS_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG4_TOSS_LOOKUP[(i+1,j+1)] = int(Int_down_SEG4_TOSS[i,j])\n",
    "\n",
    "\n",
    "#RF_1100 금리인하대상 SEG4_KAKAOPAY\n",
    "\n",
    "Int_down_SEG4_KAKAOPAY = np.array([\n",
    "    \n",
    "    [10, 50, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 10, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 10, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [30, 30, 20, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG4_KAKAOPAY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG4_KAKAOPAY_LOOKUP[(i+1,j+1)] = int(Int_down_SEG4_KAKAOPAY[i,j])\n",
    "\n",
    "#RF_1100 금리인하대상 SEG4_KAKAOBANK\n",
    "\n",
    "Int_down_SEG4_KAKAOBANK = np.array([\n",
    "    \n",
    "    [50, 50, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 20, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 20, 20, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [30, 30, 30, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 30, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG4_KAKAOBANK_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG4_KAKAOBANK_LOOKUP[(i+1,j+1)] = int(Int_down_SEG4_KAKAOBANK[i,j])\n",
    "\n",
    "#RF_1100 금리인하대상 SEG4_ETC\n",
    "\n",
    "Int_down_SEG4_ETC = np.array([\n",
    "    \n",
    "    [10, 50, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [10, 50, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [20, 20, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [30, 20, 20, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 20, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG4_ETC_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG4_ETC_LOOKUP[(i+1,j+1)] = int(Int_down_SEG4_ETC[i,j])\n",
    "\n",
    "        \n",
    "#RF_1100 금리인하대상 SEG5_TOSS\n",
    "\n",
    "Int_down_SEG5_TOSS = np.array([\n",
    "    \n",
    "    [20, 10, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [30, 20, 20, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 30, 30, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50] \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG5_TOSS_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG5_TOSS_LOOKUP[(i+1,j+1)] = int(Int_down_SEG5_TOSS[i,j])\n",
    "\n",
    "\n",
    "#RF_1100 금리인하대상 SEG5_KAKAOPAY\n",
    "\n",
    "Int_down_SEG5_KAKAOPAY = np.array([\n",
    "    \n",
    "    [10, 10, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 20, 20, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 30, 20, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50]     \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG5_KAKAOPAY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG5_KAKAOPAY_LOOKUP[(i+1,j+1)] = int(Int_down_SEG5_KAKAOPAY[i,j])\n",
    "\n",
    "#RF_1100 금리인하대상 SEG5_KAKAOBANK\n",
    "\n",
    "Int_down_SEG5_KAKAOBANK = np.array([\n",
    "    \n",
    "    [20, 10, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 20, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG5_KAKAOBANK_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG5_KAKAOBANK_LOOKUP[(i+1,j+1)] = int(Int_down_SEG5_KAKAOBANK[i,j])\n",
    "\n",
    "#RF_1100 금리인하대상 SEG5_ETC\n",
    "\n",
    "Int_down_SEG5_ETC = np.array([\n",
    "    \n",
    "    [20, 20, 50, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [30, 20, 10, 50, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 30, 30, 10, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 30, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 30, 50, 50, 50, 50, 50, 50],\n",
    "    [40, 40, 40, 40, 50, 50, 50, 50, 50, 50]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG5_ETC_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG5_ETC_LOOKUP[(i+1,j+1)] = int(Int_down_SEG5_ETC[i,j])\n",
    "\n",
    "        \n",
    "#RF_1100 금리인하대상 SEG4_TOSS_LADY\n",
    "\n",
    "Int_down_SEG4_TOSS_LADY = np.array([\n",
    "    \n",
    "    [20, 20, 11, 11, 11, 11, 11, 11, 11, 11],\n",
    "    [30, 20, 20, 11, 11, 11, 11, 11, 11, 11],\n",
    "    [30, 30, 20, 21, 21, 21, 21, 21, 21, 21],\n",
    "    [50, 40, 20, 31, 31, 31, 31, 31, 31, 31],\n",
    "    [50, 50, 30, 30, 41, 41, 41, 41, 41, 41],\n",
    "    [50, 50, 40, 40, 41, 41, 41, 41, 41, 41]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG4_TOSS_LADY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG4_TOSS_LADY_LOOKUP[(i+1,j+1)] = int(Int_down_SEG4_TOSS_LADY[i,j])\n",
    "      \n",
    "#RF_1100 금리인하대상 SEG5_TOSS_LADY\n",
    "\n",
    "Int_down_SEG5_TOSS_LADY = np.array([\n",
    "    \n",
    "    [30, 20, 11, 11, 11, 11, 11, 11, 11, 11],\n",
    "    [40, 30, 30, 20, 21, 21, 21, 21, 21, 21],\n",
    "    [50, 40, 40, 20, 31, 31, 31, 31, 31, 31],\n",
    "    [50, 50, 40, 40, 41, 41, 41, 41, 41, 41],\n",
    "    [50, 50, 50, 40, 41, 41, 41, 41, 41, 41],\n",
    "    [50, 50, 50, 50, 41, 41, 41, 41, 41, 41]    \n",
    "\n",
    "])\n",
    "\n",
    "Int_down_SEG5_TOSS_LADY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        Int_down_SEG5_TOSS_LADY_LOOKUP[(i+1,j+1)] = int(Int_down_SEG5_TOSS_LADY[i,j])\n",
    "        \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 206,
   "id": "d6455694-40af-4b51-9b18-05426fce351e",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = df.with_columns([\n",
    "    pl.lit(None).alias('T0360_DVCD')\n",
    "])\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG4_TOSS_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00292') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG4_KAKAOPAY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00268') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG4_KAKAOBANK_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))\n",
    "           & (pl.col('IntScrId') == 'SEG4') & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG4_ETC_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG5_TOSS_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00292') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG5_KAKAOPAY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00268') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG5_KAKAOBANK_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))\n",
    "           & (pl.col('IntScrId') == 'SEG5') & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG5_ETC_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & ((pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG4_TOSS_LADY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & ((pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: Int_down_SEG5_TOSS_LADY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "    .otherwise(pl.col('T0360_DVCD'))    \n",
    "    .map_elements(\n",
    "        lambda x: f'{x:05d}' if x is not None else '00050',return_dtype=pl.Utf8        \n",
    "    ).alias('T0360_DVCD')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 207,
   "id": "e1d2d206-2600-4b7a-a20c-9c7c27a8422f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0410 금리인하대상 추가조건 여부\n",
    "df = df.with_columns([\n",
    "    pl.lit('00020').alias('T0410')\n",
    "]).with_columns([\n",
    "    pl.when((pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001') == 999999999 )).then(pl.lit('00010'))\n",
    "    .when((pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001') <= 1 )).then(pl.lit('00010'))\n",
    "    .when((pl.col('LN_DSCD').is_in(['00001','00002'])) & (pl.col('EW2401001') == 2) \n",
    "          & (pl.col('INCOME_RCGNTN_GRADE_VAL').is_in(['00001','00002','00003','00004','00005','00006']))).then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('T0410')).alias('T0410')\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0272497f-48d4-4a4f-b712-fcc4a75009fb",
   "metadata": {},
   "source": [
    "### 한도상향"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 208,
   "id": "5d957dcd-b4a8-4966-9fb1-09f3b138e638",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF_450 한도상향 대상\n",
    "\n",
    "# 2900_여성OK론 대상자 여부\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('GNDR_DSCD') == '00001')\n",
    "           & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (pl.col('S8RA01000').is_in([1,2,3,4,5])) & (pl.col('SPP001000').is_in([1,2,3,4,5]))\n",
    "           & (pl.col('T0360_DVCD').is_in(['00010','00011','00020','00021','00030','00031','00040','00041']))\n",
    "           & (pl.col('T0410') == '00010')\n",
    "           ).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('GNDR_DSCD') == '00001')\n",
    "           & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (pl.col('S8RA01000').is_in([1,2,3,4,5])) & (pl.col('SPP001000').is_in([1,2,3,4,5,6]))\n",
    "           & (pl.col('T0360_DVCD').is_in(['00010','00011','00020','00021','00030','00031','00040','00041']))\n",
    "           & (pl.col('T0410') == '00010')\n",
    "           ).then(pl.lit('00010'))\n",
    "    .otherwise(pl.lit('00020')).alias('T0470')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 209,
   "id": "6130bcc7-df42-4660-addf-e9361f3eac3e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF 450_한도상향대상\n",
    "\n",
    "# 5300 SEG4/5 채널별 한도상향 대상\n",
    "\n",
    "# seg4_kakaopay\n",
    "AMT_UP_SEG4_KAKAOAPY = np.array([\n",
    "    [10, 30, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG4_KAKAOAPY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG4_KAKAOAPY_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG4_KAKAOAPY[i,j])\n",
    "\n",
    "\n",
    "# seg4_kakaobank\n",
    "AMT_UP_SEG4_KAKAOBANK = np.array([\n",
    "    [30, 30, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG4_KAKAOBANK_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG4_KAKAOBANK_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG4_KAKAOBANK[i,j])\n",
    "\n",
    "\n",
    "# seg4_TOSS\n",
    "AMT_UP_SEG4_TOSS = np.array([\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG4_TOSS_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG4_TOSS_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG4_TOSS[i,j])\n",
    "\n",
    "\n",
    "# seg4_ETC\n",
    "AMT_UP_SEG4_ETC = np.array([\n",
    "    [10, 30, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 30, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG4_ETC_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG4_ETC_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG4_ETC[i,j])\n",
    "\n",
    "\n",
    "# seg5_kakaopay\n",
    "AMT_UP_SEG5_KAKAOAPY = np.array([\n",
    "    \n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [20, 20, 20, 20, 30, 30, 30, 30, 30, 30]\n",
    "    \n",
    "])\n",
    "\n",
    "AMT_UP_SEG5_KAKAOAPY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG5_KAKAOAPY_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG5_KAKAOAPY[i,j])\n",
    "\n",
    "\n",
    "# seg5_kakaobank\n",
    "AMT_UP_SEG5_KAKAOBANK = np.array([\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [20, 20, 20, 20, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG5_KAKAOBANK_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG5_KAKAOBANK_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG5_KAKAOBANK[i,j])\n",
    "\n",
    "\n",
    "# seg5_TOSS\n",
    "AMT_UP_SEG5_TOSS = np.array([\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [20, 20, 20, 20, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG5_TOSS_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG5_TOSS_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG5_TOSS[i,j])\n",
    "\n",
    "\n",
    "# seg5_ETC\n",
    "AMT_UP_SEG5_ETC = np.array([\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [20, 20, 20, 20, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG5_ETC_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG5_ETC_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG5_ETC[i,j])\n",
    "\n",
    "\n",
    "# seg4_TOSS_여성OK론\n",
    "AMT_UP_SEG4_TOSS_LADY = np.array([\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 10, 10, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 30, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 30, 10, 10, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG4_TOSS_LADY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG4_TOSS_LADY_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG4_TOSS_LADY[i,j])\n",
    "    \n",
    "\n",
    "# seg5_TOSS_여성OK론\n",
    "AMT_UP_SEG5_TOSS_LADY = np.array([\n",
    "    [10, 10, 30, 30, 30, 30, 30, 30, 30, 30],\n",
    "    [10, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 10, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 30, 10, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 30, 30, 10, 30, 30, 30, 30, 30, 30],\n",
    "    [30, 30, 30, 30, 30, 30, 30, 30, 30, 30]\n",
    "])\n",
    "\n",
    "AMT_UP_SEG5_TOSS_LADY_LOOKUP={}\n",
    "for i in range(6):\n",
    "    for j in range(10):\n",
    "        AMT_UP_SEG5_TOSS_LADY_LOOKUP[(i+1,j+1)] = int(AMT_UP_SEG5_TOSS_LADY[i,j])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 210,
   "id": "c390810b-6dd8-491c-b280-87003aaef173",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = df.with_columns([\n",
    "    pl.lit(30).alias('T0610')\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG4_TOSS_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00292') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG4_KAKAOAPY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00268') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG4_KAKAOBANK_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))\n",
    "           & (pl.col('IntScrId') == 'SEG4') & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG4_ETC_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG5_TOSS_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00292') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG5_KAKAOAPY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00268') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG5_KAKAOBANK_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (~(pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00292','00268'])))\n",
    "           & (pl.col('IntScrId') == 'SEG5') & (~(pl.col('LN_PD_VAL') == '0201001072')))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG5_ETC_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG4')\n",
    "           & (pl.col('LN_PD_VAL') == '0201001072'))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG4_TOSS_LADY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('RCV_CHNL_CD_VAL') == '00256') & (pl.col('IntScrId') == 'SEG5')\n",
    "           & (pl.col('LN_PD_VAL') == '0201001072'))\n",
    "        .then(pl.struct(['AsRtgCdH_INT64','NeedsYn_IntSG'])\n",
    "        .map_elements(\n",
    "            lambda x: AMT_UP_SEG5_TOSS_LADY_LOOKUP.get((int(x['AsRtgCdH_INT64']),int(x['NeedsYn_IntSG'])),None),\n",
    "            return_dtype=pl.Int64))\n",
    "    .otherwise(pl.col('T0610'))\n",
    "    .map_elements(\n",
    "        lambda x: f'{x:05d}' if x is not None else '00030',return_dtype=pl.Utf8       \n",
    "    )    \n",
    "    .alias('T0610')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 211,
   "id": "c74bd2d3-8f84-4da4-89d9-e1b34d764c0d",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF500 한도전략_상향\n",
    "\n",
    "# 5200_가계부채 관리 강화 대응을 위한 한도상향 중금리 \n",
    "\n",
    "# df = df.with_columns([    \n",
    "#     grd_0_to_10('GRD_ML1000_001_TOT')\n",
    "# ])\n",
    "\n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit('00020').alias('T0570'),\n",
    "    pl.lit(None).alias('L0014')\n",
    "\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('IE0400007') <= 4200) & (pl.col('CF0300910') >= 0) \n",
    "             & (pl.col('CF0300910') <= 60)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('IE0400007') <= 4200) \n",
    "           & (pl.col('SCR_PD2900_000') > 850)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('IE0400007') <= 4200)\n",
    "           & (pl.col('SCR_ML2000_000_M') > 605)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('IE0400007') > 4200) \n",
    "           & (pl.col('LC1200202') < 1000)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG3') & (pl.col('IE0400007') > 4200) & (pl.col('LH0000194') > 70)).then(pl.lit('00010'))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)           \n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('IE0400007') <= 4200) & (pl.col('LA0000902') > 0) \n",
    "           & (pl.col('LA0000902') < 25)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('IE0400007') <= 4200) & (pl.col('SPP001000').is_in([1,2,3]))).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4') & (pl.col('IE0400007') > 4200) & (pl.col('SCR_ML1300_500') > 580)).then(pl.lit('00010'))\n",
    "        \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IE0400007') <= 4200) & (pl.col('SCR_ML1600_000') > 735)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IE0400007') <= 4200) & (pl.col('SCR_ML1300_500') > 580)).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IE0400007') <= 4200) & (pl.col('GRD_ML2000_000_SB').is_in([1,2]) )).then(pl.lit('00010'))\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IE0400007') > 4200) & (pl.col('SCR_ML1600_000') > 725)).then(pl.lit('00010'))    \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') & (pl.col('AGE_VAL') >= 30) & (pl.col('AGE_VAL') < 60)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('IE0400007') > 4200) & (pl.col('SCR_ML2000_000') > 635)).then(pl.lit('00010'))\n",
    "    .otherwise(pl.col('T0570')).alias('T0570')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('FnlLmtAmt') > 0) & (pl.col('Decision') == '00010' ) & (pl.col('npDtirUniLmtAmt') > 0 ) & (pl.col('npWronFltrVl') == '00010')\n",
    "           & (pl.col('LN_DSCD') == '00001') & (pl.col('T0570') == '00010')).then(pl.col('npDtirUniLmtAmt') + 5000000)\n",
    "    .otherwise(pl.col('npDtirUniLmtAmt') ).alias('npDtirUniLmtAmt'),\n",
    "\n",
    "    pl.when( (pl.col('FnlLmtAmt') > 0) & (pl.col('Decision') == '00010' ) & (pl.col('npDtirUniLmtAmt') > 0 ) & (pl.col('npWronFltrVl') == '00010')\n",
    "           & (pl.col('LN_DSCD') == '00001') & (pl.col('T0570') == '00010')).then(pl.lit('L14'))\n",
    "    .otherwise(pl.col('L0014') ).alias('L0014')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('FnlLmtAmt') > 0)  & (pl.col('Decision') == '00010') & (pl.col('LN_DSCD') == '00001') & (pl.col('T0570') == '00010'))\n",
    "        .then(pl.col('FnlLmtAmt') +5000000 )\n",
    "        .otherwise(pl.col('FnlLmtAmt')).alias('FnlLmtAmt'),\n",
    "\n",
    "    pl.when( (pl.col('FnlLmtAmt') > 0)  & (pl.col('Decision') == '00010') & (pl.col('LN_DSCD') == '00001') & (pl.col('T0570') == '00010'))\n",
    "        .then(pl.lit('L14'))\n",
    "        .otherwise(pl.col('L0014') ).alias('L0014')   \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 212,
   "id": "3faee6d2-7a46-4b69-b855-994a4f428a12",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF500 한도전략_상향V1\n",
    "\n",
    "# 여성한도 우대\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.lit(None).alias('L0003')    \n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('GNDR_DSCD') == '00001') \n",
    "             & (pl.col('FnlLmtAmt') >= 3000000) & (pl.col('FnlLmtAmt') < 5000000))\n",
    "    .then(\n",
    "        pl.struct([pl.lit(5000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('GNDR_DSCD') == '00001') \n",
    "           & (pl.col('npDtirUniLmtAmt') >= 3000000) & (pl.col('npDtirUniLmtAmt') < 5000000))\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(5000000).alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('GNDR_DSCD') == '00001') & (pl.col('FnlLmtAmt') >= 1)\n",
    "           & (pl.col('FnlLmtAmt') < 3000000))\n",
    "    .then(\n",
    "        pl.struct([pl.lit(3000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('GNDR_DSCD') == '00001') \n",
    "           & (pl.col('npDtirUniLmtAmt') >= 1) & (pl.col('npDtirUniLmtAmt') < 3000000))\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(3000000).alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.col('L0003').alias('field_2')])\n",
    "    ).alias('L13_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_STRUCT').struct.field('field_1').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_STRUCT').struct.field('field_2').alias('L0003')\n",
    "\n",
    "])   \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 213,
   "id": "3d6734d0-fac2-44e2-8d89-e4bcb0dbadcc",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 네이버 우대\n",
    "\n",
    "\n",
    "# GRD_NF1000_101 범위 제한\n",
    "df = df.with_columns([\n",
    "    grd_0_to_10('GRD_NF1000_101')\n",
    "])\n",
    "\n",
    "# NPAY_UP_S4 매트릭스\n",
    "NPAY_UP_S4 = np.array([\n",
    "    [1, 1, 1, 1, 1, 3, 3, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 1, 3, 3, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 2, 3, 3, 3, 3, 3],\n",
    "    [1, 1, 1, 2, 2, 3, 3, 3, 3, 3],\n",
    "    [1, 1, 1, 2, 2, 3, 3, 3, 3, 3],\n",
    "    [1, 1, 1, 2, 2, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3]\n",
    "])\n",
    "\n",
    "NPAY_UP_S4_LOOKUP = {}\n",
    "for i in range(10):\n",
    "    for j in range(10):\n",
    "        NPAY_UP_S4_LOOKUP[(i+1, j+1)] = int(NPAY_UP_S4[i, j])\n",
    "\n",
    "# NPAY_UP_S5 매트릭스\n",
    "NPAY_UP_S5 = np.array([\n",
    "    [1, 1, 1, 1, 1, 1, 2, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 1, 1, 2, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 1, 1, 2, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 1, 2, 2, 3, 3, 3],\n",
    "    [1, 1, 1, 1, 1, 2, 2, 3, 3, 3],\n",
    "    [2, 2, 2, 2, 2, 2, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n",
    "    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3]\n",
    "])\n",
    "\n",
    "NPAY_UP_S5_LOOKUP = {}\n",
    "for i in range(10):\n",
    "    for j in range(10):\n",
    "        NPAY_UP_S5_LOOKUP[(i+1, j+1)] = int(NPAY_UP_S5[i, j])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 214,
   "id": "0dea09dd-2359-4bd9-bbc3-a4e0e71e0171",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# T0300 계산\n",
    "df = df.with_columns([\n",
    "    grd_0_to_10('GRD_ML1000_001_TOT')\n",
    "]).with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('RCV_CHNL_CD_VAL') == '00336') &\n",
    "        (pl.col('LN_DSCD') == '00001') &\n",
    "        pl.col('LN_PD_VAL').is_in(['0201001037', '0201001038', '0201004013', '0201004014']) &\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        (pl.col('npDtirUniLmtAmt') > 3000000) &\n",
    "        (pl.col('FnlLmtAmt') > 3000000) &\n",
    "        (pl.col('AGE_VAL') >= 30) &\n",
    "        (pl.col('AGE_VAL') < 60) &\n",
    "        (pl.col('STRTG_MTCH6_VAL').str.len_bytes() >= 2)\n",
    "    ).then(\n",
    "        # SEG4\n",
    "        pl.when(pl.col('ASS_DTLS_MDL_ID') == 'SEG4').then(\n",
    "            pl.struct(['R1_GRD_ML1000_001_TOT', 'R1_GRD_NF1000_101'])\n",
    "            .map_elements(\n",
    "                lambda x: NPAY_UP_S4_LOOKUP.get((int(x['R1_GRD_ML1000_001_TOT']), int(x['R1_GRD_NF1000_101'])), 3),\n",
    "                return_dtype=pl.Int64\n",
    "            )\n",
    "            .map_elements(\n",
    "                lambda x: '00010' if x == 1 else ('00020' if x == 2 else '00030'),\n",
    "                return_dtype=pl.Utf8\n",
    "            )\n",
    "        )\n",
    "        # SEG5\n",
    "        .when(pl.col('ASS_DTLS_MDL_ID') == 'SEG5').then(\n",
    "            pl.struct(['R1_GRD_ML1000_001_TOT', 'R1_GRD_NF1000_101'])\n",
    "            .map_elements(\n",
    "                lambda x: NPAY_UP_S5_LOOKUP.get((int(x['R1_GRD_ML1000_001_TOT']), int(x['R1_GRD_NF1000_101'])), 3),\n",
    "                return_dtype=pl.Int64\n",
    "            )\n",
    "            .map_elements(\n",
    "                lambda x: '00010' if x == 1 else ('00020' if x == 2 else '00030'),\n",
    "                return_dtype=pl.Utf8\n",
    "            )\n",
    "        )\n",
    "        .otherwise(pl.lit('00030'))\n",
    "    ).otherwise(pl.lit('00030'))\n",
    "    .alias('T0300')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 215,
   "id": "7a8d9e68-29ad-4b84-b3c2-78f2fe165dd2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 네이버 우대 대상 추가 한도 부여\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (pl.col('npDtirUniLmtAmt') > 0) & (pl.col('npDtirUniLmtAmt') > 3000000) & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5']))\n",
    "    & (pl.col('RCV_CHNL_CD_VAL') == '00336') & (pl.col('LN_PD_VAL').is_in(['0201001037', '0201001038', '0201004013', '0201004014'])) \n",
    "    & ((pl.col('LN_DSCD') == '00001')))\n",
    "    .then(\n",
    "        pl.when(pl.col('T0300') == '00010').then(pl.col('npDtirUniLmtAmt') + 5000000)\n",
    "        .when(pl.col('T0300') == '00020').then(pl.col('npDtirUniLmtAmt') + 3000000)\n",
    "        .otherwise(pl.col('npDtirUniLmtAmt'))        \n",
    "    ).otherwise(pl.col('npDtirUniLmtAmt')).alias('npDtirUniLmtAmt'),\n",
    "\n",
    "    pl.when( (pl.col('FnlLmtAmt') > 3000000 ) & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4', 'SEG5'])) & (pl.col('RCV_CHNL_CD_VAL') == '00336')\n",
    "             & (pl.col('LN_PD_VAL').is_in(['0201001037', '0201001038', '0201004013', '0201004014'])) & (pl.col('LN_DSCD') == '00001')         \n",
    "           )\n",
    "    .then(\n",
    "        pl.when(pl.col('T0300') == '00010').then(pl.col('FnlLmtAmt') + 5000000)\n",
    "        .when(pl.col('T0300') == '00020').then(pl.col('FnlLmtAmt') + 3000000)\n",
    "        .otherwise(pl.col('FnlLmtAmt')))        \n",
    "    .otherwise(pl.col('FnlLmtAmt'))\n",
    "    .alias('FnlLmtAmt')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 216,
   "id": "5d03a081-906d-4e70-b301-7480aab3c762",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 5300_금리인하대상_한도상향_500만/300만 구분 중금리\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(None).alias('L0009'),\n",
    "    pl.lit(None).alias('L0010')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when((pl.col('FnlLmtAmt') > 0 ) & (pl.col('Decision') == '00010') & (pl.col('npDtirUniLmtAmt') > 5000000) \n",
    "           & (pl.col('npWronFltrVl') == '00010' ) & (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') \n",
    "           & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349']))\n",
    "           & (pl.col('T0410') == '00010' ) & (pl.col('NpSprNmLimit') > 5000000) & (pl.col('ASS_DTLS_MDL_ID') == pl.col('IntScrId'))\n",
    "           & ((pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017'])) | ((pl.col('LN_PD_VAL') == '0201001072') & (pl.col('T0470') == '00010' )))\n",
    "           & (pl.col('IntScrId').is_in(['SEG4','SEG5'])) & (pl.col('T0610') == '00010') & (pl.col('npDtirUniLmtAmt') <= 10000000 )\n",
    "           )\n",
    "        .then(\n",
    "            pl.struct([(pl.col('npDtirUniLmtAmt') + 5000000).alias('field_0'),pl.lit('L09').alias('field_1'),pl.col('L0010').alias('field_2')])\n",
    "           )\n",
    "        .when( (pl.col('FnlLmtAmt') > 0 ) & (pl.col('Decision') == '00010') & (pl.col('npDtirUniLmtAmt') > 0) \n",
    "               & (pl.col('npWronFltrVl') == '00010' ) & (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') \n",
    "               & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349']))\n",
    "               & (pl.col('NpSprNmLimit') > 5000000) & (pl.col('ASS_DTLS_MDL_ID') == pl.col('IntScrId'))\n",
    "            & (( (pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017'])) \n",
    "                 & (pl.col('IntScrId').is_in(['SEG4','SEG5'])) & (pl.col('T0610') == '00010') & (pl.col('npDtirUniLmtAmt') > 10000000 )\n",
    "                 &  (pl.col('npDtirUniLmtAmt') <= 20000000 )\n",
    "               )              \n",
    "               |\n",
    "               (\n",
    "                (pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017'])) \n",
    "                   & (pl.col('IntScrId').is_in(['SEG5']))\n",
    "                   & (pl.col('T0610') == '00020') & (pl.col('npDtirUniLmtAmt') > 5000000 )  &  (pl.col('npDtirUniLmtAmt') <= 10000000 )                   \n",
    "               ) \n",
    "               | \n",
    "               (\n",
    "                   (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('IntScrId').is_in(['SEG4','SEG5'])) & (pl.col('T0610') == '00010') \n",
    "                   & (pl.col('T0470') == '00010')\n",
    "                   & (pl.col('npDtirUniLmtAmt') > 10000000) & (pl.col('npDtirUniLmtAmt') <= 20000000)    \n",
    "\n",
    "               ) | \n",
    "               (\n",
    "                   (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('IntScrId').is_in(['SEG5'])) & (pl.col('T0610') == '00020') \n",
    "                   & (pl.col('T0470') == '00010') & (pl.col('npDtirUniLmtAmt') > 5000000)& (pl.col('npDtirUniLmtAmt') <= 10000000)                       \n",
    "               )             \n",
    "              )         \n",
    "        )\n",
    "        .then(\n",
    "            pl.struct([(pl.col('npDtirUniLmtAmt')+3000000).alias('field_0'),pl.col('L0009').alias('field_1'),pl.lit('L10').alias('field_2')])\n",
    "        )\n",
    "        .otherwise\n",
    "            (\n",
    "             pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('L0009').alias('field_1'),pl.col('L0010').alias('field_2')])   \n",
    "            \n",
    "       ).alias('T5300_NP_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('T5300_NP_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('T5300_NP_STRUCT').struct.field('field_1').alias('L0009'),\n",
    "    pl.col('T5300_NP_STRUCT').struct.field('field_2').alias('L0010')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 217,
   "id": "3051aa2c-124d-4676-b0c3-27d0336ea05a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 5300_금리인하대상_한도상향_500만/300만 구분 고금리\n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when(\n",
    "            (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('Decision') == '00010') & (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') \n",
    "            & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349']))\n",
    "            & (pl.col('T0410') == '00010' ) & (pl.col('DtirUniLmtAmt') > 5000000) &  (pl.col('FnlLmtAmt') <= 10000000)\n",
    "            & (pl.col('ASS_DTLS_MDL_ID') == pl.col('IntScrId')) \n",
    "            & (\n",
    "                (pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017']))\n",
    "                |\n",
    "                ((pl.col('LN_PD_VAL') == '0201001072') & (pl.col('T0470') == '00010' ))\n",
    "            )\n",
    "            & (pl.col('IntScrId').is_in(['SEG4','SEG5']))\n",
    "            & (pl.col('T0610') == '00010')\n",
    "           )\n",
    "        .then(\n",
    "            pl.struct([(pl.col('FnlLmtAmt') + 5000000).alias('field_0'),pl.lit('L09').alias('field_1'),pl.col('L0010').alias('field_2')])\n",
    "           )\n",
    "        .when( \n",
    "            (pl.col('Decision') == '00010') & (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'A') \n",
    "            & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349']))\n",
    "            & (pl.col('T0410') == '00010') & (pl.col('DtirUniLmtAmt') > 5000000 ) & (pl.col('ASS_DTLS_MDL_ID') == pl.col('IntScrId'))                \n",
    "            & (\n",
    "               (\n",
    "                     (pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017']))\n",
    "                    & (pl.col('IntScrId').is_in(['SEG4','SEG5'])) & (pl.col('FnlLmtAmt') <= 20000000 ) & (pl.col('T0610') == '00010')\n",
    "                    & (pl.col('FnlLmtAmt') > 10000000 )\n",
    "               )              \n",
    "               |\n",
    "               (\n",
    "                   (pl.col('LN_PD_VAL').is_in(['0201001037','0201004013','0205001005','0205001007','0205001016','0205001017'])) \n",
    "                   & (pl.col('IntScrId').is_in(['SEG5']))  & (pl.col('T0610') == '00020')\n",
    "                   & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('FnlLmtAmt') <= 10000000)                \n",
    "               ) \n",
    "               | \n",
    "               (\n",
    "                  (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('IntScrId').is_in(['SEG4','SEG5']))\n",
    "                   & (pl.col('T0610') == '00010') & (pl.col('FnlLmtAmt') > 10000000 ) & (pl.col('FnlLmtAmt') <= 20000000) \n",
    "                   & (pl.col('T0470') == '00010')    \n",
    "\n",
    "               )\n",
    "                | \n",
    "               (\n",
    "                   (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('IntScrId').is_in(['SEG5'])) & (pl.col('T0610') == '00020') \n",
    "                   & (pl.col('T0470') == '00010')\n",
    "                   & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('FnlLmtAmt') <= 10000000)\n",
    "                   \n",
    "               )             \n",
    "              )         \n",
    "        )\n",
    "        .then(\n",
    "            pl.struct([(pl.col('FnlLmtAmt')+3000000).alias('field_0'),pl.col('L0009').alias('field_1'),pl.lit('L10').alias('field_2')])\n",
    "        )\n",
    "        .otherwise\n",
    "            (\n",
    "             pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0009').alias('field_1'),pl.col('L0010').alias('field_2')])   \n",
    "            \n",
    "       ).alias('T5300_FN_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('T5300_FN_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('T5300_FN_STRUCT').struct.field('field_1').alias('L0009'),\n",
    "    pl.col('T5300_FN_STRUCT').struct.field('field_2').alias('L0010')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c849fa48-cd32-42ec-a3ca-9ba5112466f4",
   "metadata": {},
   "source": [
    "### 한도하향"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 218,
   "id": "ba5890e0-f64e-400d-937e-35302db8a693",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF500_한도상향v3 내집으로 OK론 상향 불가\n",
    "\n",
    "# RF5100_한도전략_하향\n",
    "\n",
    "# 100 자영업자 한도제어\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(None).alias('L0001')\n",
    "]).with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') >= 851)\n",
    "             & (pl.col('FnlLmtAmt') > 50000000))\n",
    "    .then(\n",
    "        pl.struct([pl.lit(50000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L01').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 850) \n",
    "           & (pl.col('SCR_RK0600_000') >= 801) & (pl.col('FnlLmtAmt') > 40000000))\n",
    "    .then(\n",
    "        pl.struct([pl.lit(40000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L01').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 800) \n",
    "           & (pl.col('SCR_RK0600_000') >= 725 ) & (pl.col('FnlLmtAmt') > 30000000 )       \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(30000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L01').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 4\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 724 ) \n",
    "           & (pl.col('FnlLmtAmt') > 20000000)       \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(20000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L01').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 5\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') >= 851)\n",
    "             & (pl.col('npDtirUniLmtAmt') > 50000000))\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(50000000).alias('field_1'),pl.lit('L01').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 6\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 850) \n",
    "           & (pl.col('SCR_RK0600_000') >= 801) & (pl.col('npDtirUniLmtAmt') > 40000000))\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(40000000).alias('field_1'),pl.lit('L01').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 7\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 800) \n",
    "           & (pl.col('SCR_RK0600_000') >= 725 ) & (pl.col('npDtirUniLmtAmt') > 30000000 )       \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(30000000).alias('field_1'),pl.lit('L01').alias('field_2')])     \n",
    "    )\n",
    "    # row_number : 8\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('SCR_RK0600_000') <= 724 ) \n",
    "           & (pl.col('npDtirUniLmtAmt') > 20000000)       \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(20000000).alias('field_1'),pl.lit('L01').alias('field_2')])         \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.col('L0001').alias('field_2')])\n",
    "\n",
    "    ).alias('L01_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L01_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L01_STRUCT').struct.field('field_1').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L01_STRUCT').struct.field('field_2').alias('L0001')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 219,
   "id": "0751d0b6-2410-445e-80ca-7bcaa02e20a4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 200 자영업자 고한도제어\n",
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit(None).alias('L0004')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('FnlLmtAmt') > 30000000 ) \n",
    "             & (~(pl.col('RABAC0001').is_in([1,2])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(30000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L04').alias('field_2')])\n",
    "    )\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('npDtirUniLmtAmt') > 30000000 ) \n",
    "             & (~(pl.col('RABAC0001').is_in([1,2])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(30000000).alias('field_1'),pl.lit('L04').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.col('L0004').alias('field_2')])\n",
    "    )\n",
    "    .alias('L04_STRUCT')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L04_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L04_STRUCT').struct.field('field_1').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L04_STRUCT').struct.field('field_2').alias('L0004')\n",
    "\n",
    "\n",
    "])\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 220,
   "id": "63a5a180-55b8-4061-87b7-d0423ecfc88f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Rule_Flow 510_한도전략-_하향V2\n",
    "# 100_고한도_한도제한\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(None,dtype=pl.Utf8).alias('L0015')\n",
    "]).with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('npDtirUniLmtAmt') > 30000000)  & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('GRD_ML0100_002').is_in([7, 8, 9, 10]))        \n",
    "    ).then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(30000000).alias('field_1'),pl.lit('L15').alias('field_2')])\n",
    "        \n",
    "    )\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('FnlLmtAmt') > 30000000 ) & (pl.col('Decision') == '00010')\n",
    "           & (pl.col('GRD_ML0100_002').is_in([7, 8, 9, 10])) \n",
    "    ).then(\n",
    "        pl.struct([pl.lit(30000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L15').alias('field_2')])        \n",
    "    )\n",
    "\n",
    "    # row_number : 3 \n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('npDtirUniLmtAmt') > 50000000 ) & (pl.col('npWronFltrVl') == '00010') \n",
    "           & (pl.col('GRD_ML0100_002').is_in([1, 2, 3, 4, 5, 6])) & (pl.col('RABAC0001') == 0 )\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.lit(50000000).alias('field_1'),pl.lit('L15').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 4\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('FnlLmtAmt') > 50000000 ) & (pl.col('Decision') == '00010')\n",
    "           & (pl.col('GRD_ML0100_002').is_in([1, 2, 3, 4, 5, 6])) & (pl.col('RABAC0001') == 0 )                    \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(50000000).alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.lit('L15').alias('field_2')])   \n",
    "    )   \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('npDtirUniLmtAmt').alias('field_1'),pl.col('L0015').alias('field_2')])        \n",
    "    ).alias('L15_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L15_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L15_STRUCT').struct.field('field_1').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L15_STRUCT').struct.field('field_2').alias('L0015')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 221,
   "id": "3053a0da-e375-40f7-8551-77ba27e42a70",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 내차 플러스ok 론 감액 pass"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 222,
   "id": "4b8279d6-ebcb-41da-8903-7f8d336316a9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF_600 한도 300미만 제어\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit(None).alias('C0003')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2') & (pl.col('CHNL_DVCD').is_in(['2','3','4','5'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'B'))\n",
    "    .then(\n",
    "        pl.when((pl.col('FnlLmtAmt') >= 1) & (pl.col('FnlLmtAmt') < 3000000))\n",
    "            .then(\n",
    "                pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C03').alias('field_2')])                \n",
    "            )\n",
    "        .when((pl.col('npDtirUniLmtAmt') >= 1) & (pl.col('npDtirUniLmtAmt') < 3000000))\n",
    "            .then(\n",
    "                pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C03').alias('field_2')])                \n",
    "            )\n",
    "        .otherwise(\n",
    "            pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.col('C0003').alias('field_2')])             \n",
    "    ))\n",
    "     .otherwise(\n",
    "         pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.col('C0003').alias('field_2')])  \n",
    "     ).alias('C03_STRUCT')\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.col('C03_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C03_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C03_STRUCT').struct.field('field_2').alias('C0003')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 223,
   "id": "4aafd9c8-7a66-4c35-8daa-3897fa8944e5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 1억 cap\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('npDtirUniLmtAmt') >= 100000000)\n",
    "    .then(\n",
    "            pl.struct([pl.min_horizontal([pl.lit(100000000),pl.col('npDtirUniLmtAmt')]).alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')])\n",
    "        )\n",
    "    .when(pl.col('FnlLmtAmt') > 100000000)\n",
    "    .then(\n",
    "            pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.min_horizontal([pl.lit(100000000),pl.col('FnlLmtAmt')]).alias('field_1')])            \n",
    "    )\n",
    "    .when(pl.col('FnlLmtAmt') < 0 )\n",
    "    .then(\n",
    "            pl.struct([pl.lit(0).alias('field_0'),pl.lit(0).alias('field_1')])\n",
    "            \n",
    "    )\n",
    "     .otherwise(pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')]))                  \n",
    "    .alias('RF_9100_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('RF_9100_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('RF_9100_STRUCT').struct.field('field_1').alias('FnlLmtAmt')\n",
    "    \n",
    "])\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 224,
   "id": "b912b04f-4c58-4cba-abdf-d6648dec4626",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 천만대출 오토플러스 한도제어 pass"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 225,
   "id": "c2b22b89-70b8-480f-8415-71e918cfa8ed",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF DSR BACKSCORING 불가"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 226,
   "id": "e9acc20d-6502-46dc-9d0c-7f67de2acffb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 가 DSR\n",
    "\n",
    "# T0060 생성\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('OCPT1_DSCD_VAL') == 'A') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5'])\n",
    "    ).then(\n",
    "        pl.when(\n",
    "            (pl.max_horizontal([\n",
    "                ((pl.col('LRZ000201') * 1000 / \n",
    "                 pl.max_horizontal([pl.col('IE0400007') * 10000, pl.lit(10000000)]) * 100).cast(pl.Int64)),\n",
    "                pl.lit(0)\n",
    "            ]) <= 20)\n",
    "        ).then(pl.lit('00010'))\n",
    "        .when(\n",
    "            (pl.col('IE0400007') >= 7000) & (pl.col('T0190') <= 1.5)\n",
    "        ).then(pl.lit('00010'))\n",
    "        .otherwise(pl.lit('00020'))\n",
    "    ).otherwise(pl.lit('00020'))\n",
    "    .alias('T0060')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 227,
   "id": "169f1515-40ba-4aed-a8ff-7173c2bf82ec",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('EVDN_INCOME_AMT') <= 0) &\n",
    "        (pl.col('ANL_TOT_AMTOI') <= 0) &\n",
    "        (pl.col('T0060') != '00010') &\n",
    "        pl.col('CHNL_DVCD').is_in(['3', '4', '5'])\n",
    "    ).then(\n",
    "        pl.struct([\n",
    "            pl.max_horizontal([\n",
    "                pl.lit(3000000),\n",
    "                pl.min_horizontal([\n",
    "                    pl.col('npDtirUniLmtAmt'),\n",
    "                    ((((100000 - pl.col('LC0000202')) / 1000)).cast(pl.Int64)) * 1000000\n",
    "                ])\n",
    "            ]).alias('field_0'),\n",
    "            pl.max_horizontal([\n",
    "                pl.lit(3000000),\n",
    "                pl.min_horizontal([\n",
    "                    pl.col('FnlLmtAmt'),\n",
    "                    ((((100000 - pl.col('LC0000202')) / 1000)).cast(pl.Int64)) * 1000000\n",
    "                ])\n",
    "            ]).alias('field_1')\n",
    "        ])\n",
    "    ).otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'), pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    )\n",
    "    .alias('L06_STRUCT')\n",
    "]).with_columns([\n",
    "    pl.col('L06_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L06_STRUCT').struct.field('field_1').alias('FnlLmtAmt')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 228,
   "id": "341a107a-c8f8-43f1-878a-66bfcb82fb8a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 최종한도 처리 (연령 / 주부)\n",
    "# 연령 \n",
    "\n",
    "# ================================\n",
    "# 연령제어 (LMT_AMT_FST_M_ST10, LMT_AMT_FST_H_ST10)\n",
    "# ================================\n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('AGE_VAL') >= 60) & (pl.col('AGE_VAL') < 70)\n",
    "    ).then(\n",
    "        pl.struct([\n",
    "            pl.min_horizontal([pl.lit(10000000), pl.col('npDtirUniLmtAmt')]).alias('field_0'),\n",
    "            pl.min_horizontal([pl.lit(10000000), pl.col('FnlLmtAmt')]).alias('field_1')\n",
    "        ])\n",
    "    )\n",
    "    .when(pl.col('AGE_VAL') >= 70).then(\n",
    "        pl.struct([\n",
    "            pl.min_horizontal([pl.lit(3000000), pl.col('npDtirUniLmtAmt')]).alias('field_0'),\n",
    "            pl.min_horizontal([pl.lit(3000000), pl.col('FnlLmtAmt')]).alias('field_1')\n",
    "        ])\n",
    "    )\n",
    "    .when(\n",
    "        (pl.col('AGE_VAL') < 30) & (pl.col('AGE_VAL') >= 25)\n",
    "    ).then(\n",
    "        pl.struct([\n",
    "            pl.min_horizontal([pl.lit(20000000), pl.col('npDtirUniLmtAmt')]).alias('field_0'),\n",
    "            pl.min_horizontal([pl.lit(20000000), pl.col('FnlLmtAmt')]).alias('field_1')\n",
    "        ])\n",
    "    )\n",
    "    .when(\n",
    "        (pl.col('AGE_VAL') < 25) & (pl.col('AGE_VAL') >= 19)\n",
    "    ).then(\n",
    "        pl.struct([\n",
    "            pl.min_horizontal([pl.lit(3000000), pl.col('npDtirUniLmtAmt')]).alias('field_0'),\n",
    "            pl.min_horizontal([pl.lit(3000000), pl.col('FnlLmtAmt')]).alias('field_1')\n",
    "        ])\n",
    "    )\n",
    "    .when(pl.col('AGE_VAL') < 19).then(\n",
    "        pl.struct([pl.lit(0).alias('field_0'), pl.lit(0).alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'), pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    )\n",
    "    .alias('AGE_CAP_STRUCT'),\n",
    "\n",
    "    pl.when(pl.col('AGE_VAL') < 19)\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1')]))\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1')])        \n",
    "    ).alias('AGE_VAL_UNDER_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "    pl.col('AGE_CAP_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('AGE_CAP_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('AGE_VAL_UNDER_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('AGE_VAL_UNDER_STRUCT').struct.field('field_1').alias('npWronFltrVl')    \n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 229,
   "id": "b23ca9fb-7f79-46cd-bbbd-76b09710bd59",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# 주부/학생 제어 \n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(pl.col('OCPT1_DSCD_VAL') == 'E').then(\n",
    "        pl.struct([\n",
    "            pl.min_horizontal([pl.lit(5000000), pl.col('npDtirUniLmtAmt')]).alias('field_0'),\n",
    "            pl.min_horizontal([pl.lit(5000000), pl.col('FnlLmtAmt')]).alias('field_1')\n",
    "        ])\n",
    "    )\n",
    "    .when(pl.col('OCPT1_DSCD_VAL') == 'C').then(\n",
    "        pl.struct([pl.lit(0).alias('field_0'), pl.lit(0).alias('field_1')])    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'), pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    )\n",
    "    .alias('JOB_CAP_STRUCT'),\n",
    "\n",
    "    pl.when( pl.col('OCPT1_DSCD_VAL') == 'C')\n",
    "        .then(\n",
    "            pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1')]))                   \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1')])\n",
    "    ).alias('JOB_C_STRUCT')\n",
    "\n",
    "\n",
    "]).with_columns([\n",
    "    pl.col('JOB_CAP_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('JOB_CAP_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('JOB_C_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('JOB_C_STRUCT').struct.field('field_1').alias('npWronFltrVl')    \n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 230,
   "id": "319ae1db-e459-4d05-b46d-37486f4a5fab",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 거절자 한도 처리\n",
    "\n",
    "df  = df.with_columns([\n",
    "    pl.when( pl.col('npWronFltrVl') == '00020')\n",
    "    .then(\n",
    "        pl.struct([pl.lit(0).alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')])        \n",
    "    )\n",
    "    .when(pl.col('Decision') == '00020')\n",
    "    .then(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.lit(0).alias('field_1')])\n",
    "    )\n",
    "    .otherwise(pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')]))\n",
    "    .alias('DN_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('DN_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('DN_STRUCT').struct.field('field_1').alias('FnlLmtAmt')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 231,
   "id": "59453c1a-b728-44fd-89b6-e3e3716c8572",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# 중금리 한도보정 \n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.when(\n",
    "        (pl.col('npWronFltrVl') == '00010') & (pl.col('Decision') == '00010')\n",
    "    ).then(\n",
    "        pl.struct([\n",
    "            pl.col('npDtirUniLmtAmt').alias('field_0'),\n",
    "            (pl.when(\n",
    "                pl.col('FnlLmtAmt') > pl.col('npDtirUniLmtAmt')\n",
    "            ).then(pl.col('npDtirUniLmtAmt'))\n",
    "            .otherwise(pl.col('FnlLmtAmt'))).alias('field_1')\n",
    "        ])\n",
    "    ).otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'), pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    )\n",
    "    .alias('NP_UN_CAP')\n",
    "]).with_columns([\n",
    "    pl.col('NP_UN_CAP').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('NP_UN_CAP').struct.field('field_1').alias('FnlLmtAmt')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 232,
   "id": "90b5eee3-e962-47d6-a09a-4d4747012ede",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "# 고금리 대상 고한도 제어 (LMT_AMT_FST_M_ST17, LMT_AMT_FST_H_ST17)\n",
    "\n",
    "# T0150 생성 '00020'\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when((pl.col('LN_DSCD') == '00001') & (pl.col('IntScrId') == 'SEG1' ) & (pl.col('AsRtgCdH').is_in(['00005']))).then(pl.lit('00010'))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('IntScrId') == 'SEG3' ) & (pl.col('AsRtgCdH').is_in(['00004']))).then(pl.lit('00010'))\n",
    "    .when((pl.col('LN_DSCD') == '00001') & (pl.col('IntScrId') == 'SEG5' ) & (pl.col('AsRtgCdH').is_in(['00006']))).then(pl.lit('00010'))\n",
    "    .otherwise(pl.lit('00020')).alias('T0150')\n",
    "\n",
    "]).with_columns([\n",
    "    \n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0150') == '00010') & (pl.col('FnlLmtAmt') > 30000000) \n",
    "             & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) )\n",
    "    .then(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.lit(30000000).alias('field_1'),pl.lit('L05').alias('field_2')])        \n",
    "    )\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0150') == '00010') & (pl.col('npDtirUniLmtAmt') > 30000000) \n",
    "             & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(30000000).alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.lit('L05').alias('field_2')])        \n",
    "    )\n",
    "    .otherwise(pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.lit(None).alias('field_2')]))\n",
    "    .alias('L05_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L05_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L05_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L05_STRUCT').struct.field('field_2').alias('L0005')\n",
    "])\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "eab43526-5a02-40e9-b8ef-df25e52d9622",
   "metadata": {},
   "source": [
    "### US CUT OFF_V2(한도관련)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 233,
   "id": "21aea989-46d2-44b2-839d-ab03b1d8e6be",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 정밀심사 과다 24.12월 전 basckscoring 불가 C0021\n",
    "# 운영 Output 및 T0320 현재 기준 BACKSCORING\n",
    "\n",
    "df = df.with_columns([\n",
    "    \n",
    "    pl.col('STRTG_MTCH4_VAL').str.extract(r\"[ACDBE](.)\",1).cast(pl.Int64).alias('T0320'),\n",
    "    pl.lit(None).alias('C0021')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when(\n",
    "        (pl.col('STRTG_MTCH2_VAL').str.len_bytes() > 0 ) & (pl.col('STRTG_MTCH2_VAL').str.slice(0,1)=='1' )\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C21').alias('field_2')])\n",
    "    )\n",
    "    .when(\n",
    "        (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "        & (pl.col('T0320') >= 3)\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C21').alias('field_2')])\n",
    "    )    \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('Decision').alias('field_0'),pl.col('npWronFltrVl').alias('field_1'),pl.col('C0021').alias('field_2')])\n",
    "        \n",
    "    )\n",
    "    .alias('C21_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C21_STRUCT').struct.field('field_0').alias('Decision'),\n",
    "    pl.col('C21_STRUCT').struct.field('field_1').alias('npWronFltrVl'),\n",
    "    pl.col('C21_STRUCT').struct.field('field_2').alias('C0021')\n",
    "\n",
    "\n",
    "])\n",
    "\n",
    "# S내집으로 OK론 거절 backscoring 불가 C0023\n",
    "\n",
    "df = df.with_columns([    \n",
    "    pl.lit(None).alias('C0023')    \n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 234,
   "id": "448fbcf6-bf7d-41ae-a6fa-701d61f6956e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# c17 \n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "             & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('S8RA01000') >= 9) )\n",
    "        .then(\n",
    "            pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])            \n",
    "        )\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('AGE_VAL') >= 70)\n",
    "         )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00002','00003','00004'])) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('S8RA01000') >= 9)        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 4\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00002','00003','00004'])) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('AGE_VAL') >= 70)        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 5\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('LC0025202') > 5000 )\n",
    "           & (pl.col('PRE_LN_DSR_RATIO') > 50) & (pl.col('CHNL_DVCD') == '2')        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 6\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('LC0025202') > 5000 ) & (pl.col('PRE_LN_DSR_RATIO') > 50) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('CHNL_DVCD') != '2') & (pl.col('RCV_CHNL_CD_VAL')  == '00301')        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])               \n",
    "    )\n",
    "    # row_number : 7\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('OCPT1_DSCD_VAL') == 'E')\n",
    "           & (pl.col('LC0025202') > 5000 ) & (pl.col('PRE_LN_DSR_RATIO') > 50) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "           & (pl.col('CHNL_DVCD') != '2') & (~(pl.col('SI0001000').is_in([1,2,3,4]))) & (pl.col('RCV_CHNL_CD_VAL') != '00301')  \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])  \n",
    "    )\n",
    "    # row_number : 8\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('FnlLmtAmt') > 0)\n",
    "           & (pl.col('FnlLmtAmt') <= 5000000) & (pl.col('T0190') > 1.5) & (pl.col('S8RA01000') == 8 ) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 9\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00013','00020','00041','00043'])) & (pl.col('npDtirUniLmtAmt') > 0 ) \n",
    "           & (pl.col('npDtirUniLmtAmt')  <= 5000000 ) & (pl.col('T0190') > 1.5) & (pl.col('S8RA01000') == 8 ) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))                \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 10\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('LC0025202') > 5000 ) & (pl.col('PRE_LN_DSR_RATIO') > 50)\n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD') == '2')        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 11\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('LC0025202') > 5000 ) & (pl.col('PRE_LN_DSR_RATIO') > 50)\n",
    "            & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD') != '2') \n",
    "           & (pl.col('RCV_CHNL_CD_VAL') == '00301')\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 12\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('OCPT1_DSCD_VAL') == 'E') & (pl.col('LC0025202') > 5000 ) & (pl.col('PRE_LN_DSR_RATIO') > 50)\n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD') != '2') \n",
    "           & (~(pl.col('SI0001000').is_in([1,2,3,4]))) & (pl.col('RCV_CHNL_CD_VAL') != '00301')\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 13\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('FnlLmtAmt') > 0) & (pl.col('FnlLmtAmt') <= 5000000) & (pl.col('T0190')> 1.5 )\n",
    "           & (pl.col('S8RA01000') == 8 ) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])      \n",
    "    )\n",
    "    # row_number : 14\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('npDtirUniLmtAmt') > 0) & (pl.col('npDtirUniLmtAmt') <= 5000000) & (pl.col('T0190')> 1.5 )\n",
    "           & (pl.col('S8RA01000') == 8 ) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))       \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C17').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([ pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])        \n",
    "    ).alias('C17_STRUCT')    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C17_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C17_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C17_STRUCT').struct.field('field_2').alias('C0017')    \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 235,
   "id": "a14ca673-2c93-432a-b7b4-e93eaa12145a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C20 인다이렉트 제어 \n",
    "\n",
    "df = df.with_columns([\n",
    "    # ROW_NUMBER : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL').is_in(['A','B'])) & (pl.col('T0190') > 1.0)  \n",
    "             & (pl.col('L12000001') >= 3) & (pl.col('L00000001') >= 3) & (pl.col('T0530').is_in([ '00020','00031','00033','00051','00053']))\n",
    "             & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    # ROW_NUMBER : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('OCPT2_DSCD_VAL') == 'B08') \n",
    "           & (pl.col('EVDN_INCOME_AMT') > 0) & (pl.col('EVDN_INCOME_AMT') < 30000000) & (pl.col('T0530').is_in(['00020'])) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])        \n",
    "    )\n",
    "    # ROW_NUMBER : 3\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL').is_in(['A','B'])) & (pl.col('FnlLmtAmt') > 0 )\n",
    "           & (pl.col('FnlLmtAmt') <= 5000000 ) & (pl.col('HIRT_LMT_GRADE_VAL').is_in(['00005','00006'])) & (pl.col('T0530').is_in(['00051','00053']))\n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])        \n",
    "    )\n",
    "    # ROW_NUMBER : 4\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL') == 'E') \n",
    "           & (pl.col('T0530').is_in([ '00020','00031','00033','00051','00053'])) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    # ROW_NUMBER : 5\n",
    "    .when((pl.col('LN_DSCD') == '00002') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL').is_in(['A','B'])) & (pl.col('T0190')  > 1.0 )\n",
    "    & (pl.col('L12000001') >= 3 ) & (pl.col('L00000001') >= 3 ) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "   )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    # ROW_NUMBER : 6\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL') == 'B') & (pl.col('OCPT2_DSCD_VAL') == 'B08') \n",
    "           & (pl.col('EVDN_INCOME_AMT') > 0) & (pl.col('EVDN_INCOME_AMT') < 30000000) \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    # ROW_NUMBER : 7\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL').is_in(['A','B'])) & (pl.col('FnlLmtAmt') > 0 )\n",
    "           & (pl.col('FnlLmtAmt') <= 5000000 ) & (pl.col('HIRT_LMT_GRADE_VAL').is_in(['00005','00006'])) & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4','SEG5']))\n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))    \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    # ROW_NUMBER : 8\n",
    "    .when( (pl.col('LN_DSCD') == '00002') & (pl.col('CHNL_DVCD') == '2') & (pl.col('OCPT1_DSCD_VAL') == 'E') \n",
    "           & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))            \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([ pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C20').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])\n",
    "    ).alias('C20_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C20_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C20_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C20_STRUCT').struct.field('field_2').alias('C0020')    \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 236,
   "id": "7f27be65-9bef-4c9f-92e9-6261986d0c53",
   "metadata": {},
   "outputs": [],
   "source": [
    "# c22 : 전버전 금리경쟁등급 하위 제어 \n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "             & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG4','SEG5'])) & (pl.col('SHADOW_GRD').is_in([7]))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C22').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "           & (pl.col('ASS_DTLS_MDL_ID') =='SEG4') & (pl.col('CHNL_DVCD').is_in(['1','2'])) & (pl.col('SHADOW_GRD').is_in([6]))\n",
    "           & (pl.col('S8RA01000') >= 6) & (pl.col('GRD_RK0100_201') >= 6 )        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C22').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "           & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5') & (pl.col('CHNL_DVCD') == '2') & (pl.col('SHADOW_GRD').is_in([5,6]))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C22').alias('field_2')])\n",
    "    )        \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])\n",
    "    )\n",
    "    .alias('C22_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C22_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C22_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C22_STRUCT').struct.field('field_2').alias('C0022')\n",
    "    \n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 237,
   "id": "3992b77e-e54d-4689-b56d-de26f1237e45",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C27 저한도 제어\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00020','00040','00042'])) & (pl.col('Decision') == '00010') \n",
    "             & (pl.col('npWronFltrVl') == '00020') & (pl.col('FnlLmtAmt') > 0 ) & (pl.col('FnlLmtAmt') <= 3000000) & (pl.col('T0190') > 1.0) \n",
    "             & (pl.col('SPP001000') >= 6) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C27').alias('field_2')])\n",
    "    )\n",
    "\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('T0530').is_in(['00020','00040','00042'])) & (pl.col('Decision') == '00010') \n",
    "           & (pl.col('npWronFltrVl') == '00010') & (pl.col('npDtirUniLmtAmt') > 0 ) & (pl.col('npDtirUniLmtAmt') <= 3000000)\n",
    "           & (pl.col('T0190') > 1.0) & (pl.col('SPP001000') >= 6) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C27').alias('field_2')])        \n",
    "    )   \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])\n",
    "    )\n",
    "    .alias('C27_STRUCT')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C27_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C27_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C27_STRUCT').struct.field('field_2').alias('C0027')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 238,
   "id": "7cd1bb09-fd45-46a1-bb03-4bd72fca9baa",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 여성 ok론 제어\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('T0470') == '00010' ) \n",
    "             & (pl.col('EVDN_INCOME_AMT')  == 0) & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 0) & (pl.col('npDtirUniLmtAmt') <= 5000000)\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C89').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 2\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('T0470') == '00010') \n",
    "           & (pl.col('EVDN_INCOME_AMT')  == 0) & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "           & (pl.col('FnlLmtAmt') > 0) & (pl.col('FnlLmtAmt') <= 5000000)\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C89').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('LN_DSCD') == '00001') & (pl.col('LN_PD_VAL') == '0201001072') & (pl.col('T0470') == '00020') \n",
    "    )\n",
    "    .then(\n",
    "         pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C89').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 4\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00002','00003','00004'])) & (pl.col('LN_PD_VAL') == '0201001072')\n",
    "        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C89').alias('field_2')])\n",
    "    )   \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])       \n",
    "    ).alias('LADY_OK_CUT_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "    \n",
    "    pl.col('LADY_OK_CUT_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('LADY_OK_CUT_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('LADY_OK_CUT_STRUCT').struct.field('field_2').alias('C0089')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 239,
   "id": "e864bde8-aec8-47b1-b871-3f58c4b7876b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# C28 연봉 1배 제어 \n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    # row_number : 1\n",
    "    pl.when( (pl.col('CHNL_DVCD').is_in(['3','4','5'])) & (pl.col('IE0400007') > 4200) \n",
    "             & (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) == 0) & (pl.col('EVDN_INCOME_AMT') == 0)\n",
    "             & (pl.col('T0480') < 1000000) & (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004'])))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C28').alias('field_2')])\n",
    "    )\n",
    "    # row_number : 2\n",
    "    .when( (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) > 35000000) &  (pl.col('EVDN_INCOME_AMT') == 0)\n",
    "           & (pl.col('T0500') < 1000000) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C28').alias('field_2')])        \n",
    "    )\n",
    "    # row_number : 3\n",
    "    .when( (pl.col('EVDN_INCOME_AMT')  > 35000000) & (pl.col('T0490') < 1000000)         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit('C28').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1'),pl.lit(None).alias('field_2')])\n",
    "    )\n",
    "    .alias('C28_STRUCT')   \n",
    "\n",
    "]).with_columns([\n",
    "    pl.col('C28_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C28_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C28_STRUCT').struct.field('field_2').alias('C0028')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ab86db1d-fa90-42fe-ac40-dee189be1d00",
   "metadata": {},
   "source": [
    "### 한도상하향 / 기타거절"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 240,
   "id": "437a2c26-fb64-4956-9979-331ecf2a622e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# RF 990 출력정보_2\n",
    "\n",
    "# 승인한도 1억 CAP\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.min_horizontal([pl.lit(100000000),pl.col('npDtirUniLmtAmt')]).alias('npDtirUniLmtAmt'),\n",
    "    pl.min_horizontal([pl.lit(100000000),pl.col('FnlLmtAmt')]).alias('FnlLmtAmt')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 241,
   "id": "48ea6ad7-864a-4323-b504-2f46450ebda5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 비상금 대출 cap\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when(pl.col('LN_PD_VAL').is_in(['0201001075', '0201001076']))\n",
    "    .then(\n",
    "        pl.struct([pl.min_horizontal([pl.lit(5000000),pl.col('npDtirUniLmtAmt')]).alias('field_0')\n",
    "                   ,pl.min_horizontal([pl.lit(5000000),pl.col('FnlLmtAmt')]).alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    ).alias('E_LOAN_CAP')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('E_LOAN_CAP').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('E_LOAN_CAP').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 242,
   "id": "c53aba54-1dbd-45e0-adb2-59e30208e009",
   "metadata": {},
   "outputs": [],
   "source": [
    "# T0400 CAP\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_DSCD') == '00001') & (pl.col('FnlLmtAmt')  >= 30000000 ) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG2')\n",
    "             & (pl.col('T0400').is_in(['00010','00020']))                                                                                    \n",
    "    )\n",
    "    .then(pl.lit(30000000))    \n",
    "    .otherwise(pl.col('FnlLmtAmt'))\n",
    "    .alias('FnlLmtAmt')      \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 243,
   "id": "bcba17e8-5823-4d6f-b6e1-8080a8cb71c6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# l02 다이렉트 보정\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit(None).alias('L0002')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    \n",
    "    pl.when( (pl.col('LN_PD_VAL') != '0201001100') & (pl.col('CHNL_DVCD') == '1') & (pl.col('npDtirUniLmtAmt') >= 1) \n",
    "             & (pl.col('npDtirUniLmtAmt') < 3000000) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit(3000000).alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.lit('L02').alias('field_2')])\n",
    "    )\n",
    "    .when( (pl.col('LN_PD_VAL') != '0201001100') & (pl.col('CHNL_DVCD') == '1') & (pl.col('FnlLmtAmt') >= 1) \n",
    "             & (pl.col('FnlLmtAmt') < 3000000)\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.lit(3000000).alias('field_1'),pl.lit('L02').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0002').alias('field_2')])\n",
    "\n",
    "    ).alias('L02_STRUCT')    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L02_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L02_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L02_STRUCT').struct.field('field_2').alias('L0002')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 244,
   "id": "b42a650c-a3f6-4899-b6ce-db7ee14d3090",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 웰컴 거절\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (pl.col('RCV_CHNL_CD_VAL') == '00331') & (pl.col('ASS_DTLS_MDL_ID').is_in(['SEG1','SEG2','SEG3']))\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0')\n",
    "                   ,pl.lit('00020').alias('field_1')\n",
    "                   ,pl.lit(0).alias('field_2')\n",
    "                   ,pl.lit(0).alias('field_3')\n",
    "                   ,pl.lit('C88').alias('field_4')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0')\n",
    "                   ,pl.col('Decision').alias('field_1')\n",
    "                   ,pl.col('npDtirUniLmtAmt').alias('field_2')\n",
    "                   ,pl.col('FnlLmtAmt').alias('field_3')\n",
    "                   ,pl.lit(None).alias('field_4')])\n",
    "    )\n",
    "    .alias('C88_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('C88_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('C88_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('C88_STRUCT').struct.field('field_2').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('C88_STRUCT').struct.field('field_3').alias('FnlLmtAmt'),\n",
    "    pl.col('C88_STRUCT').struct.field('field_4').alias('C0088')    \n",
    "    \n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 245,
   "id": "c7970e41-5928-44a8-b3ba-b7cad81bcc30",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 111론 1,000,000  cap\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (pl.col('LN_PD_VAL') == '0201001100') ) \n",
    "    .then(\n",
    "        pl.struct([pl.min_horizontal([pl.lit(1000000),pl.col('npDtirUniLmtAmt')]).alias('field_0')\n",
    "                   ,pl.min_horizontal([pl.lit(1000000),pl.col('FnlLmtAmt')]).alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')])\n",
    "    )\n",
    "    .alias('OOO_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('OOO_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('OOO_STRUCT').struct.field('field_1').alias('FnlLmtAmt')\n",
    "\n",
    "])\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 246,
   "id": "e9b51d67-2e21-4466-8a93-b1af93092135",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 거절 처리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when(pl.col('npWronFltrVl') == '00020').then(pl.lit(0)).otherwise(pl.col('npDtirUniLmtAmt')).alias('npDtirUniLmtAmt') ,\n",
    "\n",
    "    pl.when(pl.col('Decision') == '00020')\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00020').alias('field_0'),pl.lit('00020').alias('field_1'),pl.lit(0).alias('field_2'),pl.lit(0).alias('field_3')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npWronFltrVl').alias('field_0'),pl.col('Decision').alias('field_1')\n",
    "                   ,pl.col('npDtirUniLmtAmt').alias('field_2'),pl.col('FnlLmtAmt').alias('field_3')])\n",
    "    ).alias('DESION_STRUCT')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('DESION_STRUCT').struct.field('field_0').alias('npWronFltrVl'),\n",
    "    pl.col('DESION_STRUCT').struct.field('field_1').alias('Decision'),\n",
    "    pl.col('DESION_STRUCT').struct.field('field_2').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('DESION_STRUCT').struct.field('field_3').alias('FnlLmtAmt')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 247,
   "id": "773f7661-6c9b-4ccb-b825-4d716e1190f9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 연봉 1배 한도 하향 반영\n",
    "\n",
    "# 500_연봉내_한도감액_가조회_예외대상_고금리(가조회 / 본조회 구분 EVDN_INCOME_AMT = 0 가조회 )\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.lit(None).alias('L0013')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD').is_in(['3','4','5']))\n",
    "            & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > pl.col('T0481') ) & (pl.col('npWronFltrVl') == '00020') \n",
    "            & (pl.col('EVDN_INCOME_AMT') == 0) & (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) == 0)\n",
    "            & (pl.col('IE0400007') <= 4200 ) \n",
    "           )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0481').alias('field_0'),pl.lit('L13').alias('field_1')])        \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])        \n",
    "    )\n",
    "    .alias('L13_01_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_01_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_01_STRUCT').struct.field('field_1').alias('L0013')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 248,
   "id": "5a76396b-9e32-4844-9d9c-d118c9a96b1a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_가조회_예외대상_중금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD').is_in(['3','4','5']))\n",
    "             & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0 ) & (pl.col('npWronFltrVl') == '00010')\n",
    "             & (pl.col('npDtirUniLmtAmt') > pl.col('T0481') ) & (pl.col('EVDN_INCOME_AMT') == 0) \n",
    "             & (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) == 0) & (pl.col('IE0400007') <= 4200 )\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0481').alias('field_0'),pl.col('T0481').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "    )\n",
    "    .alias('L13_02_STRUCT')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_02_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_02_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_02_STRUCT').struct.field('field_2').alias('L0013')\n",
    "\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 249,
   "id": "029467c2-827d-491f-b845-fc73359eeeb6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_가조회_예외미대상_고금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD').is_in(['3','4','5']))\n",
    "             & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > pl.col('T0480') ) & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('EVDN_INCOME_AMT') == 0) & (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) == 0)\n",
    "             & ( pl.col('IE0400007') > 4200) & (pl.col('T0480')  > 0) & ((pl.col('LN_DSCD').is_in(['00001','00002']))) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0480').alias('field_0'),pl.lit('L13').alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])\n",
    "    )\n",
    "    .alias('L13_03_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_03_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_03_STRUCT').struct.field('field_1').alias('L0013')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 250,
   "id": "61e4f154-f6f9-472d-9455-6438a6e505ca",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_가조회_예외미대상_중금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0201001109','0205001013','0210001001','0211002004']))) & (pl.col('CHNL_DVCD').is_in(['3','4','5']))\n",
    "             & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0 ) & (pl.col('npWronFltrVl') == '00010')\n",
    "             & (pl.col('npDtirUniLmtAmt') > pl.col('T0480')) & (pl.col('EVDN_INCOME_AMT') == 0) \n",
    "             & (((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) == 0) & (pl.col('IE0400007') > 4200 )\n",
    "             & (pl.col('T0480') > 0 ) & ((pl.col('LN_DSCD').is_in(['00001','00002']))) \n",
    "\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0480').alias('field_0'),pl.col('T0480').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "    )\n",
    "    .alias('L13_04_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_04_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_04_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_04_STRUCT').struct.field('field_2').alias('L0013')\n",
    "\n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 251,
   "id": "21c0d4fc-db40-46fb-8adf-bcef5eb10ff2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0_예외대상_고금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') \n",
    "             & (pl.col('FnlLmtAmt') > ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) ) & (pl.col('npWronFltrVl') == '00020')\n",
    "             & (pl.col('EVDN_INCOME_AMT') == 0) & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) <= 35000000 )\n",
    "             & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) > 0)           \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('ANL_TOT_AMTOI').alias('field_0'),pl.lit('L13').alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])\n",
    "        \n",
    "    )\n",
    "    .alias('L13_05_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_05_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_05_STRUCT').struct.field('field_1').alias('L0013'),    \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 252,
   "id": "dc97965c-251e-4c0d-857b-43b52f60b7b3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0_예외대상_중금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0)\n",
    "             & (pl.col('npWronFltrVl') == '00010') & (pl.col('npDtirUniLmtAmt') > ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000))\n",
    "             & (pl.col('EVDN_INCOME_AMT') == 0) & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) <= 35000000 )\n",
    "             & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) > 0) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('ANL_TOT_AMTOI').alias('field_0'),pl.col('ANL_TOT_AMTOI').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "        \n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "    )\n",
    "    .alias('L13_06_STRUCT')\n",
    "           \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_06_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_06_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_06_STRUCT').struct.field('field_2').alias('L0013')                                                          \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 253,
   "id": "7a73c945-5744-4117-9119-f3eb40eae9f0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0_예외미대상_고금리_신규재대\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') \n",
    "             & (pl.col('FnlLmtAmt') > pl.col('T0500')) & (pl.col('npWronFltrVl') == '00020') & (pl.col('EVDN_INCOME_AMT') == 0)\n",
    "             & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) > 35000000 ) & (pl.col('T0500') > 0 )\n",
    "             & ((pl.col('LN_DSCD').is_in(['00001','00002'])))         \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0500').alias('field_0'),pl.lit('L13').alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])\n",
    "\n",
    "    ).alias('L13_07_STRUCT')\n",
    "    \n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_07_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_07_STRUCT').struct.field('field_1').alias('L0013')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 254,
   "id": "194aed42-7a2d-4b47-810e-702a131b9a5c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0_예외미대상_중금리_신규재대\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0)\n",
    "             & (pl.col('npWronFltrVl') == '00010') & (pl.col('npDtirUniLmtAmt') > pl.col('T0500')) & (pl.col('EVDN_INCOME_AMT') == 0)\n",
    "             & ( ((pl.col('ANL_TOT_AMTOI').fill_null(0)/1000000).floor()*1000000) > 35000000 ) & (pl.col('T0500') > 0) \n",
    "             & ((pl.col('LN_DSCD').is_in(['00001','00002']))) \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0500').alias('field_0'),pl.col('T0500').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "    ).alias('L13_08_STRUCT')\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_08_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_08_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_08_STRUCT').struct.field('field_2').alias('L0013')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 255,
   "id": "5e05d195-e63c-4f4a-8a94-7c906ec85a68",
   "metadata": {},
   "outputs": [],
   "source": [
    " # 500_연봉내_한도감액_본조회_증빙0외_예외대상_고금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') \n",
    "             & (pl.col('FnlLmtAmt') > pl.col('EVDN_INCOME_AMT')) & (pl.col('npWronFltrVl') == '00020') & (pl.col('EVDN_INCOME_AMT') <= 35000000 )\n",
    "             & (pl.col('EVDN_INCOME_AMT') > 0)\n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([(((pl.col('EVDN_INCOME_AMT')/1000000).floor())*1000000).alias('field_0'),pl.lit('L13').alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])\n",
    "    ).alias('L13_09_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_09_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_09_STRUCT').struct.field('field_1').alias('L0013')   \n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 256,
   "id": "14fdf73a-9709-435f-8658-e585c5d83cb4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0외_예외대상_중금리\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0)\n",
    "             & (pl.col('npWronFltrVl') == '00010') & (pl.col('npDtirUniLmtAmt') > pl.col('EVDN_INCOME_AMT')) \n",
    "             & (pl.col('EVDN_INCOME_AMT') <= 35000000 ) & (pl.col('EVDN_INCOME_AMT') > 0)             \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([(((pl.col('EVDN_INCOME_AMT')/1000000).floor())*1000000).alias('field_0')\n",
    "                   ,(((pl.col('EVDN_INCOME_AMT')/1000000).floor())*1000000).alias('field_1')\n",
    "                   ,pl.lit('L13').alias('field_2')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "\n",
    "    ).alias('L13_10_STRUCT')    \n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('L13_10_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_10_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_10_STRUCT').struct.field('field_2').alias('L0013')\n",
    "\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 257,
   "id": "43a117bc-bbe3-4428-b12b-2b45324f2fcb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0외_예외미대상_고금리_신규재대\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') \n",
    "             & (pl.col('FnlLmtAmt') > pl.col('T0490')) & (pl.col('npWronFltrVl') == '00020') & (pl.col('EVDN_INCOME_AMT')  > 35000000)\n",
    "             & (pl.col('T0490') > 0) & ((pl.col('LN_DSCD').is_in(['00001','00002'])))        \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0490').alias('field_0'),pl.lit('L13').alias('field_1')])\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('FnlLmtAmt').alias('field_0'),pl.col('L0013').alias('field_1')])\n",
    "\n",
    "    ).alias('L13_11_STRUCT')\n",
    "]).with_columns([\n",
    "    pl.col('L13_11_STRUCT').struct.field('field_0').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_11_STRUCT').struct.field('field_1').alias('L0013')\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 258,
   "id": "c8f39679-89b8-4e55-9076-e565e877ffb9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 500_연봉내_한도감액_본조회_증빙0외_예외미대상_중금리_신규재대\n",
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when( (~(pl.col('LN_PD_VAL').is_in(['0210001001','0211002004']))) & (pl.col('Decision') == '00010') & (pl.col('FnlLmtAmt') > 0)\n",
    "             & (pl.col('npWronFltrVl') == '00010') & (pl.col('npDtirUniLmtAmt') > pl.col('T0490')) & (pl.col('EVDN_INCOME_AMT')  > 35000000)\n",
    "             & ( pl.col('T0490') > 0) & ((pl.col('LN_DSCD').is_in(['00001','00002'])))   \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.col('T0490').alias('field_0'),pl.col('T0490').alias('field_1'),pl.lit('L13').alias('field_2')])\n",
    "\n",
    "    )\n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1'),pl.col('L0013').alias('field_2')])\n",
    "    ).alias('L13_12_STRUCT')\n",
    "]).with_columns([\n",
    "    pl.col('L13_12_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('L13_12_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('L13_12_STRUCT').struct.field('field_2').alias('L0013')\n",
    "]) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 259,
   "id": "30447c4c-29dd-4ee3-abf8-23713e4477d9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# INRT_LON_DVCD \n",
    "\n",
    "df = df.with_columns([\n",
    "    pl.lit(None).alias('InrtLonDvcd'),\n",
    "    pl.lit(None).alias('I0001'),\n",
    "    pl.lit(None).alias('I0002'),\n",
    "    pl.lit(None).alias('I0003'),\n",
    "    pl.lit(None).alias('I0004')\n",
    "]).with_columns([\n",
    "\n",
    "    #row_number : 01_1 \n",
    "    pl.when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00010') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00060').alias('field_0')\n",
    "                   ,pl.lit('I01').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "     #row_number : 01_2\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00010') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00060').alias('field_0')\n",
    "                   ,pl.lit('I01').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "    #row_number : 01_3\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00010') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00060').alias('field_0')\n",
    "                   ,pl.lit('I01').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))\n",
    "            \n",
    "    #row_number : 01_4\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00010') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00060').alias('field_0')\n",
    "                   ,pl.lit('I01').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))\n",
    "\n",
    "            \n",
    "    #row_number : 01_5\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00020') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00070').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.lit('I02').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "     #row_number : 01_6\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00020') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00070').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.lit('I02').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "    #row_number : 01_7\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00020') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00070').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.lit('I02').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))\n",
    "            \n",
    "    #row_number : 01_8\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00020') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00070').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.lit('I02').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))\n",
    "            \n",
    "     #row_number : 01_9\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00030') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00100').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.lit('I03').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "     #row_number : 01_10\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00030') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00100').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.lit('I03').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')])\n",
    "    )\n",
    "    #row_number : 01_11\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00030') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00100').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.lit('I03').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))\n",
    "            \n",
    "    #row_number : 01_12\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00030') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00100').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.lit('I03').alias('field_3')\n",
    "                   ,pl.col('I0004').alias('field_4')]))    \n",
    "            \n",
    "\n",
    "    #row_number : 01_13\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00040') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00110').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.lit('I04').alias('field_4')])\n",
    "    )\n",
    "     #row_number : 01_14\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00020') \n",
    "             & (pl.col('FnlLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00040') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00110').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.lit('I04').alias('field_4')])\n",
    "    )\n",
    "    #row_number : 01_15\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG4')\n",
    "             & (pl.col('IntScrId') == 'SEG4') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00040') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00110').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.lit('I04').alias('field_4')]))\n",
    "            \n",
    "    #row_number : 01_16\n",
    "    .when( (pl.col('LN_DSCD').is_in(['00001','00002'])) & ( pl.col('LN_PD_VAL').is_in(['0201004013','0201001037'])) \n",
    "             & (pl.col('OCPT1_DSCD_VAL') == 'A' ) & (pl.col('CHNL_DVCD').is_in(['3','4','5'])) \n",
    "             & (pl.col('RCV_CHNL_CD_VAL').is_in(['00256','00268','00292','00324','00328','00349'])) & (pl.col('ASS_DTLS_MDL_ID') == 'SEG5')\n",
    "             & (pl.col('IntScrId') == 'SEG5') & (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010') \n",
    "             & (pl.col('npDtirUniLmtAmt') > 5000000 ) & (pl.col('T0360_DVCD') == '00040') & (pl.col('T0410') == '00010') \n",
    "    )\n",
    "    .then(\n",
    "        pl.struct([pl.lit('00110').alias('field_0')\n",
    "                   ,pl.col('I0001').alias('field_1')\n",
    "                   ,pl.col('I0002').alias('field_2')\n",
    "                   ,pl.col('I0003').alias('field_3')\n",
    "                   ,pl.lit('I04').alias('field_4')]))    \n",
    "     .otherwise(\n",
    "         pl.struct([pl.col('InrtLonDvcd').alias('field_0')\n",
    "                    ,pl.col('I0001').alias('field_1')\n",
    "                    ,pl.col('I0002').alias('field_2')\n",
    "                    ,pl.col('I0003').alias('field_3')\n",
    "                    ,pl.col('I0004').alias('field_4')])\n",
    "\n",
    "    ).alias('InrtLonDvcd_STRUCT')\n",
    "]).with_columns([\n",
    "\n",
    "        pl.col('InrtLonDvcd_STRUCT').struct.field('field_0').alias('InrtLonDvcd'),\n",
    "        pl.col('InrtLonDvcd_STRUCT').struct.field('field_1').alias('I0001'),\n",
    "        pl.col('InrtLonDvcd_STRUCT').struct.field('field_2').alias('I0002'),\n",
    "        pl.col('InrtLonDvcd_STRUCT').struct.field('field_3').alias('I0003'),\n",
    "        pl.col('InrtLonDvcd_STRUCT').struct.field('field_4').alias('I0004')\n",
    "\n",
    "    ])\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5c20fda5-1700-44b5-82db-ca54cb2a7c5d",
   "metadata": {},
   "source": [
    "### 분석을 위한 변수 생성"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 260,
   "id": "be72b359-2d77-4adf-9986-777439e9225c",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "df = df.with_columns([\n",
    "\n",
    "    pl.when((pl.col('TPERF0004') > 0 ) | (pl.col('TPERF0006') > 0 ) | (pl.col('TPERFC102') >= 30 ))\n",
    "        .then(pl.lit(1)).otherwise(pl.lit(0)).alias('BAD_6M_30'),\n",
    "\n",
    "    pl.when( pl.col('TPERF0109') >= 30 ).then(pl.lit(1)).otherwise(pl.lit(0)).alias('BAD_3M_30'),\n",
    "\n",
    "    pl.when((pl.col('MIRT_US_LAST_APRVL_DSTNCTN_VAL') == '00010') & (pl.col('HIRT_US_LAST_APRVL_DSTNCTN_VAL') == '00010'))\n",
    "        .then(pl.col('MIRT_US_LAST_LMT_AMT'))    \n",
    "    .otherwise(pl.col('HIRT_US_LAST_LMT_AMT')).alias('OPR_FNL_LMT_AMT'),\n",
    "    \n",
    "    pl.when(pl.col('SBSILA_CNT') > 0 )\n",
    "    .then( pl.when(pl.col('OKSIL_CNT') > 0 ).then(pl.lit(0))\n",
    "           .when(pl.col('BM1_CNT') > 0 ).then(pl.lit(1))\n",
    "           .when(pl.col('BM2_CNT') > 0 ).then(pl.lit(2))\n",
    "           .when(pl.col('BM3_CNT') > 0 ).then(pl.lit(3)).otherwise(4))\n",
    "    .when(pl.col('BASIL_CNT') > 0 ).then(pl.lit(5))\n",
    "    .when(pl.col('CASIL_CNT') > 0 ).then(pl.lit(6))\n",
    "    .when(pl.col('CPSIL_CNT') > 0 ).then(pl.lit(7)).otherwise(pl.lit(9)).alias('OPEN_DVCD'),\n",
    "\n",
    "    pl.when(pl.col('SBSILA_CNT') > 0 )\n",
    "    .then( pl.when(pl.col('OKSIL_CNT') > 0 ).then(pl.col('OKSIL_CNT'))\n",
    "           .when(pl.col('BM1_CNT') > 0 ).then(pl.col('BM1_CNT'))\n",
    "           .when(pl.col('BM2_CNT') > 0 ).then(pl.col('BM2_CNT'))\n",
    "           .when(pl.col('BM3_CNT') > 0 ).then(pl.col('BM3_CNT')).otherwise(pl.col('SBSIL_CNT')))\n",
    "    .when(pl.col('BASIL_CNT') > 0 ).then(pl.col('BASIL_CNT'))\n",
    "    .when(pl.col('CASIL_CNT') > 0 ).then(pl.col('CASIL_CNT'))\n",
    "    .when(pl.col('CPSIL_CNT') > 0 ).then(pl.col('CASIL_CNT')).otherwise(pl.lit(0)).alias('OPEN_SIL_CNT'),    \n",
    "\n",
    "    pl.when(pl.sum_horizontal([pl.col('D03'),pl.col('D04'),pl.col('D05'),pl.col('D06')]) > 0).then(pl.lit(1))\n",
    "    .when(pl.col('AGE_VAL') < 30 ).then(pl.lit(2))\n",
    "    .when(pl.col('AGE_VAL') >= 60 ).then(pl.lit(3)).otherwise(pl.lit(0)).alias('DSR_AGE_DVCD'),\n",
    "\n",
    "    pl.when( (pl.sum_horizontal([pl.col('D03'),pl.col('D04'),pl.col('D05'),pl.col('D06')]) > 0) \n",
    "             & (pl.col('OKSIL_CNT') > 0) & (pl.col('Decision') == '00010') & (pl.col('OPEN_SIL_AMT') > 0))\n",
    "    .then(\n",
    "         pl.struct([ pl.max_horizontal([(pl.min_horizontal([pl.col('npDtirUniLmtAmt'),pl.lit(3000000)])),pl.col('OPEN_SIL_AMT')]).alias('field_0')\n",
    "                    ,pl.max_horizontal([(pl.min_horizontal([pl.col('FnlLmtAmt'),pl.lit(3000000)])),pl.col('OPEN_SIL_AMT')]).alias('field_1')\n",
    "                   ,pl.lit('D001').alias('field_2')]                  \n",
    "                  ) \n",
    "    )        \n",
    "    .otherwise(\n",
    "        pl.struct([pl.col('npDtirUniLmtAmt').alias('field_0'),pl.col('FnlLmtAmt').alias('field_1')\n",
    "                   ,pl.lit(None).alias('field_2') \n",
    "                  ])\n",
    "    ).alias('OK_DSR_STRUCT')   \n",
    "\n",
    "\n",
    "]).with_columns([\n",
    "\n",
    "    pl.col('OK_DSR_STRUCT').struct.field('field_0').alias('npDtirUniLmtAmt'),\n",
    "    pl.col('OK_DSR_STRUCT').struct.field('field_1').alias('FnlLmtAmt'),\n",
    "    pl.col('OK_DSR_STRUCT').struct.field('field_2').alias('D0001'),\n",
    "    pl.when( (pl.col('Decision') == '00010') & (pl.col('npWronFltrVl') == '00010' )).then(pl.col('npDtirUniLmtAmt'))\n",
    "    .otherwise(pl.col('FnlLmtAmt')).alias('fnl_lmt_amt_2'),\n",
    "    pl.when(pl.col('OPEN_SIL_CNT') == 0).then(pl.lit(0))\n",
    "        .otherwise(pl.col('OPEN_SIL_AMT')/pl.col('OPEN_SIL_CNT')).alias('OPEN_SIL_TS')        \n",
    "]).with_columns([\n",
    "\n",
    "    pl.when(pl.col('fnl_lmt_amt_2') >= pl.col('OPEN_SIL_TS')).then(pl.lit(1))\n",
    "    .otherwise(pl.lit(0)).alias('OPEN_SIL_SAT'),\n",
    "   \n",
    "])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 261,
   "id": "6bfcc775-e423-4dd6-be6d-1516b4a0a03f",
   "metadata": {},
   "outputs": [],
   "source": [
    "col_keep=['idx',\n",
    "'POP_GB',\n",
    "'SIN_GB',\n",
    "'AUTO_GB',\n",
    "'RCV_DT',\n",
    "'HNDLNG_BLCKNG_DSTNCTN_VAL',\n",
    "'ASS_DTLS_MDL_ID',\n",
    "'ASS_SCORE',\n",
    "'ASS_GRADE_CD',\n",
    "'ASS_GRADE_VAL',\n",
    "'UNI_GRD_CD',\n",
    "'MDL_APRVL_DSTNCTN_VAL',\n",
    "'MIRT_LMT_GRADE_VAL',\n",
    "'HIRT_LMT_GRADE_VAL',\n",
    "'LAST_YR_INCOME_AMT',\n",
    "'MIRT_LMT_WGVL_VAL',\n",
    "'MIRT_LMT_UPLM_AMT',\n",
    "'HIRT_LMT_WGVL_VAL',\n",
    "'HIRT_LMT_UPLM_AMT',\n",
    "'MIRT_ASS_LAST_LMT_AMT',\n",
    "'HIRT_ASS_LAST_LMT_AMT',\n",
    "'MIRT_US_LAST_LMT_AMT',\n",
    "'HIRT_US_LAST_LMT_AMT',\n",
    "'INRT_DSTNCTN_VAL',\n",
    "'MIRT_GRADE_VAL',\n",
    "'HIRT_GRADE_VAL',\n",
    "'MIRT_LAST_INRT',\n",
    "'HIRT_LAST_INRT',\n",
    "'MIRT_ASS_LAST_APRVL_VAL',\n",
    "'HIRT_ASS_LAST_APRVL_VAL',\n",
    "'MIRT_US_LAST_APRVL_DSTNCTN_VAL',\n",
    "'HIRT_US_LAST_APRVL_DSTNCTN_VAL',\n",
    "'NICE_ESTMT_YR_INCOME_AMT',\n",
    "'EVDN_INCOME_AMT',\n",
    "'ANLZD_PIAMT_RPYMNT_AMT',\n",
    "'STRTG_INRT_BASE_CD',\n",
    "'LN_APLCTN_PD_CD',\n",
    "'LN_TP_DSCD',\n",
    "'SUB_SCORE',\n",
    "'ML_ODR3_SCR',\n",
    "'RELF_ML_SCR',\n",
    "'INCOME_ML_SCORE',\n",
    "'SUB_GRADE_VAL',\n",
    "'ML_ODR3_GRADE_VAL',\n",
    "'RELF_ML_GRADE_VAL',\n",
    "'INCOME_RCGNTN_ML_GRADE_VAL',\n",
    "'HNDLNG_BLCKNG_RJCT_VAL',\n",
    "'FILTER1_DSCD_VAL',\n",
    "'FILTER1_RJCT_VAL',\n",
    "'FILTER21_RJCT_VAL',\n",
    "'CHNL_DVCD',\n",
    "'FILTER_2ND_1_VAL',\n",
    "'FILTER_2ND_2_VAL',\n",
    "'FILTER_2ND_VAL',\n",
    "'FILTER_2ND_1_RJCT_VAL',\n",
    "'FILTER_2ND_2_RJCT_VAL',\n",
    "'FILTER_3RD_VAL',\n",
    "'STRTG_APRVL_YN_VAL',\n",
    "'RELF_APRVL_TRGP',\n",
    "'RLEF_APRVL_YN',\n",
    "'MIRT_LMT_LWLM_AMT',\n",
    "'HIRT_LMT_LWLM_AMT',\n",
    "'LMT_MLTP_PRF_YN',\n",
    "'INCOME_RCGNTN_MLTP',\n",
    "'MIRT_APRVL_LMT',\n",
    "'HIRT_APRVL_LMT',\n",
    "'MIRT_LMT_APRVL_VAL',\n",
    "'HIRT_LMT_APRVL_VAL',\n",
    "'ASS_INRT_ID',\n",
    "'MIRT_SUB_GRD',\n",
    "'HIRT_SUB_GRD',\n",
    "'INRT_PRF_YN_VAL',\n",
    "'STRTG_MTCH1_VAL',\n",
    "'STRTG_MTCH2_VAL',\n",
    "'STRTG_MTCH3_VAL',\n",
    "'STRTG_MTCH4_VAL',\n",
    "'STRTG_MTCH5_VAL',\n",
    "'STRTG_MTCH6_VAL',\n",
    "'LN_DSCD',\n",
    "'AGE_VAL',\n",
    "'GNDR_DSCD',\n",
    "'OCPT1_DSCD_VAL',\n",
    "'OCPT2_DSCD_VAL',\n",
    "'HOUSE_OWN_DSTNCTN_VAL',\n",
    "'LN_PD_VAL',\n",
    "'RCV_CHNL_CD_VAL',\n",
    "'OKSIL_CNT',\n",
    "'OKSIL_AMT',\n",
    "'OKSIL_SAT',\n",
    "'SBSIL_CNT',\n",
    "'SBSIL_AMT',\n",
    "'SBSIL_SAT',\n",
    "'BASIL_CNT',\n",
    "'BASIL_AMT',\n",
    "'BASIL_SAT',\n",
    "'CASIL_CNT',\n",
    "'CASIL_AMT',\n",
    "'CASIL_SAT',\n",
    "'CPSIL_CNT',\n",
    "'CPSIL_AMT',\n",
    "'CPSIL_SAT',\n",
    "'SBSILA_CNT',\n",
    "'SBSILA_AMT',\n",
    "'SBSILA_SAT',\n",
    "'BM1_CNT',\n",
    "'BM1_AMT',\n",
    "'BM1_SAT',\n",
    "'BM2_CNT',\n",
    "'BM2_AMT',\n",
    "'BM2_SAT',\n",
    "'BM3_CNT',\n",
    "'BM3_AMT',\n",
    "'BM3_SAT',\n",
    "'OPEN_SIL_AMT',\n",
    "'OPEN_SIL_CNT',\n",
    "'OPEN_SIL_TS',\n",
    "'OPEN_SIL_SAT',        \n",
    "'ASS_DECISION_M',\n",
    "'ASS_DECISION_H',\n",
    "'LMT_AMT_FST_M_ST00',\n",
    "'LMT_AMT_FST_H_ST00',\n",
    "'NpSprNmLimit',\n",
    "'DtirUniLmtAmt',\n",
    "'npDtirUniLmtAmt',\n",
    "'FnlLmtAmt',\n",
    "'Decision',\n",
    "'npWronFltrVl',\n",
    "'BAD_6M_30',\n",
    "'OPEN_DVCD',\n",
    "'DSR_AGE_DVCD',\n",
    "'OPR_FNL_LMT_AMT',\n",
    "'fnl_lmt_amt_2',\n",
    "'L0013'\n",
    "]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 262,
   "id": "8af37322-e666-4fab-a1f3-93cc078ce3ba",
   "metadata": {},
   "outputs": [],
   "source": [
    "# df.filter(pl.col('RCV_DT').is_in(['202501','202502','202503','202509'])).collect().write_parquet(r'D:\\20_CHiPS_DATA\\0_NICE\\0_Leakage\\2025\\PDR_8TH_251117\\0_Dat\\01_python_dat\\01_PFCT_ADD\\01_Backscoring\\oksb_chips_as_amt_st00_asis.parquet')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 263,
   "id": "830cec71-8921-42f6-80ac-34ab1c18bbd7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# df = df.select(col_keep).collect()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 264,
   "id": "2793c528-462c-4247-990f-c77a056c78ce",
   "metadata": {},
   "outputs": [],
   "source": [
    "# df.filter((pl.col('LN_DSCD') == '00001' ) \n",
    "#                    & (~((pl.col('HIRT_US_LAST_APRVL_DSTNCTN_VAL') == '00020') & (pl.col('OKSIL_CNT') > 0)))                    \n",
    "#                    ).with_columns([\n",
    "#     pl.when( pl.col('RCV_DT') <= '202412').then(pl.lit(9))\n",
    "#     .when( (pl.col('RCV_DT') >= '202501') & (pl.col('RCV_DT') <= '202503') ).then(pl.lit(1))        \n",
    "#     .when((pl.col('RCV_DT') >= '202504') & (pl.col('RCV_DT') <= '202506')).then(pl.lit(2))\n",
    "#     .when((pl.col('RCV_DT') >= '202507') & (pl.col('RCV_DT') <= '202509')).then(pl.lit(3))            \n",
    "#     .otherwise(pl.lit(9)).alias('rcv_qtr'),\n",
    "\n",
    "#     pl.when( pl.col('fnl_lmt_amt_2') > 10000000*3 ).then(pl.lit(1))\n",
    "#     .when( (pl.col('fnl_lmt_amt_2') > 10000000*2 ) &  (pl.col('fnl_lmt_amt_2') <= 10000000*3 )).then(pl.lit(2))\n",
    "#     .when( (pl.col('fnl_lmt_amt_2') > 10000000*1 ) &  (pl.col('fnl_lmt_amt_2') <= 10000000*2 )).then(pl.lit(3))\n",
    "#     .when( (pl.col('fnl_lmt_amt_2') > 10000000*0.5 ) &  (pl.col('fnl_lmt_amt_2') <= 10000000*1 )).then(pl.lit(4))        \n",
    "#     .when( pl.col('fnl_lmt_amt_2') <= 10000000*0.5 ).then(pl.lit(5))        \n",
    "#     .otherwise(pl.lit(9)).alias('fnl_Lmt_dvcd'),    \n",
    "\n",
    "#     pl.when( pl.col('fnl_lmt_amt_2') > 0 ).then(pl.lit(1)).otherwise(pl.lit(0)).alias('as_amt_stnr'),\n",
    "#     pl.when( pl.col('fnl_lmt_amt_2') > 0  ).then(pl.col('fnl_lmt_amt_2')).otherwise(pl.lit(0)).alias('as_amt_trns'),\n",
    "\n",
    "#     pl.when( pl.col('OPEN_DVCD').is_in([1,2,3,4])).then(pl.lit(1)).otherwise(pl.lit(0)).alias('sb_dvcd'),\n",
    "#     pl.when( pl.col('OPEN_DVCD').is_in([0,1,2,3,4])).then(pl.lit(1)).otherwise(pl.lit(0)).alias('sba_dvcd'),\n",
    "#     pl.col('ASS_DTLS_MDL_ID').str.slice(3,1).alias('seg'),\n",
    "#     pl.when( pl.col('fnl_lmt_amt_2') >= pl.col('HIRT_LMT_UPLM_AMT') ).then(pl.lit(1)).otherwise(pl.lit(0)).alias('uplm_amt_dvcd'),\n",
    "    \n",
    "#     pl.when(pl.col('OCPT1_DSCD_VAL') == 'E').then(pl.lit(1))\n",
    "#         .when(pl.col('DSR_AGE_DVCD') > 0 ).then(pl.lit(1))\n",
    "#         .otherwise(pl.lit(0)).alias('amt_down_tgt')    \n",
    "    \n",
    "# ]).group_by(['POP_GB',\n",
    "#              'SIN_GB',\n",
    "#              'OPEN_DVCD',          \n",
    "#              'Decision',\n",
    "#              'RCV_DT',\n",
    "#              'rcv_qtr',\n",
    "#              'OCPT1_DSCD_VAL',\n",
    "#              'L0013',\n",
    "#              'fnl_Lmt_dvcd',\n",
    "#              'seg',             \n",
    "#              'HIRT_LMT_GRADE_VAL',\n",
    "#              'uplm_amt_dvcd',\n",
    "#              'amt_down_tgt']).agg([pl.len().alias('cnt'),\n",
    "#                                    pl.col('OPEN_SIL_AMT').sum().alias('to_amt'),\n",
    "#                                    pl.col('BAD_6M_30').sum().alias('bad_cnt_sum'),\n",
    "#                                    (pl.col('OPEN_SIL_AMT')*pl.col('BAD_6M_30')).sum().alias('bad_amt_sum'),\n",
    "#                                    pl.col('as_amt_trns').sum().alias('as_amt_tr'),\n",
    "#                                    pl.col('as_amt_stnr').sum().alias('as_amt_st'),\n",
    "#                                    pl.col('OPEN_SIL_SAT').sum().alias('sat_sum'),\n",
    "                                   \n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0,1,2,3,4]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_all_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0,1,2,3,4]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('sb_all_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0,1,2,3,4])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.col('fnl_lmt_amt_2')).otherwise(pl.lit(0)).sum().alias('sb_all_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0,1,2,3,4])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_all_amt_stnr'),\n",
    "                                   \n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('ok_all_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('ok_all_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.col('fnl_lmt_amt_2')).otherwise(pl.lit(0)).sum().alias('ok_all_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('ok_all_amt_stnr'),\n",
    "\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('sb_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([1,2,3,4])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.col('fnl_lmt_amt_2')).otherwise(pl.lit(0)).sum().alias('sb_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([1,2,3,4])) & (pl.col('fnl_lmt_amt_2') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_amt_stnr'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.col('OPEN_SIL_SAT')).otherwise(pl.lit(0)).sum().alias('sb_sat_sum')\n",
    "                                   \n",
    "#                    ]).write_csv(r'D:\\OUTF\\DT02.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 265,
   "id": "71879da2-3c6e-4da9-a8b0-d35506906aad",
   "metadata": {},
   "outputs": [],
   "source": [
    "# df.filter((pl.col('LN_DSCD') == '00001' ) \n",
    "#                    & (~((pl.col('HIRT_US_LAST_APRVL_DSTNCTN_VAL') == '00020') & (pl.col('OKSIL_CNT') > 0)))\n",
    "#                    # & (pl.col('RCV_DT').is_in(['202505','202506','202507','202508','202509']))\n",
    "#                    ).with_columns([\n",
    "#     pl.when( pl.col('RCV_DT') <= '202412').then(pl.lit(9))\n",
    "#     .when( (pl.col('RCV_DT') >= '202501') & (pl.col('RCV_DT') <= '202503') ).then(pl.lit(1))        \n",
    "#     .when((pl.col('RCV_DT') >= '202504') & (pl.col('RCV_DT') <= '202506')).then(pl.lit(2))\n",
    "#     .when((pl.col('RCV_DT') >= '202507') & (pl.col('RCV_DT') <= '202509')).then(pl.lit(3))            \n",
    "#     .otherwise(pl.lit(9)).alias('rcv_qtr'),\n",
    "\n",
    "#     pl.when( pl.col('OPR_FNL_LMT_AMT') > 10000000*3 ).then(pl.lit(1))\n",
    "#     .when( (pl.col('OPR_FNL_LMT_AMT') > 10000000*2 ) &  (pl.col('OPR_FNL_LMT_AMT') <= 10000000*3 )).then(pl.lit(2))\n",
    "#     .when( (pl.col('OPR_FNL_LMT_AMT') > 10000000*1 ) &  (pl.col('OPR_FNL_LMT_AMT') <= 10000000*2 )).then(pl.lit(3))\n",
    "#     .when( (pl.col('OPR_FNL_LMT_AMT') > 10000000*0.5 ) &  (pl.col('OPR_FNL_LMT_AMT') <= 10000000*1 )).then(pl.lit(4))        \n",
    "#     .when( pl.col('OPR_FNL_LMT_AMT') <= 10000000*0.5 ).then(pl.lit(5))        \n",
    "#     .otherwise(pl.lit(9)).alias('fnl_Lmt_dvcd'),    \n",
    "\n",
    "#     pl.when( pl.col('OPR_FNL_LMT_AMT') > 0 ).then(pl.lit(1)).otherwise(pl.lit(0)).alias('as_amt_stnr'),\n",
    "#     pl.when( pl.col('OPR_FNL_LMT_AMT') > 0  ).then(pl.col('OPR_FNL_LMT_AMT')).otherwise(pl.lit(0)).alias('as_amt_trns'),\n",
    "\n",
    "#     pl.when( pl.col('OPEN_DVCD').is_in([1,2,3,4])).then(pl.lit(1)).otherwise(pl.lit(0)).alias('sb_dvcd'),\n",
    "#     pl.when( pl.col('OPEN_DVCD').is_in([0,1,2,3,4])).then(pl.lit(1)).otherwise(pl.lit(0)).alias('sba_dvcd'),\n",
    "#     pl.col('ASS_DTLS_MDL_ID').str.slice(3,1).alias('seg'),\n",
    "#     pl.when( pl.col('OPR_FNL_LMT_AMT') >= pl.col('HIRT_LMT_UPLM_AMT') ).then(pl.lit(1)).otherwise(pl.lit(0)).alias('uplm_amt_dvcd'),\n",
    "    \n",
    "#     pl.when(pl.col('OCPT1_DSCD_VAL') == 'E').then(pl.lit(1))\n",
    "#         .when(pl.col('DSR_AGE_DVCD') > 0 ).then(pl.lit(1))\n",
    "#         .otherwise(pl.lit(0)).alias('amt_down_tgt'),\n",
    "\n",
    "#     pl.when(pl.col('OPR_FNL_LMT_AMT') >= pl.col('OPEN_SIL_TS')).then(pl.lit(1)).otherwise(pl.lit(0)).alias('OPSN_SIL_SAT_ASIS'),\n",
    "\n",
    "#     pl.when( pl.col('STRTG_MTCH4_VAL').str.slice(18,1) == '1').then(pl.lit(1)).otherwise(pl.lit(0)).alias('L13')\n",
    "    \n",
    "# ]).group_by(['POP_GB',\n",
    "#              'SIN_GB',\n",
    "#              'OPEN_DVCD',          \n",
    "#              'HIRT_US_LAST_APRVL_DSTNCTN_VAL',\n",
    "#              'RCV_DT',\n",
    "#              'rcv_qtr',\n",
    "#              'OCPT1_DSCD_VAL',\n",
    "#              'L13',\n",
    "#              'fnl_Lmt_dvcd',\n",
    "#              'seg',             \n",
    "#              'HIRT_LMT_GRADE_VAL',\n",
    "#              'uplm_amt_dvcd',\n",
    "#              'amt_down_tgt']).agg([pl.len().alias('cnt'),\n",
    "#                                    pl.col('OPEN_SIL_AMT').sum().alias('to_amt'),\n",
    "#                                    pl.col('BAD_6M_30').sum().alias('bad_cnt_sum'),\n",
    "#                                    (pl.col('OPEN_SIL_AMT')*pl.col('BAD_6M_30')).sum().alias('bad_amt_sum'),\n",
    "#                                    pl.col('as_amt_trns').sum().alias('as_amt_tr'),\n",
    "#                                    pl.col('as_amt_stnr').sum().alias('as_amt_st'),\n",
    "#                                    pl.col('OPEN_SIL_SAT').sum().alias('sat_sum'),\n",
    "                                   \n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0,1,2,3,4]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_all_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0,1,2,3,4]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('sb_all_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0,1,2,3,4])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.col('OPR_FNL_LMT_AMT')).otherwise(pl.lit(0)).sum().alias('sb_all_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0,1,2,3,4])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_all_amt_stnr'),\n",
    "                                   \n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('ok_all_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([0]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('ok_all_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.col('OPR_FNL_LMT_AMT')).otherwise(pl.lit(0)).sum().alias('ok_all_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([0])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('ok_all_amt_stnr'),\n",
    "\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_cnt'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.col('BAD_6M_30')).otherwise(pl.lit(0)).sum().alias('sb_bad_sum'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([1,2,3,4])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.col('OPR_FNL_LMT_AMT')).otherwise(pl.lit(0)).sum().alias('sb_amt_trns'),\n",
    "#                                    pl.when( (pl.col('OPEN_DVCD').is_in([1,2,3,4])) & (pl.col('OPR_FNL_LMT_AMT') > 0) )\n",
    "#                                        .then(pl.lit(1)).otherwise(pl.lit(0)).sum().alias('sb_amt_stnr'),\n",
    "#                                    pl.when(pl.col('OPEN_DVCD').is_in([1,2,3,4]))\n",
    "#                                        .then(pl.col('OPSN_SIL_SAT_ASIS')).otherwise(pl.lit(0)).sum().alias('sb_sat_sum')                                  \n",
    "                                   \n",
    "#                    ]).write_csv(r'D:\\OUTF\\DT01.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 266,
   "id": "223c29c2-2c43-4b3c-a76f-047f400a7de4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# dt_ag3['RCV_DT'].value_counts()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 267,
   "id": "8e04cfee-e576-4816-bde3-c4604a2abe00",
   "metadata": {},
   "outputs": [],
   "source": [
    "# dt_ag2.write_csv(r'D:\\OUTF\\dt01.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 268,
   "id": "e6bbda58-1003-42f4-a48f-dd904ebc83f3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# col_n = pl.DataFrame({\"col_n\":df.columns})\n",
    "\n",
    "# col_n.write_csv(r'D:\\OUTF\\COL_NAME.csv')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
